{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 100, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/achra/proyectos/app-hotel-nueva/src/app/api/upload/route.ts"],"sourcesContent":["// src/app/api/upload/route.ts\r\n\r\nimport { NextRequest, NextResponse } from \"next/server\"\r\nimport { v2 as cloudinary } from \"cloudinary\"\r\nimport { createClient } from \"@supabase/supabase-js\"\r\nimport { Buffer } from \"buffer\"\r\nimport crypto from \"crypto\"\r\nimport sharp from \"sharp\"\r\n\r\n// ==================== ENV ====================\r\nif (!process.env.CLOUDINARY_CLOUD_NAME) throw new Error(\"CLOUDINARY_CLOUD_NAME missing\")\r\nif (!process.env.CLOUDINARY_API_KEY) throw new Error(\"CLOUDINARY_API_KEY missing\")\r\nif (!process.env.CLOUDINARY_API_SECRET) throw new Error(\"CLOUDINARY_API_SECRET missing\")\r\nif (!process.env.AI_BACKEND_URL) throw new Error(\"AI_BACKEND_URL missing\")\r\n\r\ncloudinary.config({\r\n  cloud_name: process.env.CLOUDINARY_CLOUD_NAME,\r\n  api_key: process.env.CLOUDINARY_API_KEY,\r\n  api_secret: process.env.CLOUDINARY_API_SECRET,\r\n})\r\n\r\n// ==================== SUPABASE ====================\r\nconst supabase = createClient(\r\n  process.env.NEXT_PUBLIC_SUPABASE_URL!,\r\n  process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!\r\n)\r\n\r\n// ==================== IMAGE SIZES ====================\r\nconst IMAGE_SIZES = {\r\n  thumbnail: { width: 256, height: 144 },\r\n  small: { width: 800, height: 450 },\r\n  medium: { width: 1920, height: 1080 },\r\n  large: { width: 2880, height: 1620 },\r\n}\r\n\r\n// ==================== POST ====================\r\nexport async function POST(request: NextRequest) {\r\n  const requestId = crypto.randomUUID().slice(0, 8)\r\n  console.log(`üöÄ [${requestId}] Upload iniciado`)\r\n\r\n  try {\r\n    const formData = await request.formData()\r\n    const file = formData.get(\"file\") as File | null\r\n    const hotelId = formData.get(\"hotel_id\") as string | null\r\n\r\n    if (!file || !(file instanceof File)) {\r\n      return NextResponse.json({ error: \"Archivo inv√°lido\" }, { status: 400 })\r\n    }\r\n\r\n    if (!hotelId) {\r\n      return NextResponse.json({ error: \"Falta hotel_id\" }, { status: 400 })\r\n    }\r\n\r\n    const buffer = Buffer.from(await file.arrayBuffer())\r\n    const hash = crypto.createHash(\"sha256\").update(buffer).digest(\"hex\")\r\n\r\n    // ==================== DUPLICADOS ====================\r\n    const { data: existing } = await supabase\r\n      .from(\"media\")\r\n      .select(\"id, url\")\r\n      .eq(\"hash\", hash)\r\n      .single()\r\n\r\n    if (existing) {\r\n      console.log(`‚ôªÔ∏è [${requestId}] Imagen duplicada`)\r\n      return NextResponse.json({\r\n        is_duplicate: true,\r\n        url: existing.url,\r\n        photo_id: existing.id,\r\n      })\r\n    }\r\n\r\n    // ==================== CLOUDINARY ====================\r\n    console.log(`‚òÅÔ∏è [${requestId}] Subiendo a Cloudinary`)\r\n    const uploadResult = await new Promise<any>((resolve, reject) => {\r\n      cloudinary.uploader\r\n        .upload_stream(\r\n          { folder: \"hotel-media\", resource_type: \"image\" },\r\n          (error, result) => (error ? reject(error) : resolve(result))\r\n        )\r\n        .end(buffer)\r\n    })\r\n\r\n    // ==================== BACKEND IA ====================\r\n    console.log(`ü§ñ [${requestId}] Llamando backend IA`)\r\n    const aiResponse = await fetch(`${process.env.AI_BACKEND_URL}/analyze`, {\r\n      method: \"POST\",\r\n      body: (() => {\r\n        const fd = new FormData()\r\n        fd.append(\"url\", uploadResult.secure_url)\r\n        return fd\r\n      })(),\r\n    })\r\n\r\n    if (!aiResponse.ok) {\r\n      throw new Error(\"Error en backend IA\")\r\n    }\r\n\r\n    const ai = await aiResponse.json()\r\n\r\n    // ==================== VERSIONES ====================\r\n    const versions: Record<string, any> = {}\r\n\r\n    for (const [size, cfg] of Object.entries(IMAGE_SIZES)) {\r\n      const resized = await sharp(buffer)\r\n        .resize(cfg.width, cfg.height, { fit: \"inside\", withoutEnlargement: true })\r\n        .jpeg({ quality: size === \"thumbnail\" ? 70 : 85 })\r\n        .toBuffer()\r\n\r\n      const v = await new Promise<any>((resolve, reject) => {\r\n        cloudinary.uploader\r\n          .upload_stream(\r\n            {\r\n              folder: \"hotel-media/versions\",\r\n              public_id: `${size}-${hash.slice(0, 16)}`,\r\n            },\r\n            (err, res) => (err ? reject(err) : resolve(res))\r\n          )\r\n          .end(resized)\r\n      })\r\n\r\n      versions[size] = { url: v.secure_url }\r\n    }\r\n\r\n    // ==================== SUPABASE ====================\r\n    const { data, error } = await supabase\r\n      .from(\"media\")\r\n      .insert([\r\n        {\r\n          hotel_id: hotelId,\r\n          url: uploadResult.secure_url,\r\n          hash,\r\n          category: ai.category,\r\n          ai_category: ai.category,\r\n          ai_title: ai.title,\r\n          tags: ai.tags || [],\r\n          versions,\r\n        },\r\n      ])\r\n      .select()\r\n\r\n    if (error) throw error\r\n\r\n    console.log(`‚úÖ [${requestId}] Upload completo`)\r\n\r\n    return NextResponse.json({\r\n      photo_id: data[0].id,\r\n      url: uploadResult.secure_url,\r\n      category: ai.category,\r\n      tags: ai.tags,\r\n      ai_title: ai.title,\r\n      versions,\r\n    })\r\n\r\n  } catch (err: any) {\r\n    console.error(`‚ùå [${requestId}] Error`, err.message)\r\n    return NextResponse.json({ error: \"Error interno\" }, { status: 500 })\r\n  }\r\n}\r\n"],"names":[],"mappings":"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"}}]
}