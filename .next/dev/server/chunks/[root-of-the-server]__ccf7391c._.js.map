{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 100, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/achra/proyectos/app-hotel-nueva/src/lib/ai.ts"],"sourcesContent":["// lib/ai.ts\r\nexport async function analyzeImage(url: string, threshold: number = 0.25) {\r\n  try {\r\n    const response = await fetch('http://localhost:8000/analyze', {\r\n      method: 'POST',\r\n      headers: {\r\n        'Content-Type': 'application/json',\r\n      },\r\n      body: JSON.stringify({ url, threshold }),\r\n    });\r\n\r\n    if (!response.ok) {\r\n      throw new Error(`Error en an√°lisis: ${response.status}`);\r\n    }\r\n\r\n    const data = await response.json();\r\n    return data;\r\n  } catch (error) {\r\n    console.error('‚ùå Error al analizar imagen:', error);\r\n    throw error;\r\n  }\r\n}"],"names":[],"mappings":"AAAA,YAAY;;;;;AACL,eAAe,aAAa,GAAW,EAAE,YAAoB,IAAI;IACtE,IAAI;QACF,MAAM,WAAW,MAAM,MAAM,iCAAiC;YAC5D,QAAQ;YACR,SAAS;gBACP,gBAAgB;YAClB;YACA,MAAM,KAAK,SAAS,CAAC;gBAAE;gBAAK;YAAU;QACxC;QAEA,IAAI,CAAC,SAAS,EAAE,EAAE;YAChB,MAAM,IAAI,MAAM,CAAC,mBAAmB,EAAE,SAAS,MAAM,EAAE;QACzD;QAEA,MAAM,OAAO,MAAM,SAAS,IAAI;QAChC,OAAO;IACT,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,+BAA+B;QAC7C,MAAM;IACR;AACF"}},
    {"offset": {"line": 131, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/achra/proyectos/app-hotel-nueva/src/utils/categoryMap.ts"],"sourcesContent":["export const CATEGORY_MAP: Record<string, string[]> = {\r\n  exterior: [\"exterior\", \"garden\", \"parking\", \"view\", \"balcony\", \"terrace\", \"facade\"],\r\n  habitaciones: [\"hotel room\", \"suite\", \"family room\", \"double room\", \"single room\", \"king bed\", \"queen bed\", \"bedroom\"],\r\n  interior: [\"corridor\", \"hallway\", \"interior\"],\r\n  salas_comunes: [\"lobby\", \"reception\", \"hall\", \"common area\"],\r\n  restaurante: [\"restaurant\", \"breakfast area\", \"bar\"],\r\n  piscina: [\"swimming pool\", \"pool\"],\r\n  spa: [\"spa\", \"gym\"],\r\n};\r\n\r\nexport function detectCategory(tags: string[]): string {\r\n  const lower = tags.map(t => t.toLowerCase());\r\n\r\n  for (const [category, keywords] of Object.entries(CATEGORY_MAP)) {\r\n    if (keywords.some(k => lower.includes(k))) {\r\n      return category;\r\n    }\r\n  }\r\n\r\n  return \"otros\";\r\n}\r\n"],"names":[],"mappings":";;;;;;AAAO,MAAM,eAAyC;IACpD,UAAU;QAAC;QAAY;QAAU;QAAW;QAAQ;QAAW;QAAW;KAAS;IACnF,cAAc;QAAC;QAAc;QAAS;QAAe;QAAe;QAAe;QAAY;QAAa;KAAU;IACtH,UAAU;QAAC;QAAY;QAAW;KAAW;IAC7C,eAAe;QAAC;QAAS;QAAa;QAAQ;KAAc;IAC5D,aAAa;QAAC;QAAc;QAAkB;KAAM;IACpD,SAAS;QAAC;QAAiB;KAAO;IAClC,KAAK;QAAC;QAAO;KAAM;AACrB;AAEO,SAAS,eAAe,IAAc;IAC3C,MAAM,QAAQ,KAAK,GAAG,CAAC,CAAA,IAAK,EAAE,WAAW;IAEzC,KAAK,MAAM,CAAC,UAAU,SAAS,IAAI,OAAO,OAAO,CAAC,cAAe;QAC/D,IAAI,SAAS,IAAI,CAAC,CAAA,IAAK,MAAM,QAAQ,CAAC,KAAK;YACzC,OAAO;QACT;IACF;IAEA,OAAO;AACT"}},
    {"offset": {"line": 195, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/achra/proyectos/app-hotel-nueva/src/app/api/upload/route.ts"],"sourcesContent":["// src/app/api/upload/route.ts\r\nimport { NextRequest, NextResponse } from 'next/server';\r\nimport { v2 as cloudinary } from 'cloudinary';\r\nimport { createClient } from '@supabase/supabase-js';\r\nimport { Buffer } from 'buffer';\r\nimport crypto from 'crypto';\r\nimport { analyzeImage } from '@/lib/ai';\r\nimport { detectCategory } from '@/utils/categoryMap';\r\n\r\n// Validaci√≥n de variables\r\nif (!process.env.CLOUDINARY_CLOUD_NAME) throw new Error('‚ùå CLOUDINARY_CLOUD_NAME no est√° definido');\r\nif (!process.env.CLOUDINARY_API_KEY) throw new Error('‚ùå CLOUDINARY_API_KEY no est√° definido');\r\nif (!process.env.CLOUDINARY_API_SECRET) throw new Error('‚ùå CLOUDINARY_API_SECRET no est√° definido');\r\n\r\ncloudinary.config({\r\n  cloud_name: process.env.CLOUDINARY_CLOUD_NAME,\r\n  api_key: process.env.CLOUDINARY_API_KEY,\r\n  api_secret: process.env.CLOUDINARY_API_SECRET,\r\n});\r\n\r\n// Cliente Supabase\r\nconst supabase = createClient(\r\n  process.env.NEXT_PUBLIC_SUPABASE_URL!,\r\n  process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!\r\n);\r\nexport async function POST(request: NextRequest) {\r\n  console.log('üöÄ POST /api/upload iniciado');\r\n\r\n  try {\r\n    const formData = await request.formData();\r\n    const file = formData.get('file') as File | null;\r\n    const hotelId = formData.get('hotel_id') as string | null;\r\n\r\n    console.log('üì• Datos recibidos:', {\r\n      hasFile: !!file,\r\n      hasHotelId: !!hotelId,\r\n      fileType: file?.type,\r\n      fileSize: file?.size\r\n    });\r\n\r\n    if (!file || !(file instanceof File)) {\r\n      return NextResponse.json({ error: 'Archivo inv√°lido' }, { status: 400 });\r\n    }\r\n\r\n    if (!hotelId) {\r\n      return NextResponse.json({ error: 'Falta hotel_id' }, { status: 400 });\r\n    }\r\n\r\n    if (file.size > 5 * 1024 * 1024) {\r\n      return NextResponse.json({ error: 'Archivo demasiado grande (m√°x. 5MB)' }, { status: 400 });\r\n    }\r\n\r\n    // Convertir a buffer\r\n    const arrayBuffer = await file.arrayBuffer();\r\n    const buffer = Buffer.from(arrayBuffer);\r\n    // Hash √∫nico\r\n    const hash = crypto.createHash('sha256').update(buffer).digest('hex');\r\n    console.log('üîë Hash generado:', hash.substring(0, 16));\r\n\r\n    // Buscar duplicado\r\n    const { data: existing, error: checkError } = await supabase\r\n      .from('image_hashes')\r\n      .select('url, type, quality_score')\r\n      .eq('hash', hash)\r\n      .single();\r\n\r\n    if (checkError && checkError.code !== 'PGRST116') {\r\n      console.error('‚ùå Error verificando hash:', checkError);\r\n      return NextResponse.json({ error: 'Error verificando duplicados' }, { status: 500 });\r\n    }\r\n\r\n    // Si es duplicado ‚Üí analizar igualmente para obtener tags y categor√≠a\r\n    if (existing) {\r\n      console.log('‚ö†Ô∏è Imagen duplicada detectada');\r\n\r\n      const analysis = await analyzeImage(existing.url);\r\n      const tagsArray = analysis.tags.map((t: any) => t.tag);\r\n      const category = detectCategory(tagsArray);\r\n\r\n      return NextResponse.json({\r\n        url: existing.url,\r\n        type: existing.type,\r\n        quality_score: existing.quality_score || 0.8,\r\n        is_duplicate: true,\r\n        tags: analysis.tags,\r\n        category,\r\n        message: 'Esta imagen ya existe en tu galer√≠a'\r\n      });\r\n    }\r\n    console.log('üì§ Subiendo a Cloudinary...');\r\n\r\n    const uploadResult = await new Promise<any>((resolve, reject) => {\r\n      cloudinary.uploader.upload_stream(\r\n        {\r\n          folder: 'hotel-media',\r\n          resource_type: 'auto',\r\n          invalidate: true,\r\n          quality_analysis: true,\r\n        },\r\n        (error, result) => {\r\n          if (error) reject(error);\r\n          else resolve(result);\r\n        }\r\n      ).end(buffer);\r\n    });\r\n\r\n    console.log('‚úÖ Subida exitosa:', uploadResult.secure_url);\r\n    console.log('üß† Analizando imagen con ExSabri IA...');\r\n    const analysis = await analyzeImage(uploadResult.secure_url);\r\n\r\n    const tagsArray = analysis.tags.map((t: any) => t.tag);\r\n    const category = detectCategory(tagsArray);\r\n\r\n    console.log('üè∑Ô∏è Tags:', tagsArray);\r\n    console.log('üìÇ Categor√≠a detectada:', category);\r\n    const qualityScore = uploadResult.quality_analysis?.focus || 0.8;\r\n\r\n    const { error: insertHashError } = await supabase\r\n      .from('image_hashes')\r\n      .insert({\r\n        hash,\r\n        url: uploadResult.secure_url,\r\n        type: uploadResult.resource_type,\r\n        quality_score: qualityScore\r\n      });\r\n\r\n    if (insertHashError) {\r\n      console.error('‚ùå Error guardando hash:', insertHashError);\r\n    } else {\r\n      console.log('‚úÖ Hash guardado');\r\n    }\r\n    console.log('üíæ Guardando imagen en tabla media...');\r\n\r\n    const { data: photoData, error: photoError } = await supabase\r\n      .from('media')\r\n      .insert([\r\n        {\r\n          hotel_id: hotelId,\r\n          url: uploadResult.secure_url,\r\n          tags: tagsArray,\r\n          confidence_scores: analysis.tags,\r\n          quality_score: qualityScore,\r\n          hash,\r\n          category\r\n        }\r\n      ])\r\n      .select();\r\n\r\n    if (photoError) {\r\n      console.error('‚ùå Error guardando foto:', photoError);\r\n      throw new Error('Error al guardar foto en base de datos');\r\n    }\r\n\r\n    console.log('‚úÖ Foto guardada con ID:', photoData[0].id);\r\n    return NextResponse.json({\r\n      url: uploadResult.secure_url,\r\n      type: uploadResult.resource_type,\r\n      quality_score: qualityScore,\r\n      is_duplicate: false,\r\n      tags: analysis.tags,\r\n      category,\r\n      photo_id: photoData[0].id\r\n    });\r\n\r\n  } catch (error) {\r\n    console.error('‚ùå Error fatal en API:', error);\r\n    return NextResponse.json(\r\n      {\r\n        error: 'Error interno del servidor',\r\n        details: error instanceof Error ? error.message : String(error)\r\n      },\r\n      { status: 500 }\r\n    );\r\n  }\r\n}\r\n"],"names":[],"mappings":"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"}}]
}