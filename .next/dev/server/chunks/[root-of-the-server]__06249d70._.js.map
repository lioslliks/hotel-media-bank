{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 100, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/achra/proyectos/app-hotel-nueva/src/lib/detectCategoryVision.ts"],"sourcesContent":["// src/lib/detectCategoryVision.ts - Versi√≥n 4.0.2 ROBUSTA (CORREGIDA)\r\n\r\nexport type HotelCategory =\r\n  | \"pool\" | \"infinity_pool\" | \"indoor_pool\" | \"beach\" | \"kids_pool\"\r\n  | \"room\" | \"suite\" | \"presidential_suite\" | \"bathroom\"\r\n  | \"restaurant\" | \"buffet\" | \"bar\" | \"rooftop_bar\" | \"pool_bar\" | \"beach_bar\"\r\n  | \"spa\" | \"sauna\" | \"steam_room\" | \"gym\" | \"yoga_room\"\r\n  | \"terrace\" | \"rooftop_terrace\" | \"garden\" | \"courtyard\" | \"exterior\"\r\n  | \"lobby\" | \"lounge\" | \"library\"\r\n  | \"conference_room\" | \"ballroom\" | \"wedding_venue\"\r\n  | \"kids_area\" | \"playground\"\r\n  | \"view\" | \"architectural_detail\" | \"other\"\r\n\r\nexport interface CategoryDetection {\r\n  primary: HotelCategory\r\n  secondary?: HotelCategory[]\r\n  confidence: \"high\" | \"medium\" | \"low\"\r\n  reasoning: string[]\r\n  tagsUsed: string[]\r\n  source?: 'backend_ensemble' | 'frontend_inference'\r\n  metadata?: { \r\n    backendConfidence?: number\r\n    validationScore?: number\r\n    fallbackReason?: string\r\n    locationType?: 'interior' | 'exterior' | 'mixto' // ‚úÖ NUEVO: Ubicaci√≥n separada de categor√≠a\r\n  }\r\n}\r\n\r\nexport interface CategoryDetectionOptions {\r\n  backendCategoria?: string\r\n  backendUbicacion?: 'interior' | 'exterior' | 'mixto'\r\n  tagsConfidence?: Record<string, number>\r\n  minBackendConfidence?: number\r\n  captionContext?: string\r\n}\r\n\r\nexport function detectCategoryVision(tags: string[], options?: CategoryDetectionOptions): CategoryDetection {\r\n  const normalized = tags.map(t => t.toLowerCase().trim())\r\n  const has = (keywords: string | string[]): boolean => {\r\n    const keys = Array.isArray(keywords) ? keywords : [keywords]\r\n    return keys.some(k => normalized.includes(k.toLowerCase().trim()))\r\n  }\r\n\r\n  // ‚úÖ PRIORIDAD 1: BACKEND con validaci√≥n ESTRICTA\r\n  const minConfidence = options?.minBackendConfidence ?? 0.75\r\n  \r\n  if (options?.backendCategoria && options?.backendUbicacion) {\r\n    const validation = validateBackendDecision({\r\n      backendCategoria: options.backendCategoria,\r\n      backendUbicacion: options.backendUbicacion,\r\n      tags: normalized,\r\n      tagsConfidence: options.tagsConfidence,\r\n      captionContext: options.captionContext\r\n    })\r\n    \r\n    // ‚úÖ FORZAR INTERIOR para categor√≠as que siempre son interiores\r\n    const alwaysInterior = ['restaurante', 'bar', 'lobby', 'gimnasio', 'bano', 'habitacion', 'spa']\r\n    const forcedUbicacion = alwaysInterior.includes(options.backendCategoria) && options.backendUbicacion === 'exterior'\r\n      ? 'interior' \r\n      : options.backendUbicacion\r\n    \r\n    if (validation.isValid && validation.confidence >= minConfidence) {\r\n      return {\r\n        primary: mapBackendCategoria(options.backendCategoria),\r\n        // ‚úÖ CORREGIDO: Secondary solo con categor√≠as relacionadas v√°lidas\r\n        secondary: buildSecondaryCategories(options.backendCategoria, normalized),\r\n        confidence: validation.confidence >= 0.8 ? \"high\" : validation.confidence >= 0.75 ? \"medium\" : \"low\",\r\n        reasoning: [`backend ensemble: ${validation.reason}`],\r\n        tagsUsed: tags.slice(0, 5),\r\n        source: 'backend_ensemble',\r\n        metadata: { \r\n          backendConfidence: validation.confidence, \r\n          validationScore: validation.score,\r\n          locationType: forcedUbicacion // ‚úÖ Ubicaci√≥n separada\r\n        }\r\n      }\r\n    }\r\n  }\r\n\r\n  // ‚úÖ PRIORIDAD 2: L√ìGICA LOCAL con reglas MEJORADAS\r\n  \r\n  // REGLA 1: Restaurante/buffet ‚Üí INTERIOR (m√°xima prioridad)\r\n  if (has([\"restaurant\", \"buffet\", \"bufet\", \"dining_room\"]) || (has(\"dining_table\") && has(\"chair\"))) {\r\n    return { \r\n      primary: \"restaurant\", \r\n      // ‚úÖ CORREGIDO: Secondary con categor√≠as relacionadas, no ubicaci√≥n\r\n      secondary: buildSecondaryCategoriesLocal(\"restaurante\", normalized),\r\n      confidence: \"high\",\r\n      reasoning: [\"restaurante detectado ‚Üí interior\"], \r\n      tagsUsed: tags.slice(0, 5), \r\n      source: 'frontend_inference',\r\n      metadata: { locationType: 'interior' } // ‚úÖ Ubicaci√≥n en metadata\r\n    }\r\n  }\r\n  \r\n  // REGLA 2: Bar con mobiliario ‚Üí INTERIOR\r\n  if (has(\"bar\") && (has(\"chair\") || has(\"table\") || has(\"counter\"))) {\r\n    return { \r\n      primary: \"bar\", \r\n      secondary: buildSecondaryCategoriesLocal(\"bar\", normalized),\r\n      confidence: \"high\",\r\n      reasoning: [\"bar con mobiliario ‚Üí interior\"], \r\n      tagsUsed: tags.slice(0, 5), \r\n      source: 'frontend_inference',\r\n      metadata: { locationType: 'interior' }\r\n    }\r\n  }\r\n  \r\n  // REGLA 3: Lobby/recepci√≥n ‚Üí INTERIOR\r\n  if (has([\"lobby\", \"reception\", \"check-in\", \"atrium\"])) {\r\n    return { \r\n      primary: \"lobby\", \r\n      secondary: buildSecondaryCategoriesLocal(\"lobby\", normalized),\r\n      confidence: \"high\",\r\n      reasoning: [\"lobby detectado ‚Üí interior\"], \r\n      tagsUsed: tags.slice(0, 5), \r\n      source: 'frontend_inference',\r\n      metadata: { locationType: 'interior' }\r\n    }\r\n  }\r\n  \r\n  // REGLA 4: Habitaci√≥n ‚Üí INTERIOR\r\n  if (has([\"room\", \"bedroom\", \"suite\", \"bed\"]) || has([\"king_bed\", \"queen_bed\", \"twin_beds\"])) {\r\n    return { \r\n      primary: has([\"suite\", \"presidential\"]) ? \"suite\" : \"room\", \r\n      secondary: buildSecondaryCategoriesLocal(\"habitacion\", normalized),\r\n      confidence: \"high\",\r\n      reasoning: [\"habitaci√≥n detectada ‚Üí interior\"], \r\n      tagsUsed: tags.slice(0, 5), \r\n      source: 'frontend_inference',\r\n      metadata: { locationType: 'interior' }\r\n    }\r\n  }\r\n  \r\n  // REGLA 5: Ba√±o ‚Üí INTERIOR\r\n  if (has([\"bathroom\", \"ba√±o\", \"shower\", \"bathtub\"])) {\r\n    return { \r\n      primary: \"bathroom\", \r\n      secondary: buildSecondaryCategoriesLocal(\"bano\", normalized),\r\n      confidence: \"high\",\r\n      reasoning: [\"ba√±o detectado ‚Üí interior\"], \r\n      tagsUsed: tags.slice(0, 5), \r\n      source: 'frontend_inference',\r\n      metadata: { locationType: 'interior' }\r\n    }\r\n  }\r\n  \r\n  // REGLA 6: Spa/gimnasio ‚Üí INTERIOR\r\n  if (has([\"spa\", \"sauna\", \"massage\", \"gym\", \"fitness\"])) {\r\n    return { \r\n      primary: has([\"gym\", \"fitness\"]) ? \"gym\" : \"spa\", \r\n      secondary: buildSecondaryCategoriesLocal(\"spa\", normalized),\r\n      confidence: \"high\",\r\n      reasoning: [\"spa/gimnasio detectado ‚Üí interior\"], \r\n      tagsUsed: tags.slice(0, 5), \r\n      source: 'frontend_inference',\r\n      metadata: { locationType: 'interior' }\r\n    }\r\n  }\r\n  \r\n  // REGLA 7: Piscina infinita ‚Üí EXTERIOR\r\n  if (has(\"infinity_pool\") || (has(\"pool\") && has([\"vanishing\", \"edge\", \"horizon\", \"sea_view\"]))) {\r\n    return { \r\n      primary: \"infinity_pool\", \r\n      secondary: buildSecondaryCategoriesLocal(\"piscina\", normalized),\r\n      confidence: \"high\",\r\n      reasoning: [\"piscina infinita ‚Üí exterior\"], \r\n      tagsUsed: tags.slice(0, 5), \r\n      source: 'frontend_inference',\r\n      metadata: { locationType: 'exterior' }\r\n    }\r\n  }\r\n  \r\n  // REGLA 8: Piscina exterior (solo si hay indicadores claros de exterior)\r\n  if (has(\"pool\") && !has([\"ceiling\", \"techo\", \"indoor\", \"chandelier\"]) && has([\"exterior\", \"outdoor\", \"sky\", \"sun\", \"palm\"])) {\r\n    return { \r\n      primary: \"pool\", \r\n      secondary: buildSecondaryCategoriesLocal(\"piscina\", normalized),\r\n      confidence: \"high\",\r\n      reasoning: [\"piscina con indicadores exteriores\"], \r\n      tagsUsed: tags.slice(0, 5), \r\n      source: 'frontend_inference',\r\n      metadata: { locationType: 'exterior' }\r\n    }\r\n  }\r\n  \r\n  // REGLA 9: Playa ‚Üí EXTERIOR\r\n  if (has([\"beach\", \"playa\", \"shoreline\", \"sand\"])) {\r\n    return { \r\n      primary: \"beach\", \r\n      secondary: buildSecondaryCategoriesLocal(\"playa\", normalized),\r\n      confidence: \"high\",\r\n      reasoning: [\"playa detectada ‚Üí exterior\"], \r\n      tagsUsed: tags.slice(0, 5), \r\n      source: 'frontend_inference',\r\n      metadata: { locationType: 'exterior' }\r\n    }\r\n  }\r\n  \r\n  // REGLA 10: Fachada/exterior ‚Üí EXTERIOR\r\n  if (has([\"facade\", \"fachada\", \"building exterior\", \"vista exterior\"])) {\r\n    return { \r\n      primary: \"exterior\", \r\n      secondary: buildSecondaryCategoriesLocal(\"exterior\", normalized),\r\n      confidence: \"high\",\r\n      reasoning: [\"fachada detectada ‚Üí exterior\"], \r\n      tagsUsed: tags.slice(0, 5), \r\n      source: 'frontend_inference',\r\n      metadata: { locationType: 'exterior' }\r\n    }\r\n  }\r\n  \r\n  // REGLA 11: Jard√≠n ‚Üí EXTERIOR\r\n  if (has([\"garden\", \"jardin\", \"landscaped\", \"palm_tree\"])) {\r\n    return { \r\n      primary: \"garden\", \r\n      secondary: buildSecondaryCategoriesLocal(\"exterior\", normalized),\r\n      confidence: \"medium\",\r\n      reasoning: [\"jard√≠n detectado ‚Üí exterior\"], \r\n      tagsUsed: tags.slice(0, 5), \r\n      source: 'frontend_inference',\r\n      metadata: { locationType: 'exterior' }\r\n    }\r\n  }\r\n\r\n  // FALLBACK: Sin categor√≠a clara ‚Üí asumir interior (m√°s seguro)\r\n  return {\r\n    primary: \"other\",\r\n    // ‚úÖ CORREGIDO: Secondary vac√≠o o con categor√≠as inferidas, nunca ubicaci√≥n\r\n    secondary: [],\r\n    confidence: \"low\",\r\n    reasoning: [\"fallback: sin categor√≠a clara\"],\r\n    tagsUsed: normalized.slice(0, 3),\r\n    source: 'frontend_inference',\r\n    metadata: { \r\n      fallbackReason: \"sin_categoria_clara\",\r\n      locationType: 'interior' // Default seguro\r\n    }\r\n  }\r\n}\r\n\r\n// ‚úÖ VALIDACI√ìN DE BACKEND MEJORADA\r\ninterface BackendValidationResult {\r\n  isValid: boolean; confidence: number; score: number; reason: string; matchingTags: string[]\r\n}\r\n\r\nfunction validateBackendDecision(params: {\r\n  backendCategoria: string; backendUbicacion: string; tags: string[];\r\n  tagsConfidence?: Record<string, number>; captionContext?: string\r\n}): BackendValidationResult {\r\n  const { backendCategoria, backendUbicacion, tags, tagsConfidence, captionContext } = params\r\n  \r\n  const categoryKeywords: Record<string, string[]> = {\r\n    piscina: [\"pool\", \"piscina\", \"swimming\", \"jacuzzi\"],\r\n    habitacion: [\"room\", \"habitacion\", \"bedroom\", \"suite\", \"bed\"],\r\n    bano: [\"bathroom\", \"ba√±o\", \"shower\", \"bathtub\"],\r\n    restaurante: [\"restaurant\", \"restaurante\", \"dining\", \"buffet\", \"bufet\"],\r\n    bar: [\"bar\", \"barra\", \"lounge\", \"cocktail\"],\r\n    spa: [\"spa\", \"wellness\", \"massage\", \"sauna\"],\r\n    lobby: [\"lobby\", \"reception\", \"hall\", \"atrium\"],\r\n    exterior: [\"exterior\", \"facade\", \"fachada\", \"building\"],\r\n    playa: [\"beach\", \"playa\", \"shoreline\", \"sand\"],\r\n    gimnasio: [\"gym\", \"gimnasio\", \"fitness\"]\r\n  }\r\n  \r\n  const keywords = categoryKeywords[backendCategoria] || []\r\n  if (keywords.length === 0) return { isValid: false, confidence: 0, score: 0, reason: \"categoria_desconocida\", matchingTags: [] }\r\n  \r\n  let maxScore = 0; const matchingTags: string[] = []\r\n  for (const keyword of keywords) {\r\n    const tagMatch = tags.find(t => t.includes(keyword) || keyword.includes(t))\r\n    if (tagMatch) {\r\n      const score = tagsConfidence?.[tagMatch] ?? 0.5\r\n      if (score > maxScore) { maxScore = score; matchingTags.push(tagMatch) }\r\n    }\r\n  }\r\n  \r\n  if (maxScore < 0.1) return { isValid: false, confidence: 0, score: 0, reason: \"sin_tags_coincidentes\", matchingTags: [] }\r\n  \r\n  // ‚úÖ VALIDACI√ìN DE UBICACI√ìN: Categor√≠as que SIEMPRE son interior\r\n  const alwaysInterior = ['restaurante', 'bar', 'lobby', 'gimnasio', 'bano', 'habitacion', 'spa']\r\n  if (alwaysInterior.includes(backendCategoria) && backendUbicacion === 'exterior') {\r\n    return { isValid: false, confidence: maxScore, score: maxScore, \r\n      reason: `categoria ${backendCategoria} siempre es interior`, matchingTags }\r\n  }\r\n  \r\n  const isValid = maxScore >= 0.4\r\n  return { isValid, confidence: maxScore, score: maxScore, \r\n    reason: isValid ? `validaci√≥n_ok (${maxScore.toFixed(2)})` : `score_insuficiente`, matchingTags }\r\n}\r\n\r\nfunction mapBackendCategoria(backend: string): HotelCategory {\r\n  const mapping: Record<string, HotelCategory> = {\r\n    piscina: \"pool\", habitacion: \"room\", bano: \"bathroom\", restaurante: \"restaurant\",\r\n    bar: \"bar\", spa: \"spa\", lobby: \"lobby\", exterior: \"exterior\", playa: \"beach\", gimnasio: \"gym\",\r\n    infinity_pool: \"infinity_pool\", indoor_pool: \"indoor_pool\", kids_pool: \"kids_pool\",\r\n    suite: \"suite\", presidential_suite: \"presidential_suite\", buffet: \"buffet\",\r\n    rooftop_bar: \"rooftop_bar\", pool_bar: \"pool_bar\", beach_bar: \"beach_bar\",\r\n    sauna: \"sauna\", steam_room: \"steam_room\", yoga_room: \"yoga_room\",\r\n    terrace: \"terrace\", rooftop_terrace: \"rooftop_terrace\", garden: \"garden\",\r\n    courtyard: \"courtyard\", lounge: \"lounge\", library: \"library\",\r\n    conference_room: \"conference_room\", ballroom: \"ballroom\", wedding_venue: \"wedding_venue\",\r\n    kids_area: \"kids_area\", playground: \"playground\", view: \"view\",\r\n    architectural_detail: \"architectural_detail\", otros: \"other\"\r\n  }\r\n  return mapping[backend] || \"other\"\r\n}\r\n\r\n// ‚úÖ CORREGIDO: Build secondary categories - SOLO categor√≠as relacionadas v√°lidas\r\nfunction buildSecondaryCategories(categoria: string, tags: string[]): HotelCategory[] {\r\n  const secondary: HotelCategory[] = []\r\n  \r\n  // === VISTAS (si hay evidencia) ===\r\n  if (tags.some(t => /sea.*view|vista.*mar|ocean.*view|horizon|panoramic/.test(t))) {\r\n    secondary.push('view')\r\n  } else if (tags.some(t => /city.*view|skyline|urbano/.test(t))) {\r\n    secondary.push('view')\r\n  } else if (tags.some(t => /mountain.*view|sierra|valle/.test(t))) {\r\n    secondary.push('view')\r\n  }\r\n  \r\n  // === SUBCATEGOR√çAS ESPEC√çFICAS ===\r\n  if (categoria === 'piscina') {\r\n    if (tags.some(t => /infinity|vanishing|borde.*infinito/.test(t))) {\r\n      secondary.push('infinity_pool')\r\n    } else if (tags.some(t => /indoor|cubierta|covered/.test(t))) {\r\n      secondary.push('indoor_pool')\r\n    } else if (tags.some(t => /kids|children|infantil/.test(t))) {\r\n      secondary.push('kids_pool')\r\n    }\r\n  }\r\n  \r\n  if (categoria === 'habitacion') {\r\n    if (tags.some(t => /presidential/.test(t))) {\r\n      secondary.push('presidential_suite')\r\n    } else if (tags.some(t => /suite|junior/.test(t))) {\r\n      secondary.push('suite')\r\n    }\r\n    if (tags.some(t => /balcony|balcon|terrace/.test(t))) {\r\n      secondary.push('terrace')\r\n    }\r\n  }\r\n  \r\n  if (categoria === 'restaurante') {\r\n    if (tags.some(t => /buffet/.test(t))) {\r\n      secondary.push('buffet')\r\n    }\r\n    if (tags.some(t => /terrace|terraza|outdoor.*dining/.test(t))) {\r\n      secondary.push('terrace')\r\n    }\r\n  }\r\n  \r\n  if (categoria === 'bar') {\r\n    if (tags.some(t => /rooftop|azotea/.test(t))) {\r\n      secondary.push('rooftop_bar')\r\n    } else if (tags.some(t => /pool|piscina/.test(t))) {\r\n      secondary.push('pool_bar')\r\n    } else if (tags.some(t => /beach|playa/.test(t))) {\r\n      secondary.push('beach_bar')\r\n    }\r\n  }\r\n  \r\n  if (categoria === 'spa') {\r\n    if (tags.some(t => /sauna/.test(t))) {\r\n      secondary.push('sauna')\r\n    } else if (tags.some(t => /steam|vapor/.test(t))) {\r\n      secondary.push('steam_room')\r\n    }\r\n  }\r\n  \r\n  if (categoria === 'exterior') {\r\n    if (tags.some(t => /garden|jardin|landscaped/.test(t))) {\r\n      secondary.push('garden')\r\n    }\r\n    if (tags.some(t => /terrace|terraza/.test(t))) {\r\n      secondary.push('terrace')\r\n    }\r\n    if (tags.some(t => /courtyard|patio/.test(t))) {\r\n      secondary.push('courtyard')\r\n    }\r\n  }\r\n  \r\n  // === ELEMENTOS ARQUITECT√ìNICOS ===\r\n  if (tags.some(t => /chandelier|ara√±a|luxury.*lighting/.test(t))) {\r\n    secondary.push('architectural_detail')\r\n  }\r\n  \r\n  // ‚úÖ Eliminar duplicados y filtrar undefined\r\n  return [...new Set(secondary)].filter(Boolean) as HotelCategory[]\r\n}\r\n\r\n// ‚úÖ NUEVA: Build secondary para l√≥gica local (mismo patr√≥n)\r\nfunction buildSecondaryCategoriesLocal(categoriaBackend: string, tags: string[]): HotelCategory[] {\r\n  // Mapear categor√≠a backend a l√≥gica de frontend\r\n  const categoriaMap: Record<string, string> = {\r\n    'restaurante': 'restaurante',\r\n    'bar': 'bar',\r\n    'lobby': 'lobby',\r\n    'habitacion': 'habitacion',\r\n    'bano': 'bano',\r\n    'spa': 'spa',\r\n    'piscina': 'piscina',\r\n    'playa': 'playa',\r\n    'exterior': 'exterior'\r\n  }\r\n  const categoria = categoriaMap[categoriaBackend] || categoriaBackend\r\n  return buildSecondaryCategories(categoria, tags)\r\n}\r\n\r\nexport function detectSimpleCategory(tags: string[]): HotelCategory {\r\n  return detectCategoryVision(tags).primary\r\n}\r\n\r\nexport function getCategoryLabel(category: HotelCategory): string {\r\n  const LABELS: Record<HotelCategory, string> = {\r\n    pool: \"Piscina\", infinity_pool: \"Piscina Infinita\", indoor_pool: \"Piscina Cubierta\",\r\n    beach: \"Playa\", kids_pool: \"Piscina Infantil\", room: \"Habitaci√≥n\", suite: \"Suite\",\r\n    presidential_suite: \"Suite Presidencial\", bathroom: \"Ba√±o\", restaurant: \"Restaurante\",\r\n    buffet: \"Buffet\", bar: \"Bar\", rooftop_bar: \"Bar en Azotea\", pool_bar: \"Bar de Piscina\",\r\n    beach_bar: \"Chiringuito\", spa: \"Spa\", sauna: \"Sauna\", steam_room: \"Ba√±o de Vapor\",\r\n    gym: \"Gimnasio\", yoga_room: \"Sala de Yoga\", terrace: \"Terraza\", rooftop_terrace: \"Terraza en Azotea\",\r\n    garden: \"Jard√≠n\", courtyard: \"Patio Interior\", exterior: \"Fachada\", lobby: \"Lobby\",\r\n    lounge: \"Sal√≥n\", library: \"Biblioteca\", conference_room: \"Sala de Reuniones\",\r\n    ballroom: \"Sal√≥n de Eventos\", wedding_venue: \"Espacio para Bodas\", kids_area: \"Zona Infantil\",\r\n    playground: \"Parque Infantil\", view: \"Vistas\", architectural_detail: \"Detalle Arquitect√≥nico\",\r\n    other: \"Otro espacio\"\r\n  }\r\n  return LABELS[category] || \"Otro espacio\"\r\n}\r\n\r\nexport function analyzeGalleryCategories(detections: CategoryDetection[]): Record<HotelCategory, number> {\r\n  const distribution: Record<HotelCategory, number> = {\r\n    pool: 0, infinity_pool: 0, indoor_pool: 0, beach: 0, kids_pool: 0,\r\n    room: 0, suite: 0, presidential_suite: 0, bathroom: 0,\r\n    restaurant: 0, buffet: 0, bar: 0, rooftop_bar: 0, pool_bar: 0, beach_bar: 0,\r\n    spa: 0, sauna: 0, steam_room: 0, gym: 0, yoga_room: 0,\r\n    terrace: 0, rooftop_terrace: 0, garden: 0, courtyard: 0, exterior: 0,\r\n    lobby: 0, lounge: 0, library: 0, conference_room: 0, ballroom: 0, wedding_venue: 0,\r\n    kids_area: 0, playground: 0, view: 0, architectural_detail: 0, other: 0\r\n  }\r\n  detections.forEach(d => {\r\n    distribution[d.primary] = (distribution[d.primary] || 0) + 1\r\n    // ‚úÖ CORREGIDO: Solo sumar secondary si son categor√≠as v√°lidas (no ubicaci√≥n)\r\n    d.secondary?.forEach(sec => { \r\n      if (distribution[sec] !== undefined && sec !== 'interior' && sec !== 'exterior' && sec !== 'mixto') {\r\n        distribution[sec] = (distribution[sec] || 0) + 0.3 \r\n      }\r\n    })\r\n  })\r\n  return distribution\r\n}\r\n\r\nexport function detectCategoryWithTrace(tags: string[], options?: CategoryDetectionOptions): CategoryDetection & { trace: { timestamp: number, source: string } } {\r\n  const result = detectCategoryVision(tags, options)\r\n  return { ...result, trace: { timestamp: Date.now(), source: result.source || 'unknown' } }\r\n}\r\n\r\n// ‚úÖ NUEVA: Utilidad para obtener ubicaci√≥n inferida (separada de categor√≠a)\r\nexport function inferLocationFromTags(tags: string[]): 'interior' | 'exterior' | 'mixto' {\r\n  const normalized = tags.map(t => t.toLowerCase().trim())\r\n  const has = (keywords: string[]): boolean => keywords.some(k => normalized.includes(k))\r\n  \r\n  const exteriorKeywords = [\r\n    'sky', 'cielo', 'cloud', 'sun', 'sunny', 'palm', 'palmera', 'garden', 'jardin',\r\n    'facade', 'fachada', 'exterior', 'outdoor', 'beach', 'playa', 'sea', 'mar',\r\n    'pool', 'piscina', 'terrace', 'terraza', 'balcony', 'balcon', 'landscape'\r\n  ]\r\n  \r\n  const interiorKeywords = [\r\n    'ceiling', 'techo', 'bed', 'cama', 'bathroom', 'ba√±o', 'shower', 'bathtub',\r\n    'curtain', 'cortina', 'carpet', 'chandelier', 'reception', 'lobby', 'restaurant',\r\n    'dining', 'bar', 'spa', 'gym', 'indoor', 'interior'\r\n  ]\r\n  \r\n  const extCount = exteriorKeywords.filter(k => has([k])).length\r\n  const intCount = interiorKeywords.filter(k => has([k])).length\r\n  \r\n  if (extCount > intCount + 2) return 'exterior'\r\n  if (intCount > extCount + 2) return 'interior'\r\n  if (extCount > 0 && intCount > 0) return 'mixto'\r\n  \r\n  return 'interior' // Default conservador\r\n}"],"names":[],"mappings":"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"}},
    {"offset": {"line": 850, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/achra/proyectos/app-hotel-nueva/src/lib/ai.ts"],"sourcesContent":["// src/lib/ai.ts\r\n\r\n/**\r\n * ü§ñ Cliente robusto para backend de IA (CLIP + YOLO + Florence-2) - Versi√≥n Ensemble 3.0\r\n * \r\n * Caracter√≠sticas profesionales:\r\n * ‚úÖ Separaci√≥n clara de responsabilidades (transporte vs normalizaci√≥n)\r\n * ‚úÖ BLOCKLIST inteligente: SOLO elimina ruido real (veh√≠culos, personas), NO elementos hoteleros relevantes\r\n * ‚úÖ Timeout y reintentos autom√°ticos con backoff exponencial\r\n * ‚úÖ URL del backend configurable v√≠a variable de entorno\r\n * ‚úÖ Logging estructurado para debugging\r\n * ‚úÖ Manejo de errores con fallbacks graduales\r\n * ‚úÖ Tipado completo TypeScript\r\n * ‚úÖ Optimizado para producci√≥n (circuit breaker impl√≠cito)\r\n * ‚úÖ ‚úÖ NUEVO: Soporte para respuesta estructurada del backend ensemble (categoria/ubicacion/titulo_sugerido)\r\n */\r\n\r\n// ============================================================\r\n// üîí CONFIGURACI√ìN SEGURA (nunca hardcodear URLs sensibles)\r\n// ============================================================\r\n\r\nconst BACKEND_URL = process.env.NEXT_PUBLIC_AI_BACKEND_URL || \"http://localhost:8000\"\r\nconst ANALYZE_TIMEOUT_MS = 50_000 // 15 segundos (ensemble es m√°s completo)\r\nconst CAPTION_TIMEOUT_MS = 25_000 // 25 segundos (Florence-2 es m√°s lento)\r\nconst MAX_RETRIES = 2\r\nconst BASE_RETRY_DELAY_MS = 1_000\r\n\r\n// ============================================================\r\n// üö´ BLOCKLIST INTELIGENTE (SOLO ruido REAL, NO elementos hoteleros)\r\n// ============================================================\r\n// ‚ö†Ô∏è CR√çTICO: Los elementos como \"umbrella\", \"sunbed\", \"garden\", \"tree\", \"sky\" SON RELEVANTES \r\n// para hoteles y DEBEN mantenerse. Solo bloqueamos ruido genuino:\r\nconst BLOCKLIST = new Set([\r\n  // Veh√≠culos (nunca relevantes en fotos hoteleras profesionales)\r\n  \"car\", \"cars\", \"truck\", \"trucks\", \"van\", \"vans\", \"bus\", \"buses\", \"motorcycle\", \"bicycle\",\r\n  \"boat\", \"boats\", \"yacht\", \"ship\", \"airplane\", \"helicopter\", \"train\", \"taxi\", \"scooter\",\r\n  \r\n  // Personas (ruido com√∫n en CLIP, nunca queremos tags de personas)\r\n  \"person\", \"people\", \"man\", \"woman\", \"child\", \"children\", \"couple\", \"group\", \"tourist\", \r\n  \"guest\", \"staff\", \"waiter\", \"chef\", \"lifeguard\", \"silhouette\", \"shadow\",\r\n  \r\n  // Animales dom√©sticos (no relevantes para amenities)\r\n  \"dog\", \"cat\", \"bird\", \"seagull\", \"pigeon\", \"insect\", \"butterfly\",\r\n  \r\n  // Objetos dom√©sticos irrelevantes para clasificaci√≥n hotelera\r\n  \"bottle\", \"plate\", \"glass\", \"cup\", \"food\", \"meal\", \"dish\", \"utensil\", \"cutlery\", \r\n  \"napkin\", \"menu\", \"receipt\", \"luggage\", \"suitcase\", \"bag\",\r\n  \r\n  // Infraestructura urbana NO hotelera\r\n  \"street\", \"road\", \"highway\", \"parking lot\", \"garage\", \"traffic light\", \"sign\", \"billboard\",\r\n  \"construction\", \"scaffolding\", \"crane\", \"apartment building\", \"office building\",\r\n  \r\n  // Ruido t√©cnico CLIP\r\n  \"image\", \"photo\", \"picture\", \"view\", \"scene\", \"area\", \"space\", \"place\", \"location\",\r\n  \"background\", \"foreground\", \"blur\", \"bokeh\"\r\n])\r\n\r\n// ============================================================\r\n// üì¶ TIPOS ESTRUCTURADOS ACTUALIZADOS\r\n// ============================================================\r\n\r\n/**\r\n * Categor√≠as principales soportadas por el sistema ensemble\r\n */\r\nexport type HotelCategoria = \r\n  | 'piscina' \r\n  | 'habitacion' \r\n  | 'bano' \r\n  | 'restaurante' \r\n  | 'bar' \r\n  | 'spa' \r\n  | 'lobby' \r\n  | 'exterior' \r\n  | 'playa' \r\n  | 'gimnasio' \r\n  | 'otros'\r\n\r\n/**\r\n * Ubicaci√≥n f√≠sica de la foto\r\n */\r\nexport type HotelUbicacion = 'interior' | 'exterior' | 'mixto'\r\n\r\n/**\r\n * Resultado completo del an√°lisis de imagen con soporte ensemble\r\n */\r\nexport interface ImageAnalysisResult {\r\n  // === Campos de compatibilidad con frontend existente ===\r\n  \r\n  /** Tags sem√°nticos de CLIP (ya filtrados de BLOCKLIST) */\r\n  tags: string[]\r\n  \r\n  /** Objetos detectados por YOLO con coordenadas */\r\n  objects: Array<{\r\n    label: string\r\n    confidence: number\r\n    bbox?: [number, number, number, number] // [x1, y1, x2, y2] - opcional\r\n  }>\r\n  \r\n  /** Caption generado por Florence-2 (puede estar vac√≠o si falla) */\r\n  caption: string\r\n  \r\n  /** Confianza global del an√°lisis (0-1) */\r\n  confidence: number\r\n  \r\n  /** Metadatos de procesamiento */\r\n  processing_time_ms: number\r\n  model_version: string\r\n  \r\n  // === ‚úÖ NUEVOS CAMPOS DEL BACKEND ENSEMBLE (ESENCIALES) ===\r\n  \r\n  /** Categor√≠a principal detectada por el ensemble */\r\n  categoria?: HotelCategoria\r\n  \r\n  /** Ubicaci√≥n f√≠sica: interior/exterior/mixto */\r\n  ubicacion?: HotelUbicacion\r\n  \r\n  /** T√≠tulo descriptivo generado autom√°ticamente (NO gen√©rico) */\r\n  titulo_sugerido?: string\r\n  \r\n  /** Mapa de confianza por tag individual */\r\n  tags_confidence?: Record<string, number>\r\n  \r\n  /** Metadatos adicionales del ensemble (debugging) */\r\n  ensemble_metadata?: {\r\n    category_votes?: Record<string, number>\r\n    location_votes?: Record<string, number>\r\n    clip_top_scores?: Record<string, number>\r\n  }\r\n}\r\n\r\n/**\r\n * Sugerencia de categor√≠a con trazabilidad de origen\r\n */\r\nexport interface CategorySuggestion {\r\n  categoria: HotelCategoria\r\n  ubicacion: HotelUbicacion\r\n  confidence: number\r\n  source: 'backend_ensemble' | 'frontend_fallback'\r\n  reasoning?: string[]\r\n}\r\n\r\n// ============================================================\r\n// üß† CLIENTE PRINCIPAL DE IA - ACTUALIZADO\r\n// ============================================================\r\n\r\n/**\r\n * Analiza una imagen usando el backend ensemble (CLIP+YOLO+Florence-2).\r\n * \r\n * ‚úÖ Devuelve tags LIMPIOS (BLOCKLIST aplicado)\r\n * ‚úÖ ‚úÖ NUEVO: Incluye categor√≠a, ubicaci√≥n y t√≠tulo sugerido del backend\r\n * ‚úÖ Si el backend no env√≠a campos estructurados, aplica fallback local inteligente\r\n * \r\n * La normalizaci√≥n avanzada de tags se hace en normalizeTags.ts\r\n */\r\nexport async function analyzeImage(\r\n  url: string, \r\n  threshold: number = 0.25  // ‚úÖ Umbral por defecto m√°s bajo para ensemble\r\n): Promise<ImageAnalysisResult> {\r\n  const requestId = generateRequestId(url)\r\n  console.log(`ü§ñ [${requestId}] Analizando imagen con ensemble: ${url.substring(0, 60)}...`)\r\n  \r\n  if (!url || typeof url !== \"string\" || !url.startsWith(\"http\")) {\r\n    console.error(`‚ùå [${requestId}] URL inv√°lida`, { url })\r\n    return createEmptyResult(\"invalid_url\")\r\n  }\r\n  \r\n  // Intentar con reintentos exponenciales\r\n  for (let attempt = 0; attempt <= MAX_RETRIES; attempt++) {\r\n    try {\r\n      const result = await withTimeout(\r\n        () => fetchAnalyze(url, threshold, requestId),\r\n        ANALYZE_TIMEOUT_MS,\r\n        `analyzeImage timeout (intentos: ${attempt + 1}/${MAX_RETRIES + 1})`\r\n      )\r\n      \r\n      // ‚úÖ VALIDAR que vengan los campos estructurados del ensemble\r\n      if (!result.categoria || !result.ubicacion) {\r\n        console.warn(`‚ö†Ô∏è [${requestId}] Backend no envi√≥ campos estructurados, aplicando fallback local`)\r\n        return applyFrontendFallback(result, url, requestId)\r\n      }\r\n      \r\n      console.log(`‚úÖ [${requestId}] Ensemble analysis exitoso: ${result.categoria}/${result.ubicacion} (conf: ${result.confidence.toFixed(2)})`, {\r\n        tags: result.tags.length,\r\n        objects: result.objects.length,\r\n        titulo: result.titulo_sugerido?.substring(0, 50)\r\n      })\r\n      \r\n      return result\r\n      \r\n    } catch (error: any) {\r\n      const isLastAttempt = attempt === MAX_RETRIES\r\n      \r\n      if (isLastAttempt) {\r\n        console.error(`‚ùå [${requestId}] Fall√≥ an√°lisis ensemble tras ${MAX_RETRIES + 1} intentos:`, {\r\n          error: error.message,\r\n          stack: error.stack?.split(\"\\n\").slice(0, 2).join(\"\\n\")\r\n        })\r\n        return createFallbackResult(url, requestId)\r\n      }\r\n      \r\n      // Esperar antes de reintentar (backoff exponencial)\r\n      const delay = BASE_RETRY_DELAY_MS * Math.pow(2, attempt)\r\n      console.warn(`‚ö†Ô∏è [${requestId}] Intento ${attempt + 1} fallido, reintentando en ${delay}ms:`, error.message)\r\n      await new Promise(resolve => setTimeout(resolve, delay))\r\n    }\r\n  }\r\n  \r\n  // Nunca deber√≠a llegar aqu√≠ (el √∫ltimo intento devuelve fallback)\r\n  return createEmptyResult(\"unexpected_failure\")\r\n}\r\n\r\n/**\r\n * Genera caption descriptivo usando Florence-2.\r\n * Devuelve string vac√≠o si falla (el pipeline usar√° fallback basado en tags).\r\n */\r\nexport async function generateImageCaption(file: File): Promise<string> {\r\n  const requestId = generateRequestId(file.name || \"unknown\")\r\n  console.log(`‚úçÔ∏è [${requestId}] Generando caption con Florence-2...`)\r\n  \r\n  try {\r\n    const caption = await withTimeout(\r\n      () => fetchCaption(file, requestId),\r\n      CAPTION_TIMEOUT_MS,\r\n      \"generateImageCaption timeout\"\r\n    )\r\n    \r\n    if (!caption || caption.length < 5) {\r\n      console.warn(`‚ö†Ô∏è [${requestId}] Caption demasiado corto o vac√≠o: \"${caption}\"`)\r\n      return \"\"\r\n    }\r\n    \r\n    // Limpiar caption b√°sico (sin normalizaci√≥n sem√°ntica)\r\n    const cleaned = caption\r\n      .replace(/^(a |an |the )/i, \"\")\r\n      .replace(/\\s+/g, \" \")\r\n      .trim()\r\n    \r\n    console.log(`‚úÖ [${requestId}] Caption generado (${cleaned.length} chars): \"${cleaned.substring(0, 80)}...\"`)\r\n    return cleaned\r\n    \r\n  } catch (error: any) {\r\n    console.error(`‚ùå [${requestId}] Error generando caption:`, {\r\n      message: error.message,\r\n      stack: error.stack?.split(\"\\n\").slice(0, 2).join(\"\\n\")\r\n    })\r\n    return \"\" // Fallback silencioso: el pipeline usar√° tags para generar t√≠tulo\r\n  }\r\n}\r\n\r\n// ============================================================\r\n// üîå COMUNICACI√ìN CON BACKEND (capa de transporte pura)\r\n// ============================================================\r\n\r\nasync function fetchAnalyze(\r\n  url: string, \r\n  threshold: number,\r\n  requestId: string\r\n): Promise<ImageAnalysisResult> {\r\n  const response = await fetch(`${BACKEND_URL}/analyze`, {\r\n    method: \"POST\",\r\n    headers: { \r\n      \"Content-Type\": \"application/json\",\r\n      \"X-Request-ID\": requestId\r\n    },\r\n    body: JSON.stringify({ url, threshold }),\r\n    // Signal para cancelaci√≥n (Node.js 18+)\r\n    signal: AbortSignal.timeout?.(ANALYZE_TIMEOUT_MS - 1000) as any || undefined\r\n  })\r\n  \r\n  if (!response.ok) {\r\n    const errorText = await response.text().catch(() => \"unknown\")\r\n    throw new Error(`Backend /analyze error ${response.status}: ${errorText}`)\r\n  }\r\n  \r\n  const data = await response.json()\r\n  \r\n  // Validar estructura de respuesta b√°sica\r\n  if (!data || typeof data !== \"object\") {\r\n    throw new Error(\"Respuesta del backend inv√°lida (no es objeto)\")\r\n  }\r\n  \r\n  // Aplicar BLOCKLIST SOLO a tags de CLIP (no a objetos YOLO que son m√°s precisos)\r\n  const cleanedTags = Array.isArray(data.tags)\r\n    ? data.tags\r\n        .map((t: any) => typeof t === \"object\" && t.label ? t.label : String(t))\r\n        .map((t: string) => t.toLowerCase().trim())\r\n        .filter((t: string) => t.length >= 2 && !BLOCKLIST.has(t))\r\n    : []\r\n  \r\n  // Validar objetos YOLO\r\n  const cleanedObjects = Array.isArray(data.objects)\r\n    ? data.objects\r\n        .filter((o: any) => \r\n          o && typeof o === \"object\" && \r\n          typeof o.label === \"string\" && \r\n          typeof o.confidence === \"number\"\r\n        )\r\n        .map((o: any) => ({\r\n          label: o.label,\r\n          confidence: o.confidence,\r\n          bbox: Array.isArray(o.bbox) && o.bbox.length === 4 ? o.bbox as [number, number, number, number] : undefined\r\n        }))\r\n    : []\r\n  \r\n  // ‚úÖ PROCESAR NUEVOS CAMPOS DEL ENSEMBLE con validaci√≥n suave\r\n  const categoria = validateCategoria(data.categoria)\r\n  const ubicacion = validateUbicacion(data.ubicacion)\r\n  \r\n  return {\r\n    // === Campos de compatibilidad ===\r\n    tags: cleanedTags,\r\n    objects: cleanedObjects,\r\n    caption: typeof data.caption === \"string\" ? data.caption.trim() : \"\",\r\n    confidence: typeof data.confidence === \"number\" ? clamp(data.confidence, 0, 1) : 0.5,\r\n    processing_time_ms: typeof data.processing_time_ms === \"number\" ? data.processing_time_ms : -1,\r\n    model_version: typeof data.model_version === \"string\" ? data.model_version : \"unknown\",\r\n    \r\n    // === ‚úÖ NUEVOS CAMPOS DEL ENSEMBLE ===\r\n    categoria,\r\n    ubicacion,\r\n    titulo_sugerido: typeof data.titulo_sugerido === \"string\" && data.titulo_sugerido.length > 0 \r\n      ? data.titulo_sugerido.trim() \r\n      : undefined,\r\n    tags_confidence: typeof data.tags_confidence === \"object\" && data.tags_confidence !== null\r\n      ? data.tags_confidence as Record<string, number>\r\n      : undefined,\r\n    ensemble_metadata: typeof data.metadata === \"object\" && data.metadata !== null\r\n      ? data.metadata\r\n      : undefined\r\n  }\r\n}\r\n\r\nasync function fetchCaption(file: File, requestId: string): Promise<string> {\r\n  const formData = new FormData()\r\n  formData.append(\"file\", file)\r\n  \r\n  const response = await fetch(`${BACKEND_URL}/caption`, {\r\n    method: \"POST\",\r\n    body: formData,\r\n    headers: {\r\n      \"X-Request-ID\": requestId\r\n    },\r\n    signal: AbortSignal.timeout?.(CAPTION_TIMEOUT_MS - 1000) as any || undefined\r\n  })\r\n  \r\n  if (!response.ok) {\r\n    const errorText = await response.text().catch(() => \"unknown\")\r\n    throw new Error(`Backend /caption error ${response.status}: ${errorText}`)\r\n  }\r\n  \r\n  const data = await response.json()\r\n  \r\n  if (!data || typeof data.caption !== \"string\") {\r\n    throw new Error(\"Respuesta de caption inv√°lida (caption no es string)\")\r\n  }\r\n  \r\n  return data.caption.trim()\r\n}\r\n\r\n// ============================================================\r\n// üõ†Ô∏è VALIDADORES Y FALLBACKS INTELIGENTES\r\n// ============================================================\r\n\r\n/**\r\n * Valida que la categor√≠a venga en el formato esperado\r\n */\r\nfunction validateCategoria(value: any): HotelCategoria | undefined {\r\n  const valid: HotelCategoria[] = [\r\n    'piscina', 'habitacion', 'bano', 'restaurante', 'bar', \r\n    'spa', 'lobby', 'exterior', 'playa', 'gimnasio', 'otros'\r\n  ]\r\n  return valid.includes(value) ? value : undefined\r\n}\r\n\r\n/**\r\n * Valida que la ubicaci√≥n venga en el formato esperado\r\n */\r\nfunction validateUbicacion(value: any): HotelUbicacion | undefined {\r\n  const valid: HotelUbicacion[] = ['interior', 'exterior', 'mixto']\r\n  return valid.includes(value) ? value : undefined\r\n}\r\n\r\n/**\r\n * Clamp utility para valores num√©ricos\r\n */\r\nfunction clamp(value: number, min: number, max: number): number {\r\n  return Math.min(Math.max(value, min), max)\r\n}\r\n\r\n/**\r\n * ‚úÖ FALLBACK INTELIGENTE: Cuando el backend no env√≠a campos estructurados,\r\n * usa detectCategoryVision.ts como respaldo para inferir categor√≠a/ubicaci√≥n.\r\n */\r\nfunction applyFrontendFallback(\r\n  basicResult: Partial<ImageAnalysisResult>, \r\n  url: string, \r\n  requestId: string\r\n): ImageAnalysisResult {\r\n  console.log(`üîÑ [${requestId}] Aplicando fallback frontend para categorizaci√≥n`)\r\n  \r\n  // Importaci√≥n din√°mica para evitar dependencias circulares en build\r\n  let detection: { primary: string; secondary?: string[]; reasoning?: string[] } | null = null\r\n  \r\n  try {\r\n    // Intentar usar la l√≥gica local de categorizaci√≥n\r\n    const { detectCategoryVision } = require('./detectCategoryVision')\r\n    detection = detectCategoryVision(basicResult.tags || [], {\r\n      // Pasar cualquier pista que tengamos del backend\r\n      tagsConfidence: basicResult.tags_confidence\r\n    })\r\n  } catch (e) {\r\n    console.warn(`‚ö†Ô∏è [${requestId}] No se pudo cargar detectCategoryVision para fallback:`, e)\r\n  }\r\n  \r\n  // Generar t√≠tulo fallback si no viene del backend\r\n  const tituloFallback = basicResult.titulo_sugerido || generateFallbackTitle(\r\n    basicResult.tags || [], \r\n    detection?.primary || 'otros'\r\n  )\r\n  \r\n  // Determinar ubicaci√≥n fallback\r\n  const ubicacionFallback = detection?.secondary?.includes('exterior') \r\n    ? 'exterior' as HotelUbicacion \r\n    : inferUbicacionFromTags(basicResult.tags || [])\r\n  \r\n  console.log(`üîÑ [${requestId}] Fallback aplicado: ${detection?.primary || 'otros'}/${ubicacionFallback}`)\r\n  \r\n  return {\r\n    ...basicResult as ImageAnalysisResult,\r\n    // Asegurar campos m√≠nimos\r\n    tags: basicResult.tags || [],\r\n    objects: basicResult.objects || [],\r\n    caption: basicResult.caption || \"\",\r\n    confidence: basicResult.confidence ?? 0.3,\r\n    processing_time_ms: basicResult.processing_time_ms ?? -1,\r\n    model_version: basicResult.model_version || \"frontend_fallback\",\r\n    \r\n    // Campos estructurados inferidos\r\n    categoria: (detection?.primary as HotelCategoria) || 'otros',\r\n    ubicacion: ubicacionFallback,\r\n    titulo_sugerido: tituloFallback,\r\n    tags_confidence: basicResult.tags?.reduce((acc: Record<string, number>, tag: string) => {\r\n      acc[tag] = 0.5 // Score por defecto en fallback\r\n      return acc\r\n    }, {}) || {}\r\n  }\r\n}\r\n\r\n/**\r\n * Genera t√≠tulo fallback cuando el backend no lo proporciona\r\n */\r\nfunction generateFallbackTitle(tags: string[], category: string): string {\r\n  const templates: Record<string, string[]> = {\r\n    piscina: [\"Piscina\", \"Piscina exterior\", \"√Årea de piscina\", \"Zona de ba√±o\"],\r\n    habitacion: [\"Habitaci√≥n\", \"Habitaci√≥n premium\", \"Suite\", \"Dormitorio\"],\r\n    bano: [\"Ba√±o\", \"Ba√±o de lujo\", \"Zona de bienestar\"],\r\n    restaurante: [\"Restaurante\", \"Zona de comedor\", \"Buffet\", \"√Årea gastron√≥mica\"],\r\n    bar: [\"Bar\", \"Lounge\", \"Zona de cocktails\"],\r\n    spa: [\"Spa\", \"Zona wellness\", \"√Årea de relajaci√≥n\"],\r\n    lobby: [\"Lobby\", \"Recepci√≥n\", \"Hall de entrada\"],\r\n    exterior: [\"Vista exterior\", \"Fachada del hotel\", \"Entorno del hotel\"],\r\n    playa: [\"Playa\", \"Acceso a playa\", \"Zona playera\"],\r\n    gimnasio: [\"Gimnasio\", \"Zona fitness\", \"√Årea de ejercicio\"],\r\n    otros: [\"Vista del hotel\", \"Espacio del hotel\"]\r\n  }\r\n  \r\n  const options = templates[category] || templates.otros\r\n  const baseTitle = options[Math.floor(Math.random() * options.length)]\r\n  \r\n  // Enriquecer con tags relevantes si est√°n presentes\r\n  const enrichments: string[] = []\r\n  if (tags.some(t => /vista|view|sea|mar/i.test(t))) enrichments.push(\"con vistas\")\r\n  if (tags.some(t => /lujo|luxury|premium/i.test(t))) enrichments.push(\"de lujo\")\r\n  if (tags.some(t => /palmera|palm|jardin|garden/i.test(t))) enrichments.push(\"con vegetaci√≥n\")\r\n  \r\n  if (enrichments.length > 0) {\r\n    return `${baseTitle} ${enrichments.join(\" y \")}`\r\n  }\r\n  \r\n  return baseTitle\r\n}\r\n\r\n/**\r\n * Infere ubicaci√≥n (interior/exterior) desde tags cuando no viene del backend\r\n */\r\nfunction inferUbicacionFromTags(tags: string[]): HotelUbicacion {\r\n  const exteriorKeywords = [\r\n    'pool', 'piscina', 'beach', 'playa', 'garden', 'jardin', 'exterior', \r\n    'outdoor', 'terrace', 'terraza', 'balcony', 'balcon', 'facade', 'fachada',\r\n    'sky', 'cielo', 'sun', 'sol', 'tree', 'arbol', 'palm', 'palmera'\r\n  ]\r\n  \r\n  const interiorKeywords = [\r\n    'room', 'habitacion', 'bedroom', 'bathroom', 'bano', 'lobby', 'reception',\r\n    'restaurant', 'restaurante', 'bar', 'spa', 'gym', 'gimnasio', 'interior'\r\n  ]\r\n  \r\n  const tagsLower = tags.map(t => t.toLowerCase())\r\n  \r\n  const exteriorScore = exteriorKeywords.filter(k => tagsLower.some(t => t.includes(k))).length\r\n  const interiorScore = interiorKeywords.filter(k => tagsLower.some(t => t.includes(k))).length\r\n  \r\n  if (exteriorScore > interiorScore) return 'exterior'\r\n  if (interiorScore > exteriorScore) return 'interior'\r\n  \r\n  // Default conservador: si hay piscina/playa, asumir exterior\r\n  if (tagsLower.some(t => /pool|piscina|beach|playa/.test(t))) return 'exterior'\r\n  \r\n  return 'interior' // Default para habitaciones/interiores\r\n}\r\n\r\n// ============================================================\r\n// üõ†Ô∏è UTILIDADES DE SOPORTE (sin cambios funcionales)\r\n// ============================================================\r\n\r\n/**\r\n * Genera ID √∫nico para trazabilidad (timestamp + hash corto)\r\n */\r\nfunction generateRequestId(input: string): string {\r\n  const hash = Array.from(input).reduce((acc, char) => {\r\n    return acc + char.charCodeAt(0)\r\n  }, 0).toString(36).padStart(4, \"0\")\r\n  \r\n  return `${Date.now().toString(36)}-${hash}`\r\n}\r\n\r\n/**\r\n * Ejecuta promesa con timeout estricto\r\n */\r\nasync function withTimeout<T>(\r\n  promise: () => Promise<T>,\r\n  ms: number,\r\n  errorMessage: string\r\n): Promise<T> {\r\n  let timeoutId: NodeJS.Timeout | undefined\r\n  const timeoutPromise = new Promise<never>((_, reject) => {\r\n    timeoutId = setTimeout(() => {\r\n      reject(new Error(`TIMEOUT: ${errorMessage} (${ms}ms)`))\r\n    }, ms)\r\n  })\r\n  \r\n  try {\r\n    return await Promise.race([promise(), timeoutPromise])\r\n  } finally {\r\n    if (timeoutId) clearTimeout(timeoutId)\r\n  }\r\n}\r\n\r\n/**\r\n * Crea resultado fallback m√≠nimo cuando falla el an√°lisis\r\n */\r\nfunction createFallbackResult(url: string, requestId: string): ImageAnalysisResult {\r\n  // Intentar inferir tags b√°sicos de la URL (ej: \"pool\" en el path)\r\n  const urlLower = url.toLowerCase()\r\n  const inferredTags: string[] = []\r\n  \r\n  if (/pool|piscina/i.test(urlLower)) inferredTags.push(\"pool\")\r\n  if (/room|habitacion|bedroom/i.test(urlLower)) inferredTags.push(\"room\")\r\n  if (/beach|playa/i.test(urlLower)) inferredTags.push(\"beach\")\r\n  if (/restaurant|restaurante/i.test(urlLower)) inferredTags.push(\"restaurant\")\r\n  if (/spa/i.test(urlLower)) inferredTags.push(\"spa\")\r\n  \r\n  // Inferir categor√≠a y ubicaci√≥n desde URL\r\n  const inferredCategoria: HotelCategoria = \r\n    /pool|piscina/i.test(urlLower) ? 'piscina' :\r\n    /room|habitacion|bedroom/i.test(urlLower) ? 'habitacion' :\r\n    /beach|playa/i.test(urlLower) ? 'playa' :\r\n    /restaurant|restaurante|buffet/i.test(urlLower) ? 'restaurante' :\r\n    /spa|wellness/i.test(urlLower) ? 'spa' : 'otros'\r\n  \r\n  const inferredUbicacion: HotelUbicacion = \r\n    ['piscina', 'playa', 'exterior'].includes(inferredCategoria) ? 'exterior' : 'interior'\r\n  \r\n  console.warn(`üîÑ [${requestId}] Usando resultado fallback con categor√≠a inferida: ${inferredCategoria}/${inferredUbicacion}`)\r\n  \r\n  return {\r\n    tags: inferredTags.length > 0 ? inferredTags : [\"hotel\", \"building\"],\r\n    objects: [],\r\n    caption: \"\",\r\n    confidence: 0.3,\r\n    processing_time_ms: -1,\r\n    model_version: \"fallback\",\r\n    \r\n    // Campos estructurados inferidos\r\n    categoria: inferredCategoria,\r\n    ubicacion: inferredUbicacion,\r\n    titulo_sugerido: `Vista de ${inferredCategoria}`,\r\n    tags_confidence: inferredTags.reduce((acc, tag) => {\r\n      acc[tag] = 0.4\r\n      return acc\r\n    }, {} as Record<string, number>)\r\n  }\r\n}\r\n\r\n/**\r\n * Crea resultado vac√≠o para errores cr√≠ticos\r\n */\r\nfunction createEmptyResult(reason: string): ImageAnalysisResult {\r\n  console.error(`üí• Resultado vac√≠o por: ${reason}`)\r\n  return {\r\n    tags: [\"hotel\"],\r\n    objects: [],\r\n    caption: \"\",\r\n    confidence: 0.1,\r\n    processing_time_ms: -1,\r\n    model_version: \"empty\",\r\n    \r\n    // Campos m√≠nimos estructurados\r\n    categoria: 'otros',\r\n    ubicacion: 'interior',\r\n    titulo_sugerido: \"Vista del hotel\",\r\n    tags_confidence: { hotel: 0.1 }\r\n  }\r\n}\r\n\r\n/**\r\n * ‚úÖ Utilidad para validar URL de imagen\r\n */\r\nexport function isValidImageUrl(url: string): boolean {\r\n  try {\r\n    const parsed = new URL(url)\r\n    return parsed.protocol === 'http:' || parsed.protocol === 'https:'\r\n  } catch {\r\n    return false\r\n  }\r\n}\r\n\r\n// ============================================================\r\n// ‚ÑπÔ∏è DOCUMENTACI√ìN DE DISE√ëO - ACTUALIZADA\r\n// ============================================================\r\n\r\n/**\r\n * ¬øPOR QU√â ESTE DISE√ëO ES SUPERIOR AL ORIGINAL?\r\n * \r\n * 1. BLOCKLIST CORREGIDA:\r\n *    ‚úÖ ANTES: Bloqueaba \"umbrella\", \"sunbed\", \"garden\", \"tree\", \"sky\" ‚Üí ¬°ELEMENTOS CLAVE para hoteles!\r\n *    ‚úÖ AHORA: Solo bloquea ruido genuino (veh√≠culos, personas, animales dom√©sticos)\r\n *    üîë Raz√≥n: Una \"sunbed\" junto a una piscina ES un amenity hotelero, no ruido.\r\n * \r\n * 2. SEPARACI√ìN DE RESPONSABILIDADES:\r\n *    ‚úÖ ANTES: Este archivo hac√≠a normalizaci√≥n sem√°ntica (pluralizaci√≥n, mapeos) ‚Üí duplicaci√≥n con normalizeTags.ts\r\n *    ‚úÖ AHORA: Solo hace transporte + BLOCKLIST b√°sica ‚Üí normalizaci√≥n avanzada en normalizeTags.ts\r\n *    üîë Raz√≥n: Single Source of Truth para l√≥gica de tags.\r\n * \r\n * 3. ‚úÖ NUEVO: SOPORTE PARA BACKEND ENSEMBLE:\r\n *    ‚úÖ Recibe categor√≠a, ubicaci√≥n y t√≠tulo sugerido del backend coordinado\r\n *    ‚úÖ Valida suavemente los campos estructurados (no rompe si faltan)\r\n *    ‚úÖ Aplica fallback inteligente a l√≥gica local si el backend no responde estructurado\r\n *    üîë Raz√≥n: El ensemble backend (CLIP+YOLO+Florence) tiene m√°s contexto para decidir categor√≠a.\r\n * \r\n * 4. RESILIENCIA ENTERPRISE:\r\n *    ‚úÖ Timeouts estrictos por operaci√≥n\r\n *    ‚úÖ Reintentos con backoff exponencial\r\n *    ‚úÖ Fallbacks graduales (no fallo total)\r\n *    ‚úÖ Logging estructurado con Request IDs\r\n *    üîë Raz√≥n: En producci√≥n, los backends fallan; el sistema debe degradar graciosamente.\r\n * \r\n * 5. SEGURIDAD:\r\n *    ‚úÖ URL del backend configurable v√≠a env var (nunca hardcodeado)\r\n *    ‚úÖ Validaci√≥n estricta de respuestas del backend\r\n *    ‚úÖ Protecci√≥n contra ataques de denegaci√≥n por timeouts\r\n *    üîë Raz√≥n: Evita hardcoding de endpoints en c√≥digo fuente.\r\n * \r\n * 6. MANTENIBILIDAD:\r\n *    ‚úÖ Tipado completo TypeScript con tipos espec√≠ficos para hotel\r\n *    ‚úÖ Funciones puras y testeables\r\n *    ‚úÖ Constantes de configuraci√≥n en un solo lugar\r\n *    üîë Raz√≥n: Facilita debugging y evoluci√≥n del sistema.\r\n * \r\n * ‚ö†Ô∏è ADVERTENCIA CR√çTICA:\r\n *    Nunca bloques elementos como \"garden\", \"tree\", \"sky\", \"cloud\", \"flower\", \"grass\" en un sistema\r\n *    de clasificaci√≥n hotelera. Estos son elementos VISUALES CLAVE que definen la experiencia del hu√©sped:\r\n *    - \"garden\" ‚Üí jard√≠n paisajista (amenity premium)\r\n *    - \"tree\" ‚Üí vegetaci√≥n natural (contexto de lujo)\r\n *    - \"sky\" + \"cloud\" ‚Üí condiciones atmosf√©ricas para golden hour\r\n *    - \"flower\" ‚Üí detalles de paisajismo de alta gama\r\n *    - \"grass\" ‚Üí √°reas verdes mantenidas\r\n * \r\n *    Bloquearlos destruir√≠a la capacidad del sistema para detectar:\r\n *    ‚úÖ \"Jard√≠n bot√°nico con flores tropicales\"\r\n *    ‚úÖ \"Piscina infinita con palmeras y cielo azul\"\r\n *    ‚úÖ \"Suite con vistas al jard√≠n y c√©sped perfectamente mantenido\"\r\n * \r\n * üéØ FLUJO DE DATOS ACTUALIZADO:\r\n *    1. Frontend llama a analyzeImage(url)\r\n *    2. Backend ensemble procesa con CLIP+YOLO+Florence-2\r\n *    3. Backend devuelve: { tags, categoria, ubicacion, titulo_sugerido, tags_confidence }\r\n *    4. Frontend valida campos estructurados\r\n *    5. Si faltan ‚Üí fallback a detectCategoryVision.ts local\r\n *    6. Resultado final siempre tiene categor√≠a y ubicaci√≥n garantizadas\r\n */"],"names":[],"mappings":"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"}},
    {"offset": {"line": 1485, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/achra/proyectos/app-hotel-nueva/src/lib/normalizeTags.ts"],"sourcesContent":["/**\r\n * üî¨ Sistema avanzado de normalizaci√≥n de tags para hoteles - Versi√≥n Ensemble 3.1 (CORREGIDA)\r\n * \r\n * ‚úÖ FIXES CR√çTICOS APLICADOS:\r\n *   - BLOCKLIST corregida: SOLO bloquea ruido REAL, NO elementos hoteleros clave\r\n *   - HOTEL_ESSENTIAL_TAGS: Whitelist expl√≠cita para proteger tags relevantes\r\n *   - Mapeo contextual inteligente seg√∫n categor√≠a\r\n *   - Eliminaci√≥n de falsos positivos (pool en habitaciones sin evidencia)\r\n *   - Soporte para scores de confianza del backend ensemble\r\n *   - Tipado TypeScript limpio sin errores de 'source'\r\n */\r\n\r\n// ============================================================\r\n// üì¶ INTERFACES Y TIPOS\r\n// ============================================================\r\n\r\nexport interface NormalizeTagsOptions {\r\n  /** Mapa de confianza por tag (del backend ensemble) */\r\n  tags_confidence?: Record<string, number>\r\n  \r\n  /** Categor√≠a sugerida por el backend para contexto de mapeo */\r\n  categoria_context?: string\r\n  \r\n  /** Ubicaci√≥n sugerida por el backend (interior/exterior) */\r\n  ubicacion_context?: 'interior' | 'exterior' | 'mixto'\r\n  \r\n  /** Umbral m√≠nimo de confianza para incluir tags (default: 0.25) */\r\n  min_confidence?: number\r\n  \r\n  /** Caption de Florence-2 para enriquecimiento contextual */\r\n  caption_context?: string\r\n  \r\n  /** Si true, prioriza tags del backend sobre inferencia local */\r\n  prefer_backend_scores?: boolean\r\n}\r\n\r\n// Tipo interno para procesamiento (no exportado, solo uso interno)\r\ntype TagWithScore = {\r\n  label: string\r\n  score: number\r\n}\r\n\r\n// ============================================================\r\n// üö´ BLOCKLIST CORREGIDA - SOLO RUIDO REAL\r\n// ============================================================\r\n// ‚úÖ CR√çTICO: Esta lista SOLO debe contener elementos que NUNCA son relevantes\r\n// para clasificaci√≥n hotelera. Elementos como \"bottle\", \"glass\", \"cutlery\" \r\n// SON ESENCIALES para detectar restaurantes/bares y NO deben bloquearse.\r\n\r\nconst BLOCKLIST = new Set([\r\n  // === VEH√çCULOS (nunca relevantes en fotos hoteleras profesionales) ===\r\n  \"car\", \"cars\", \"truck\", \"trucks\", \"van\", \"vans\", \"bus\", \"buses\", \r\n  \"motorcycle\", \"bicycle\", \"boat\", \"boats\", \"yacht\", \"ship\", \r\n  \"airplane\", \"helicopter\", \"train\", \"taxi\", \"scooter\", \"moped\",\r\n  \r\n  // === INFRAESTRUCTURA URBANA NO HOTELERA ===\r\n  \"street\", \"streets\", \"road\", \"roads\", \"highway\", \"parking lot\", \"garage\", \r\n  \"traffic light\", \"sign\", \"billboard\", \"construction\", \"scaffolding\", \"crane\",\r\n  \"power line\", \"telephone pole\", \"fire hydrant\", \"mailbox\",\r\n  \r\n  // === PERSONAS (ruido com√∫n en CLIP, nunca queremos tags de personas) ===\r\n  \"person\", \"people\", \"man\", \"woman\", \"child\", \"children\", \"couple\", \"group\", \"tourist\", \r\n  \"guest\", \"staff\", \"waiter\", \"chef\", \"lifeguard\", \"silhouette\", \"shadow\",\r\n  \"face\", \"hand\", \"arm\", \"leg\", \"head\", \"body\",\r\n  \r\n  // === ANIMALES (no relevantes para amenities hoteleros) ===\r\n  \"dog\", \"cat\", \"bird\", \"seagull\", \"pigeon\", \"insect\", \"butterfly\",\r\n  \"fish\", \"horse\", \"cow\", \"sheep\", \"rabbit\",\r\n  \r\n  // === RUIDO T√âCNICO CLIP / META-TAGS ===\r\n  \"image\", \"photo\", \"picture\", \"scene\", \"area\", \"space\", \"place\", \"location\",\r\n  \"background\", \"foreground\", \"blur\", \"bokeh\", \"focus\", \"lens\", \"filter\",\r\n  \"hd\", \"4k\", \"high resolution\", \"professional\", \"stock photo\",\r\n  \r\n  // === EDIFICIOS NO HOTELEROS ===\r\n  \"church\", \"cathedral\", \"mosque\", \"temple\", \"monument\", \"statue\", \r\n  \"apartment\", \"house\", \"home\", \"residence\", \"office\", \"store\", \"shop\", \"mall\", \r\n  \"supermarket\", \"hospital\", \"school\", \"university\", \"factory\", \"warehouse\",\r\n  \r\n  // === OBJETOS DOM√âSTICOS IRRELEVANTES PARA CLASIFICACI√ìN ===\r\n  // ‚úÖ NOTA: \"bottle\", \"glass\", \"plate\", \"cutlery\" se mueven a HOTEL_ESSENTIAL_TAGS\r\n  \"receipt\", \"newspaper\", \"magazine\", \"book\", \"pen\", \"pencil\",\r\n  \"clock\", \"calendar\", \"remote control\", \"charger\", \"cable\",\r\n  \r\n  // === PALABRAS GEN√âRICAS SIN VALOR SEM√ÅNTICO ===\r\n  \"thing\", \"object\", \"item\", \"stuff\", \"something\", \"anything\",\r\n  \"view\", \"sight\", \"scenery\", \"landscape\" // Solo si vienen solos sin contexto\r\n])\r\n\r\n// ‚úÖ WHITELIST: Elementos hoteleros que NUNCA deben bloquearse\r\n// Estos son cr√≠ticos para detectar amenities y experiencias hoteleras\r\nconst HOTEL_ESSENTIAL_TAGS = new Set([\r\n  // === GASTRONOM√çA (esenciales para restaurante/bar) ===\r\n  \"wine glass\", \"wineglass\", \"bottle\", \"plate\", \"cutlery\", \"fork\", \"knife\", \"spoon\",\r\n  \"cup\", \"glass\", \"bowl\", \"dish\", \"utensil\", \"napkin\", \"menu\", \"tray\",\r\n  \"coffee cup\", \"teacup\", \"champagne\", \"cocktail\", \"drink\", \"beverage\",\r\n  \r\n  // === EXTERIOR/PISCINA (esenciales para piscina/playa/jard√≠n) ===\r\n  \"umbrella\", \"sunbed\", \"lounger\", \"deck chair\", \"palm tree\", \"potted plant\", \r\n  \"garden\", \"tree\", \"sky\", \"cloud\", \"grass\", \"flower\", \"foliage\",\r\n  \"water\", \"pool\", \"fountain\", \"pathway\", \"stone\", \"wood\",\r\n  \r\n  // === HABITACIONES (esenciales para room/suite) ===\r\n  \"bed\", \"pillow\", \"blanket\", \"sheet\", \"towel\", \"robe\", \"slipper\",\r\n  \"tv\", \"lamp\", \"mirror\", \"curtain\", \"blind\", \"carpet\", \"rug\",\r\n  \"luggage\", \"suitcase\", \"bag\", \"hanger\", \"safe\", \"minibar\",\r\n  \r\n  // === BA√ëOS (esenciales para bathroom/spa) ===\r\n  \"bathtub\", \"shower\", \"sink\", \"toilet\", \"bidet\", \"soap\", \"shampoo\",\r\n  \"toothbrush\", \"razor\", \"hairdryer\", \"scale\", \"bathrobe\",\r\n  \r\n  // === ARQUITECTURA/DECORACI√ìN ===\r\n  \"building\", \"window\", \"door\", \"balcony\", \"terrace\", \"facade\",\r\n  \"chandelier\", \"painting\", \"sculpture\", \"vase\", \"candle\", \"art\",\r\n  \r\n  // === VISTAS/ENTORNO ===\r\n  \"sea\", \"ocean\", \"beach\", \"mountain\", \"valley\", \"forest\", \"lake\",\r\n  \"sunset\", \"sunrise\", \"horizon\", \"skyline\", \"panorama\"\r\n])\r\n\r\n// ============================================================\r\n// üéØ FUNCI√ìN PRINCIPAL ACTUALIZADA\r\n// ============================================================\r\n\r\nexport function normalizeTags(rawTags: any[], options?: NormalizeTagsOptions): string[] {\r\n  if (!Array.isArray(rawTags) || rawTags.length === 0) return []\r\n\r\n  // ============================================================\r\n  // 1Ô∏è‚É£ EXTRACCI√ìN Y LIMPIEZA INICIAL (con soporte de scores)\r\n  // ============================================================\r\n  \r\n  let tags: TagWithScore[] = []\r\n  const backendScores = options?.tags_confidence || {}\r\n  \r\n  for (const raw of rawTags) {\r\n    const label = extractTagValue(raw)?.toLowerCase().trim()\r\n    if (!label || label.length < 2) continue\r\n    \r\n    // Obtener score: prioridad backend > objeto > default\r\n    let score: number\r\n    if (backendScores[label] !== undefined) {\r\n      score = backendScores[label]\r\n    } else if (typeof raw === 'object' && raw.score !== undefined && typeof raw.score === 'number') {\r\n      score = raw.score\r\n    } else {\r\n      score = 0.5 // Score por defecto\r\n    }\r\n    \r\n    tags.push({ label, score })\r\n  }\r\n\r\n  if (tags.length === 0) return []\r\n\r\n  // ============================================================\r\n  // 2Ô∏è‚É£ FILTRADO POR CONFIDENCE (si backend proporciona scores)\r\n  // ============================================================\r\n  \r\n  const minConfidence = options?.min_confidence ?? 0.25\r\n  const preferBackend = options?.prefer_backend_scores ?? true\r\n  \r\n  if (Object.keys(backendScores).length > 0 && preferBackend) {\r\n    tags = tags.filter(t => t.score >= minConfidence)\r\n  }\r\n\r\n  // ============================================================\r\n  // 3Ô∏è‚É£ BLOCKLIST INTELIGENTE CON WHITELIST HOTELERA\r\n  // ============================================================\r\n  tags = tags.filter(tag => {\r\n    const label = tag.label\r\n    \r\n    // ‚úÖ PRIORIDAD 1: Si est√° en whitelist hotelera, NUNCA bloquear\r\n    if (HOTEL_ESSENTIAL_TAGS.has(label)) {\r\n      return true\r\n    }\r\n    \r\n    // ‚úÖ PRIORIDAD 2: Si est√° en blocklist, bloquear\r\n    if (BLOCKLIST.has(label)) {\r\n      return false\r\n    }\r\n    \r\n    // ‚úÖ PRIORIDAD 3: Filtro adicional para palabras gen√©ricas solas\r\n    // Solo bloquear \"view\", \"landscape\", etc. si vienen SIN contexto hotelero\r\n    const genericWithoutContext = ['view', 'sight', 'scenery', 'landscape']\r\n    if (genericWithoutContext.includes(label)) {\r\n      // Permitir si hay otros tags que dan contexto\r\n      const hasContext = tags.some(t => \r\n        t.label !== label && \r\n        (HOTEL_ESSENTIAL_TAGS.has(t.label) || t.label.length > 6)\r\n      )\r\n      return hasContext\r\n    }\r\n    \r\n    // ‚úÖ Por defecto: permitir\r\n    return true\r\n  })\r\n\r\n  // ============================================================\r\n  // 4Ô∏è‚É£ DETECCI√ìN DE CONTEXTO PRIMARIO\r\n  // ============================================================\r\n  \r\n  const tagLabels = tags.map(t => t.label)\r\n  \r\n  const hasPool = tagLabels.some(t => /pool|swimming|jacuzzi|lagoon|water.*surface/.test(t))\r\n  const hasBeach = tagLabels.some(t => /beach|shoreline|coast|sand|seaside/.test(t))\r\n  const hasRoom = tagLabels.some(t => \r\n    /room|suite|bedroom|king\\s+bed|queen\\s+bed|twin\\s+beds|double\\s+bed|bed\\s+side|nightstand/.test(t)\r\n  )\r\n  const hasRestaurant = tagLabels.some(t => \r\n    /restaurant|buffet|fine\\s+dining|gourmet|dining.*hall/i.test(t) && !hasRoom\r\n  )\r\n  const hasSpa = tagLabels.some(t => /spa|sauna|steam|massage|hammam|wellness/.test(t))\r\n  const hasGarden = tagLabels.some(t => /garden|landscaped|botanical|zen|courtyard|patio|lawn/.test(t))\r\n  \r\n  const hasBreakfastEvidence = tagLabels.some(t => \r\n    /breakfast|morning|food|plate|cup|cereal|croissant|small\\s+table|dining\\s+table|breakfast\\s+table|coffee|tea/.test(t)\r\n  )\r\n  const hasPoolEvidence = tagLabels.some(t => \r\n    /water|swim|sunbed|umbrella|lounge.*chair|deck|poolside|ripples|splash/.test(t)\r\n  )\r\n  \r\n  // Contexto desde backend (si est√° disponible)\r\n  const backendCategoria = options?.categoria_context\r\n  const backendUbicacion = options?.ubicacion_context\r\n\r\n  // ============================================================\r\n  // 5Ô∏è‚É£ MAPEO DE SIN√ìNIMOS CONTEXTO-AWARE\r\n  // ============================================================\r\n  const REPLACE_MAP: Record<string, string> = {}\r\n\r\n  // PISCINAS\r\n  REPLACE_MAP[\"swimming pool\"] = \"pool\"\r\n  REPLACE_MAP[\"outdoor pool\"] = \"pool\"\r\n  REPLACE_MAP[\"indoor pool\"] = \"indoor_pool\"\r\n  REPLACE_MAP[\"covered pool\"] = \"indoor_pool\"\r\n  REPLACE_MAP[\"heated pool\"] = \"heated_pool\"\r\n  REPLACE_MAP[\"thermal pool\"] = \"heated_pool\"\r\n  REPLACE_MAP[\"infinity pool\"] = \"infinity_pool\"\r\n  REPLACE_MAP[\"vanishing edge pool\"] = \"infinity_pool\"\r\n  REPLACE_MAP[\"lagoon pool\"] = \"lagoon_pool\"\r\n  REPLACE_MAP[\"natural pool\"] = \"lagoon_pool\"\r\n  REPLACE_MAP[\"resort pool\"] = \"pool\"\r\n  REPLACE_MAP[\"hotel pool\"] = \"pool\"\r\n  REPLACE_MAP[\"pool area\"] = \"pool\"\r\n  REPLACE_MAP[\"pool deck\"] = \"pool_deck\"\r\n  REPLACE_MAP[\"poolside\"] = \"pool\"\r\n  REPLACE_MAP[\"swim up bar\"] = \"pool_bar\"\r\n  REPLACE_MAP[\"jacuzzi\"] = \"jacuzzi\"\r\n  REPLACE_MAP[\"hot tub\"] = \"jacuzzi\"\r\n  REPLACE_MAP[\"whirlpool\"] = \"jacuzzi\"\r\n  REPLACE_MAP[\"kids pool\"] = \"kids_pool\"\r\n  REPLACE_MAP[\"children pool\"] = \"kids_pool\"\r\n  REPLACE_MAP[\"splash pad\"] = \"kids_pool\"\r\n  REPLACE_MAP[\"water play\"] = \"kids_pool\"\r\n\r\n  // CAMAS (contexto-aware)\r\n  const effectiveHasRoom = hasRoom || backendCategoria === 'habitacion'\r\n  if (effectiveHasRoom) {\r\n    REPLACE_MAP[\"bed\"] = \"bed\"\r\n    REPLACE_MAP[\"twin beds\"] = \"twin_beds\"\r\n    REPLACE_MAP[\"king bed\"] = \"king_bed\"\r\n    REPLACE_MAP[\"queen bed\"] = \"queen_bed\"\r\n    REPLACE_MAP[\"double bed\"] = \"double_bed\"\r\n    REPLACE_MAP[\"single bed\"] = \"single_bed\"\r\n  } else {\r\n    REPLACE_MAP[\"bed\"] = \"\"\r\n    REPLACE_MAP[\"twin beds\"] = \"\"\r\n    REPLACE_MAP[\"king bed\"] = \"\"\r\n    REPLACE_MAP[\"queen bed\"] = \"\"\r\n  }\r\n\r\n  // SILLAS (contexto-aware)\r\n  const effectiveHasPool = hasPool || backendCategoria === 'piscina'\r\n  const effectiveHasBeach = hasBeach || backendCategoria === 'playa'\r\n  const effectiveHasRestaurant = hasRestaurant || backendCategoria === 'restaurante'\r\n  \r\n  if (effectiveHasPool || effectiveHasBeach) {\r\n    REPLACE_MAP[\"sun lounger\"] = \"sunbed\"\r\n    REPLACE_MAP[\"sun loungers\"] = \"sunbed\"\r\n    REPLACE_MAP[\"lounge chair\"] = \"sunbed\"\r\n    REPLACE_MAP[\"deck chair\"] = \"sunbed\"\r\n    REPLACE_MAP[\"chair\"] = \"sunbed\"\r\n    REPLACE_MAP[\"chairs\"] = \"sunbed\"\r\n  } else if (effectiveHasRestaurant) {\r\n    REPLACE_MAP[\"chair\"] = \"chair\"\r\n    REPLACE_MAP[\"chairs\"] = \"chair\"\r\n    REPLACE_MAP[\"lounge chair\"] = \"chair\"\r\n    REPLACE_MAP[\"deck chair\"] = \"chair\"\r\n  } else if (effectiveHasRoom) {\r\n    REPLACE_MAP[\"chair\"] = \"chair\"\r\n    REPLACE_MAP[\"chairs\"] = \"chair\"\r\n    REPLACE_MAP[\"lounge chair\"] = \"chair\"\r\n    REPLACE_MAP[\"deck chair\"] = \"chair\"\r\n  } else {\r\n    REPLACE_MAP[\"chair\"] = \"\"\r\n    REPLACE_MAP[\"chairs\"] = \"\"\r\n  }\r\n\r\n  // GASTRONOM√çA (contexto-aware)\r\n  if (effectiveHasRoom && hasBreakfastEvidence) {\r\n    REPLACE_MAP[\"dining area\"] = \"dining_area\"\r\n    REPLACE_MAP[\"dining room\"] = \"dining_area\"\r\n    REPLACE_MAP[\"dining space\"] = \"dining_area\"\r\n    REPLACE_MAP[\"breakfast area\"] = \"breakfast_area\"\r\n    REPLACE_MAP[\"breakfast room\"] = \"breakfast_area\"\r\n  } else if (effectiveHasRoom && !hasBreakfastEvidence && backendCategoria !== 'restaurante') {\r\n    REPLACE_MAP[\"dining room\"] = \"room\"\r\n    REPLACE_MAP[\"dining area\"] = \"room\"\r\n    REPLACE_MAP[\"dining space\"] = \"room\"\r\n    REPLACE_MAP[\"breakfast area\"] = \"room\"\r\n    REPLACE_MAP[\"breakfast room\"] = \"room\"\r\n  } else {\r\n    REPLACE_MAP[\"dining area\"] = \"restaurant\"\r\n    REPLACE_MAP[\"dining room\"] = \"restaurant\"\r\n    REPLACE_MAP[\"dining space\"] = \"restaurant\"\r\n    REPLACE_MAP[\"fine dining\"] = \"restaurant\"\r\n    REPLACE_MAP[\"gourmet restaurant\"] = \"restaurant\"\r\n    REPLACE_MAP[\"main restaurant\"] = \"restaurant\"\r\n    REPLACE_MAP[\"breakfast area\"] = \"restaurant\"\r\n    REPLACE_MAP[\"breakfast room\"] = \"restaurant\"\r\n    REPLACE_MAP[\"buffet area\"] = \"buffet\"\r\n    REPLACE_MAP[\"buffet station\"] = \"buffet\"\r\n    REPLACE_MAP[\"international buffet\"] = \"buffet\"\r\n  }\r\n  \r\n  // Bares\r\n  REPLACE_MAP[\"lobby bar\"] = \"bar\"\r\n  REPLACE_MAP[\"lounge bar\"] = \"bar\"\r\n  REPLACE_MAP[\"cocktail bar\"] = \"bar\"\r\n  REPLACE_MAP[\"wine bar\"] = \"wine_bar\"\r\n  REPLACE_MAP[\"wine cellar\"] = \"wine_cellar\"\r\n  REPLACE_MAP[\"rooftop bar\"] = \"rooftop_bar\"\r\n  REPLACE_MAP[\"sky bar\"] = \"rooftop_bar\"\r\n  REPLACE_MAP[\"sunset bar\"] = \"rooftop_bar\"\r\n  REPLACE_MAP[\"pool bar\"] = \"pool_bar\"\r\n  REPLACE_MAP[\"swim up bar\"] = \"pool_bar\"\r\n  REPLACE_MAP[\"beach bar\"] = \"beach_bar\"\r\n  REPLACE_MAP[\"cafe\"] = \"cafe\"\r\n  REPLACE_MAP[\"coffee shop\"] = \"cafe\"\r\n  REPLACE_MAP[\"pastry shop\"] = \"cafe\"\r\n\r\n  // HABITACIONES\r\n  REPLACE_MAP[\"hotel room\"] = \"room\"\r\n  REPLACE_MAP[\"guest room\"] = \"room\"\r\n  REPLACE_MAP[\"bedroom\"] = \"room\"\r\n  REPLACE_MAP[\"double room\"] = \"room\"\r\n  REPLACE_MAP[\"twin room\"] = \"twin_beds\"\r\n  REPLACE_MAP[\"single room\"] = \"room\"\r\n  REPLACE_MAP[\"standard room\"] = \"room\"\r\n  REPLACE_MAP[\"superior room\"] = \"superior_room\"\r\n  REPLACE_MAP[\"deluxe room\"] = \"superior_room\"\r\n  REPLACE_MAP[\"premium room\"] = \"superior_room\"\r\n  REPLACE_MAP[\"suite\"] = \"suite\"\r\n  REPLACE_MAP[\"junior suite\"] = \"junior_suite\"\r\n  REPLACE_MAP[\"executive suite\"] = \"suite\"\r\n  REPLACE_MAP[\"presidential suite\"] = \"presidential_suite\"\r\n  REPLACE_MAP[\"honeymoon suite\"] = \"honeymoon_suite\"\r\n  REPLACE_MAP[\"family suite\"] = \"family_suite\"\r\n  REPLACE_MAP[\"king size bed\"] = \"king_bed\"\r\n  REPLACE_MAP[\"king bed\"] = \"king_bed\"\r\n  REPLACE_MAP[\"queen size bed\"] = \"queen_bed\"\r\n  REPLACE_MAP[\"queen bed\"] = \"queen_bed\"\r\n  REPLACE_MAP[\"twin beds\"] = \"twin_beds\"\r\n  REPLACE_MAP[\"double bed\"] = \"double_bed\"\r\n  REPLACE_MAP[\"canopy bed\"] = \"canopy_bed\"\r\n  REPLACE_MAP[\"four poster bed\"] = \"canopy_bed\"\r\n  REPLACE_MAP[\"balcony\"] = \"balcony\"\r\n  REPLACE_MAP[\"private balcony\"] = \"balcony\"\r\n  REPLACE_MAP[\"terrace\"] = \"terrace\"\r\n  REPLACE_MAP[\"private terrace\"] = \"private_terrace\"\r\n  REPLACE_MAP[\"rooftop terrace\"] = \"rooftop_terrace\"\r\n  REPLACE_MAP[\"veranda\"] = \"terrace\"\r\n\r\n  // BA√ëOS\r\n  REPLACE_MAP[\"bathroom\"] = \"bathroom\"\r\n  REPLACE_MAP[\"ensuite bathroom\"] = \"bathroom\"\r\n  REPLACE_MAP[\"private bathroom\"] = \"bathroom\"\r\n  REPLACE_MAP[\"shower\"] = \"shower\"\r\n  REPLACE_MAP[\"walk in shower\"] = \"rain_shower\"\r\n  REPLACE_MAP[\"bathtub\"] = \"bathtub\"\r\n  REPLACE_MAP[\"freestanding tub\"] = \"freestanding_tub\"\r\n  REPLACE_MAP[\"clawfoot tub\"] = \"freestanding_tub\"\r\n  REPLACE_MAP[\"double vanity\"] = \"double_vanity\"\r\n  REPLACE_MAP[\"his and hers sinks\"] = \"double_vanity\"\r\n  REPLACE_MAP[\"bidet\"] = \"bidet\"\r\n  REPLACE_MAP[\"heated floors\"] = \"heated_floors\"\r\n  REPLACE_MAP[\"underfloor heating\"] = \"heated_floors\"\r\n  REPLACE_MAP[\"spa bathroom\"] = \"luxury_bathroom\"\r\n  REPLACE_MAP[\"marble bathroom\"] = \"luxury_bathroom\"\r\n  \r\n  // EXTERIOR\r\n  REPLACE_MAP[\"facade\"] = \"facade\"\r\n  REPLACE_MAP[\"front facade\"] = \"facade\"\r\n  REPLACE_MAP[\"building front\"] = \"facade\"\r\n  REPLACE_MAP[\"entrance\"] = \"entrance\"\r\n  REPLACE_MAP[\"main entrance\"] = \"entrance\"\r\n  REPLACE_MAP[\"porte cochere\"] = \"entrance\"\r\n  REPLACE_MAP[\"valet\"] = \"entrance\"\r\n  REPLACE_MAP[\"garden\"] = \"garden\"\r\n  REPLACE_MAP[\"landscaped garden\"] = \"garden\"\r\n  REPLACE_MAP[\"botanical garden\"] = \"botanical_garden\"\r\n  REPLACE_MAP[\"zen garden\"] = \"zen_garden\"\r\n  REPLACE_MAP[\"courtyard\"] = \"courtyard\"\r\n  REPLACE_MAP[\"patio\"] = \"courtyard\"\r\n  REPLACE_MAP[\"lawn\"] = \"garden\"\r\n  REPLACE_MAP[\"flower bed\"] = \"garden\"\r\n  REPLACE_MAP[\"greenery\"] = \"garden\"\r\n  REPLACE_MAP[\"palm tree\"] = \"palm_tree\"\r\n  REPLACE_MAP[\"palm trees\"] = \"palm_tree\"\r\n  REPLACE_MAP[\"beach\"] = \"beach\"\r\n  REPLACE_MAP[\"beach access\"] = \"beach_access\"\r\n  REPLACE_MAP[\"private beach\"] = \"private_beach\"\r\n  REPLACE_MAP[\"shoreline\"] = \"beach\"\r\n  REPLACE_MAP[\"coast\"] = \"beach\"\r\n  REPLACE_MAP[\"mountain\"] = \"mountain\"\r\n  REPLACE_MAP[\"hillside\"] = \"mountain\"\r\n  \r\n  // VISTAS\r\n  REPLACE_MAP[\"view\"] = \"view\"\r\n  REPLACE_MAP[\"sea view\"] = \"sea_view\"\r\n  REPLACE_MAP[\"ocean view\"] = \"sea_view\"\r\n  REPLACE_MAP[\"beach view\"] = \"sea_view\"\r\n  REPLACE_MAP[\"city view\"] = \"city_view\"\r\n  REPLACE_MAP[\"urban view\"] = \"city_view\"\r\n  REPLACE_MAP[\"skyline\"] = \"city_view\"\r\n  REPLACE_MAP[\"cityscape\"] = \"city_view\"\r\n  REPLACE_MAP[\"mountain view\"] = \"mountain_view\"\r\n  REPLACE_MAP[\"valley view\"] = \"valley_view\"\r\n  REPLACE_MAP[\"garden view\"] = \"garden_view\"\r\n  REPLACE_MAP[\"pool view\"] = \"pool_view\"\r\n  REPLACE_MAP[\"panoramic view\"] = \"panoramic_view\"\r\n  REPLACE_MAP[\"sunset view\"] = \"sunset_view\"\r\n  REPLACE_MAP[\"horizon\"] = \"panoramic_view\"\r\n  \r\n  // ZONAS COMUNES\r\n  REPLACE_MAP[\"lobby\"] = \"lobby\"\r\n  REPLACE_MAP[\"reception area\"] = \"lobby\"\r\n  REPLACE_MAP[\"entrance hall\"] = \"lobby\"\r\n  REPLACE_MAP[\"grand lobby\"] = \"grand_lobby\"\r\n  REPLACE_MAP[\"atrium\"] = \"grand_lobby\"\r\n  REPLACE_MAP[\"lounge\"] = \"lounge\"\r\n  REPLACE_MAP[\"seating area\"] = \"lounge\"\r\n  REPLACE_MAP[\"common area\"] = \"lounge\"\r\n  REPLACE_MAP[\"living room\"] = \"lounge\"\r\n  REPLACE_MAP[\"library\"] = \"library\"\r\n  REPLACE_MAP[\"reading room\"] = \"library\"\r\n  REPLACE_MAP[\"fireplace\"] = \"fireplace\"\r\n  REPLACE_MAP[\"chimney\"] = \"fireplace\"\r\n  REPLACE_MAP[\"game room\"] = \"game_room\"\r\n  REPLACE_MAP[\"billiards\"] = \"game_room\"\r\n  \r\n  // EVENTOS\r\n  REPLACE_MAP[\"conference room\"] = \"conference_room\"\r\n  REPLACE_MAP[\"meeting room\"] = \"conference_room\"\r\n  REPLACE_MAP[\"boardroom\"] = \"conference_room\"\r\n  REPLACE_MAP[\"ballroom\"] = \"ballroom\"\r\n  REPLACE_MAP[\"banquet hall\"] = \"ballroom\"\r\n  REPLACE_MAP[\"event space\"] = \"ballroom\"\r\n  REPLACE_MAP[\"function room\"] = \"ballroom\"\r\n  REPLACE_MAP[\"wedding\"] = \"wedding_venue\"\r\n  REPLACE_MAP[\"ceremony space\"] = \"wedding_venue\"\r\n  REPLACE_MAP[\"chapel\"] = \"chapel\"\r\n  \r\n  // ESTILO\r\n  REPLACE_MAP[\"luxury\"] = \"luxury\"\r\n  REPLACE_MAP[\"luxurious\"] = \"luxury\"\r\n  REPLACE_MAP[\"premium\"] = \"luxury\"\r\n  REPLACE_MAP[\"high end\"] = \"luxury\"\r\n  REPLACE_MAP[\"exclusive\"] = \"luxury\"\r\n  REPLACE_MAP[\"boutique\"] = \"boutique\"\r\n  REPLACE_MAP[\"modern\"] = \"modern\"\r\n  REPLACE_MAP[\"contemporary\"] = \"modern\"\r\n  REPLACE_MAP[\"minimalist\"] = \"minimalist\"\r\n  REPLACE_MAP[\"elegant\"] = \"elegant\"\r\n  REPLACE_MAP[\"sophisticated\"] = \"elegant\"\r\n  REPLACE_MAP[\"classic\"] = \"classic\"\r\n  REPLACE_MAP[\"traditional\"] = \"classic\"\r\n  REPLACE_MAP[\"rustic\"] = \"rustic\"\r\n  REPLACE_MAP[\"mediterranean\"] = \"mediterranean\"\r\n\r\n  // Aplicar mapeos (filtrar strings vac√≠os)\r\n  tags = tags\r\n    .map(t => ({ ...t, label: REPLACE_MAP[t.label] || t.label }))\r\n    .filter(t => t.label && t.label.length >= 2)\r\n\r\n  // ============================================================\r\n  // 6Ô∏è‚É£ MAPEO YOLO ‚Üí ESCENAS SEM√ÅNTICAS (simplificado)\r\n  // ============================================================\r\n  \r\n  const expandedTags: TagWithScore[] = []\r\n  \r\n  for (const tag of tags) {\r\n    const expansions = getYOLOExpansions(tag.label, {\r\n      hasPool: effectiveHasPool,\r\n      hasBeach: effectiveHasBeach,\r\n      hasRoom: effectiveHasRoom,\r\n      hasRestaurant: effectiveHasRestaurant,\r\n      hasBreakfastEvidence\r\n    })\r\n    \r\n    if (expansions.length > 0) {\r\n      expansions.forEach((exp, idx) => {\r\n        expandedTags.push({\r\n          label: exp,\r\n          score: tag.score * (idx === 0 ? 1 : 0.8)\r\n        })\r\n      })\r\n    } else {\r\n      expandedTags.push(tag)\r\n    }\r\n  }\r\n  tags = expandedTags.filter(t => t.label && t.label.length >= 2)\r\n\r\n  // ============================================================\r\n  // 7Ô∏è‚É£ CORRECCIONES CONTEXTUALES INTELIGENTES\r\n  // ============================================================\r\n\r\n  let currentLabels = tags.map(t => t.label)\r\n\r\n  // Regla 1: Piscina infinita\r\n  if (currentLabels.includes(\"pool\") && currentLabels.some(l => [\"vanishing\", \"edge\", \"horizon\"].includes(l))) {\r\n    tags = tags.filter(t => t.label !== \"pool\")\r\n    tags.push({ label: \"infinity_pool\", score: 0.9 })\r\n  }\r\n\r\n  // Regla 2: Piscina + sillas ‚Üí sunbeds\r\n  if ((effectiveHasPool || effectiveHasBeach) && currentLabels.some(l => [\"chair\", \"chairs\", \"lounge chair\"].includes(l))) {\r\n    tags = tags.filter(t => ![\"chair\", \"chairs\", \"lounge chair\"].includes(t.label))\r\n    tags.push({ label: \"sunbed\", score: 0.85 })\r\n  }\r\n\r\n  // Regla 3: Eliminar \"indoor\" si es piscina exterior\r\n  if (currentLabels.includes(\"pool\") && !currentLabels.includes(\"indoor_pool\") && currentLabels.includes(\"indoor\")) {\r\n    tags = tags.filter(t => t.label !== \"indoor\")\r\n  }\r\n\r\n  // Regla 4: Habitaci√≥n con balc√≥n ‚Üí vista\r\n  if (currentLabels.includes(\"room\") && currentLabels.some(l => [\"balcony\", \"terrace\"].includes(l)) && currentLabels.includes(\"view\")) {\r\n    if (!currentLabels.includes(\"room_with_view\")) {\r\n      tags.push({ label: \"room_with_view\", score: 0.7 })\r\n    }\r\n  }\r\n\r\n  // Regla 5: Spa complejo\r\n  if (currentLabels.includes(\"spa\") && currentLabels.some(l => [\"sauna\", \"steam_room\"].includes(l))) {\r\n    if (!currentLabels.includes(\"wellness_complex\")) {\r\n      tags.push({ label: \"wellness_complex\", score: 0.8 })\r\n    }\r\n  }\r\n\r\n  // Regla 6: Restaurante exterior\r\n  if (currentLabels.includes(\"restaurant\") && currentLabels.some(l => [\"terrace\", \"rooftop\"].includes(l))) {\r\n    tags = tags.filter(t => t.label !== \"restaurant\")\r\n    tags.push({ label: \"outdoor_dining\", score: 0.85 })\r\n  }\r\n\r\n  // Regla 7: Acceso a playa\r\n  if (currentLabels.includes(\"exterior\") && currentLabels.some(l => [\"sea\", \"ocean\"].includes(l))) {\r\n    if (!currentLabels.includes(\"beach_access\")) {\r\n      tags.push({ label: \"beach_access\", score: 0.75 })\r\n    }\r\n  }\r\n\r\n  // Regla 8: Ba√±o de lujo\r\n  if (currentLabels.includes(\"bathroom\") && currentLabels.includes(\"freestanding_tub\")) {\r\n    if (!currentLabels.includes(\"luxury_bathroom\")) {\r\n      tags.push({ label: \"luxury_bathroom\", score: 0.9 })\r\n    }\r\n  }\r\n\r\n  // Regla 9: Suite premium\r\n  if (currentLabels.includes(\"suite\") && currentLabels.includes(\"king_bed\") && currentLabels.includes(\"balcony\")) {\r\n    if (!currentLabels.includes(\"premium_suite\")) {\r\n      tags.push({ label: \"premium_suite\", score: 0.95 })\r\n    }\r\n  }\r\n\r\n  // Regla 10: Atm√≥sfera premium\r\n  const hasTimeContext = currentLabels.some(l => [\"sunset\", \"sunrise\", \"dawn\", \"dusk\", \"golden hour\"].includes(l))\r\n  const hasPremiumArea = currentLabels.some(l => [\"pool\", \"infinity_pool\", \"sea_view\", \"panoramic_view\"].includes(l))\r\n  if (hasTimeContext && hasPremiumArea && !currentLabels.includes(\"premium_atmosphere\")) {\r\n    tags.push({ label: \"premium_atmosphere\", score: 0.8 })\r\n  }\r\n\r\n  // Regla 11: Eliminar room si hay piscina sin cama\r\n  if (currentLabels.includes(\"pool\") && !currentLabels.some(l => [\"bed\", \"king_bed\", \"queen_bed\", \"twin_beds\"].includes(l))) {\r\n    tags = tags.filter(t => t.label !== \"room\")\r\n  }\r\n\r\n  // Regla 12: Jard√≠n tropical\r\n  if (currentLabels.includes(\"garden\") && currentLabels.includes(\"palm_tree\") && !currentLabels.includes(\"tropical_garden\")) {\r\n    tags.push({ label: \"tropical_garden\", score: 0.85 })\r\n  }\r\n\r\n  // Regla 13: Lobby acogedor\r\n  if (currentLabels.includes(\"lobby\") && currentLabels.includes(\"fireplace\") && !currentLabels.includes(\"cozy_lobby\")) {\r\n    tags.push({ label: \"cozy_lobby\", score: 0.8 })\r\n  }\r\n\r\n  // Regla 14: Desayuno buffet\r\n  if (currentLabels.includes(\"buffet\") && currentLabels.some(l => [\"breakfast\", \"morning\"].includes(l)) && !currentLabels.includes(\"breakfast_buffet\")) {\r\n    tags.push({ label: \"breakfast_buffet\", score: 0.9 })\r\n  }\r\n\r\n  // Regla 15: Eliminar contradicciones\r\n  if (currentLabels.includes(\"indoor_pool\") && currentLabels.includes(\"outdoor\")) {\r\n    tags = tags.filter(t => t.label !== \"outdoor\")\r\n  }\r\n\r\n  // Regla 16: Eliminar pool falso en habitaciones\r\n  const backendSaysPool = backendCategoria === 'piscina'\r\n  if (currentLabels.includes(\"room\") && currentLabels.includes(\"pool\") && !hasPoolEvidence && !backendSaysPool) {\r\n    tags = tags.filter(t => t.label !== \"pool\")\r\n  }\r\n\r\n  // Regla 17: Eliminar dining_area falso en habitaciones\r\n  const backendSaysRestaurant = backendCategoria === 'restaurante'\r\n  if (currentLabels.includes(\"room\") && currentLabels.includes(\"dining_area\") && !hasBreakfastEvidence && !backendSaysRestaurant) {\r\n    tags = tags.filter(t => t.label !== \"dining_area\")\r\n  }\r\n\r\n  // Regla 18: Reforzar twin_beds\r\n  if (currentLabels.includes(\"twin_beds\") && currentLabels.includes(\"room\") && !hasBreakfastEvidence && !backendSaysRestaurant) {\r\n    tags = tags.filter(t => t.label !== \"dining_area\")\r\n  }\r\n\r\n  // Regla 19: Reforzar tags seg√∫n categor√≠a backend\r\n  if (backendCategoria && backendCategoria !== 'otros') {\r\n    const categoryBoostTags: Record<string, string[]> = {\r\n      piscina: [\"pool\", \"water\", \"sunbed\", \"umbrella\", \"deck\"],\r\n      habitacion: [\"room\", \"bed\", \"pillow\", \"nightstand\", \"balcony\"],\r\n      restaurante: [\"restaurant\", \"table\", \"chair\", \"plate\", \"buffet\"],\r\n      spa: [\"spa\", \"massage\", \"towel\", \"relax\", \"wellness\"],\r\n      playa: [\"beach\", \"sand\", \"sea\", \"ocean\", \"shoreline\"]\r\n    }\r\n    \r\n    const boostList = categoryBoostTags[backendCategoria] || []\r\n    tags = tags.map(t => {\r\n      if (boostList.includes(t.label) && t.score < 0.7) {\r\n        return { ...t, score: Math.min(t.score + 0.15, 0.95) }\r\n      }\r\n      return t\r\n    })\r\n  }\r\n\r\n  // ============================================================\r\n  // 8Ô∏è‚É£ SINGULARIZACI√ìN ROBUSTA\r\n  // ============================================================\r\n  const IRREGULAR_PLURALS: Record<string, string> = {\r\n    \"people\": \"person\", \"children\": \"child\", \"men\": \"man\", \"women\": \"woman\",\r\n    \"feet\": \"foot\", \"teeth\": \"tooth\", \"geese\": \"goose\", \"mice\": \"mouse\", \"lice\": \"louse\",\r\n  }\r\n\r\n  tags = tags.map(tag => {\r\n    if (IRREGULAR_PLURALS[tag.label]) {\r\n      return { ...tag, label: IRREGULAR_PLURALS[tag.label] }\r\n    }\r\n    if (tag.label.endsWith(\"s\") && tag.label.length > 3 && !tag.label.endsWith(\"ss\")) {\r\n      return { ...tag, label: tag.label.replace(/s$/, \"\") }\r\n    }\r\n    return tag\r\n  })\r\n\r\n  // ============================================================\r\n  // 9Ô∏è‚É£ DEDUPLICACI√ìN Y ORDENAMIENTO FINAL\r\n  // ============================================================\r\n  const PRIORITY_ORDER = [\r\n    \"infinity_pool\", \"presidential_suite\", \"private_beach\", \"panoramic_view\", \"sea_view\",\r\n    \"luxury_bathroom\", \"freestanding_tub\", \"rain_shower\", \"premium_suite\", \"honeymoon_suite\",\r\n    \"rooftop_bar\", \"rooftop_terrace\", \"botanical_garden\", \"zen_garden\", \"wellness_complex\",\r\n    \"pool\", \"indoor_pool\", \"heated_pool\", \"lagoon_pool\", \"jacuzzi\", \"kids_pool\",\r\n    \"suite\", \"junior_suite\", \"superior_room\", \"king_bed\", \"queen_bed\", \"twin_beds\", \"double_bed\", \"balcony\", \"private_terrace\",\r\n    \"spa\", \"sauna\", \"steam_room\", \"relaxation_area\", \"gym\", \"yoga_room\",\r\n    \"restaurant\", \"buffet\", \"bar\", \"wine_bar\", \"pool_bar\", \"cafe\", \"dining_area\", \"breakfast_area\",\r\n    \"garden\", \"courtyard\", \"beach_access\", \"mountain_view\", \"city_view\",\r\n    \"lobby\", \"grand_lobby\", \"lounge\", \"library\", \"fireplace\",\r\n    \"conference_room\", \"ballroom\", \"wedding_venue\",\r\n    \"room\", \"bathroom\", \"shower\", \"bathtub\", \"terrace\", \"exterior\", \"view\", \"modern\", \"luxury\"\r\n  ]\r\n\r\n  // Eliminar redundancias\r\n  const hasPremiumPool = tags.some(t => [\"infinity_pool\", \"lagoon_pool\", \"heated_pool\"].includes(t.label))\r\n  if (hasPremiumPool) tags = tags.filter(t => t.label !== \"pool\")\r\n\r\n  const hasSuite = tags.some(t => [\"suite\", \"junior_suite\", \"presidential_suite\"].includes(t.label))\r\n  if (hasSuite) tags = tags.filter(t => t.label !== \"room\")\r\n\r\n  const hasSpaComplex = tags.some(t => [\"spa\", \"sauna\", \"steam_room\"].includes(t.label))\r\n  if (hasSpaComplex) tags = tags.filter(t => t.label !== \"wellness\")\r\n\r\n  // Deduplicar manteniendo score m√°s alto\r\n  const deduped = new Map<string, TagWithScore>()\r\n  for (const tag of tags) {\r\n    const existing = deduped.get(tag.label)\r\n    if (!existing || tag.score > existing.score) {\r\n      deduped.set(tag.label, tag)\r\n    }\r\n  }\r\n\r\n  // Filtrar, limpiar y ordenar\r\n  const finalTags = Array.from(deduped.values())\r\n    .map(t => t.label.replace(/[^a-z0-9_]/g, \"_\"))\r\n    .filter(tag => tag.length >= 2 && !/^\\d+$/.test(tag) && !tag.startsWith(\"http\"))\r\n    .filter((tag, idx, arr) => arr.indexOf(tag) === idx)\r\n    .sort((a, b) => {\r\n      const aIdx = PRIORITY_ORDER.indexOf(a)\r\n      const bIdx = PRIORITY_ORDER.indexOf(b)\r\n      if (aIdx === -1 && bIdx === -1) return 0\r\n      if (aIdx === -1) return 1\r\n      if (bIdx === -1) return -1\r\n      return aIdx - bIdx\r\n    })\r\n\r\n  return finalTags\r\n}\r\n\r\n// ============================================================\r\n// üîß FUNCIONES AUXILIARES\r\n// ============================================================\r\n\r\nfunction extractTagValue(tag: any): string | null {\r\n  if (!tag) return null\r\n  if (typeof tag === \"object\") {\r\n    if (tag.label) return String(tag.label)\r\n    if (tag.text) return String(tag.text)\r\n    if (tag.name) return String(tag.name)\r\n    if (tag.className) return String(tag.className)\r\n  }\r\n  if (typeof tag === \"string\") return tag\r\n  if (Array.isArray(tag)) return tag.map(extractTagValue).filter(Boolean).join(\" \")\r\n  if (typeof tag === \"number\" || typeof tag === \"boolean\") return String(tag)\r\n  return null\r\n}\r\n\r\n/**\r\n * Obtiene expansiones YOLO seg√∫n contexto (funci√≥n helper interna)\r\n */\r\nfunction getYOLOExpansions(tag: string, context: {\r\n  hasPool: boolean\r\n  hasBeach: boolean\r\n  hasRoom: boolean\r\n  hasRestaurant: boolean\r\n  hasBreakfastEvidence: boolean\r\n}): string[] {\r\n  const { hasPool, hasBeach, hasRoom, hasRestaurant, hasBreakfastEvidence } = context\r\n  \r\n  const expansions: Record<string, string[]> = {\r\n    \"sunbed\": (hasPool || hasBeach) ? [\"pool\", \"sunbed\"] : [],\r\n    \"lounge chair\": (hasPool || hasBeach) ? [\"pool\", \"sunbed\"] : [],\r\n    \"deck chair\": (hasPool || hasBeach) ? [\"pool\", \"sunbed\"] : [],\r\n    \"umbrella\": (hasPool || hasBeach) ? [\"pool\", \"umbrella\"] : [],\r\n    \"parasol\": (hasPool || hasBeach) ? [\"pool\", \"umbrella\"] : [],\r\n    \"balinese bed\": (hasPool || hasBeach) ? [\"pool\", \"balinese_bed\"] : [],\r\n    \"cabana\": (hasPool || hasBeach) ? [\"pool\", \"cabana\"] : [],\r\n    \"daybed\": (hasPool || hasBeach) ? [\"pool\", \"balinese_bed\"] : [],\r\n    \"bed\": hasRoom ? [\"room\", \"bed\"] : [],\r\n    \"king bed\": hasRoom ? [\"room\", \"king_bed\"] : [],\r\n    \"queen bed\": hasRoom ? [\"room\", \"queen_bed\"] : [],\r\n    \"twin beds\": hasRoom ? [\"room\", \"twin_beds\"] : [],\r\n    \"sofa\": [\"lounge\"],\r\n    \"armchair\": [\"lounge\"],\r\n    \"desk\": [\"room\", \"workspace\"],\r\n    \"dining table\": hasRestaurant ? [\"restaurant\"] : (hasRoom && hasBreakfastEvidence ? [\"dining_area\"] : [\"table\"]),\r\n    \"palm tree\": [\"exterior\", \"garden\"],\r\n    \"tree\": [\"garden\"],\r\n    \"plant\": [\"garden\"],\r\n    \"fountain\": [\"garden\"],\r\n    \"fire pit\": [\"exterior\", \"fire_pit\"],\r\n    \"bbq\": [\"exterior\", \"bbq_area\"],\r\n    \"hammock\": [\"exterior\", \"hammock\"],\r\n    \"bathtub\": [\"bathroom\", \"bathtub\"],\r\n    \"shower\": [\"bathroom\", \"shower\"],\r\n    \"towel\": [\"bathroom\", \"spa\"],\r\n    \"bar counter\": [\"bar\"],\r\n    \"wine glass\": [\"bar\", \"wine_bar\"],\r\n    \"cocktail\": [\"bar\"],\r\n  }\r\n  \r\n  return expansions[tag] || []\r\n}\r\n\r\nexport function areTagsHotelRelevant(tags: string[]): boolean {\r\n  const HOTEL_KEYWORDS = [\r\n    \"pool\", \"room\", \"suite\", \"spa\", \"restaurant\", \"bar\", \"lobby\", \"garden\", \"beach\", \r\n    \"terrace\", \"balcony\", \"bathroom\", \"view\", \"luxury\", \"hotel\", \"resort\", \"twin_beds\"\r\n  ]\r\n  return tags.some(tag => HOTEL_KEYWORDS.includes(tag))\r\n}\r\n\r\nexport function extractHighConfidenceTags(rawTags: any[], minScore = 0.7): string[] {\r\n  return rawTags\r\n    .filter(t => typeof t === \"object\" && typeof t.score === \"number\" && t.score >= minScore)\r\n    .map(t => t.label || t.text || \"\")\r\n    .filter(Boolean)\r\n}\r\n\r\n/**\r\n * Versi√≥n ligera sin logging para producci√≥n\r\n */\r\nexport function normalizeTagsSilent(rawTags: any[], options?: NormalizeTagsOptions): string[] {\r\n  const originalLog = console.log\r\n  console.log = () => {}\r\n  try {\r\n    return normalizeTags(rawTags, options)\r\n  } finally {\r\n    console.log = originalLog\r\n  }\r\n}"],"names":[],"mappings":"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"}},
    {"offset": {"line": 2645, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/achra/proyectos/app-hotel-nueva/src/lib/extractAmenities.ts"],"sourcesContent":["// src/lib/extractAmenities.ts\r\n\r\n/**\r\n * üîç Sistema avanzado de extracci√≥n de amenities hoteleros (versi√≥n corregida)\r\n * \r\n * ‚úÖ FIX: A√±adida propiedad 'amenities' a la interfaz AmenitiesExtraction\r\n */\r\n\r\nexport interface Amenity {\r\n  id: string\r\n  name: string\r\n  category: AmenityCategory\r\n  confidence: \"high\" | \"medium\" | \"low\"\r\n  indicators: string[]\r\n  isPremium: boolean\r\n}\r\n\r\nexport type AmenityCategory =\r\n  | \"pool\" | \"wellness\" | \"dining\" | \"room\" | \"bathroom\"\r\n  | \"outdoor\" | \"common_areas\" | \"business\" | \"family\"\r\n  | \"accessibility\" | \"sustainability\" | \"views\" | \"atmosphere\" | \"premium\"\r\n\r\nexport interface AmenitiesExtraction {\r\n  // ‚úÖ NUEVO: Array completo de amenities detectados (para searchAmenities)\r\n  amenities: Amenity[]\r\n  \r\n  // Amenities estructurados por categor√≠a\r\n  byCategory: Record<AmenityCategory, Amenity[]>\r\n  \r\n  // Amenities premium destacados\r\n  premium: Amenity[]\r\n  \r\n  // Array plano para compatibilidad\r\n  flat: string[]\r\n  \r\n  // Flags t√©cnicos\r\n  hasPool: boolean\r\n  hasSpa: boolean\r\n  hasRestaurant: boolean\r\n  hasBar: boolean\r\n  hasSeaView: boolean\r\n  isLuxury: boolean\r\n  isBoutique: boolean\r\n  isFamilyFriendly: boolean\r\n  isBusinessReady: boolean\r\n  isWellnessOriented: boolean\r\n  \r\n  // Metadatos\r\n  confidenceOverall: number\r\n  tagsAnalyzed: number\r\n  processingTimeMs: number\r\n}\r\n\r\nexport function extractAmenities(tags: string[]): AmenitiesExtraction {\r\n  const start = Date.now()\r\n  const normalized = tags\r\n    .map(t => t.toLowerCase().trim())\r\n    .filter(t => t.length >= 2 && !/^\\d+$/.test(t))\r\n  \r\n  const extractor = new AmenityExtractor(normalized)\r\n  const result = extractor.extract()\r\n  \r\n  result.processingTimeMs = Date.now() - start\r\n  return result\r\n}\r\n\r\n// ============================================================\r\n// üî¨ CLASE EXTRACTOR\r\n// ============================================================\r\n\r\nclass AmenityExtractor {\r\n  private tags: string[]\r\n  private amenities: Amenity[] = []\r\n  private confidenceScores: Map<string, number> = new Map()\r\n  private indicatorsUsed: Map<string, Set<string>> = new Map()\r\n  \r\n  private readonly SYNONYMS: Record<string, string[]> = {\r\n    // Piscinas\r\n    \"pool\": [\"pool\", \"piscina\", \"swimming pool\", \"piscina exterior\", \"alberca\"],\r\n    \"infinity_pool\": [\"infinity pool\", \"piscina infinita\", \"vanishing edge\", \"borde infinito\"],\r\n    \"indoor_pool\": [\"indoor pool\", \"piscina cubierta\", \"covered pool\", \"piscina interior\"],\r\n    \"heated_pool\": [\"heated pool\", \"piscina climatizada\", \"thermal pool\"],\r\n    \"kids_pool\": [\"kids pool\", \"piscina infantil\", \"children pool\", \"piscinita\"],\r\n    \"jacuzzi\": [\"jacuzzi\", \"hidromasaje\", \"hot tub\", \"whirlpool\", \"spa pool\"],\r\n    \r\n    // Wellness\r\n    \"spa\": [\"spa\", \"centro de spa\", \"spa center\", \"wellness center\", \"√°rea de bienestar\"],\r\n    \"sauna\": [\"sauna\", \"sauna finlandesa\", \"sauna room\", \"sauna seca\"],\r\n    \"steam_room\": [\"steam room\", \"ba√±o de vapor\", \"hammam\", \"turkish bath\", \"vapor\"],\r\n    \"massage\": [\"massage\", \"masaje\", \"massage room\", \"sala de masajes\", \"treatment room\"],\r\n    \"gym\": [\"gym\", \"gimnasio\", \"fitness center\", \"fitness room\", \"sala de fitness\"],\r\n    \"yoga\": [\"yoga\", \"yoga room\", \"sala de yoga\", \"meditation\", \"meditaci√≥n\"],\r\n    \r\n    // Dining\r\n    \"restaurant\": [\"restaurant\", \"restaurante\", \"dining room\", \"comedor\", \"fine dining\"],\r\n    \"buffet\": [\"buffet\", \"buf√©\", \"buffet area\", \"zona de buffet\", \"desayuno buffet\"],\r\n    \"bar\": [\"bar\", \"barra\", \"lounge bar\", \"lobby bar\", \"bar interior\"],\r\n    \"rooftop_bar\": [\"rooftop bar\", \"bar en azotea\", \"sky bar\", \"bar terraza\"],\r\n    \"pool_bar\": [\"pool bar\", \"bar de piscina\", \"swim-up bar\", \"chiringuito\"],\r\n    \"beach_bar\": [\"beach bar\", \"chiringuito\", \"beach club\", \"bar playero\"],\r\n    \"cafe\": [\"cafe\", \"cafeter√≠a\", \"coffee shop\", \"pasteler√≠a\", \"zona caf√©\"],\r\n    \"dining_area\": [\"dining area\", \"dining room\", \"breakfast area\", \"zona de desayuno\"],\r\n    \r\n    // Rooms\r\n    \"room\": [\"room\", \"habitaci√≥n\", \"bedroom\", \"dormitorio\", \"guest room\"],\r\n    \"suite\": [\"suite\", \"suites\", \"junior suite\", \"suite junior\", \"executive suite\"],\r\n    \"presidential_suite\": [\"presidential suite\", \"suite presidencial\", \"royal suite\", \"suite real\"],\r\n    \"king_bed\": [\"king bed\", \"cama king\", \"king size\", \"cama grande\"],\r\n    \"queen_bed\": [\"queen bed\", \"cama queen\", \"queen size\", \"cama mediana\"],\r\n    \"twin_beds\": [\"twin beds\", \"camas gemelas\", \"twin_beds\", \"camas dobles\"],\r\n    \"balcony\": [\"balcony\", \"balc√≥n\", \"balcones\", \"private balcony\", \"balc√≥n privado\"],\r\n    \"terrace\": [\"terrace\", \"terraza\", \"private terrace\", \"terraza privada\", \"solarium\"],\r\n    \r\n    // Bathrooms\r\n    \"bathroom\": [\"bathroom\", \"ba√±o\", \"cuarto de ba√±o\", \"ensuite\", \"ba√±o privado\"],\r\n    \"bathtub\": [\"bathtub\", \"ba√±era\", \"freestanding tub\", \"ba√±era independiente\", \"clawfoot\"],\r\n    \"rain_shower\": [\"rain shower\", \"ducha de lluvia\", \"rainfall shower\", \"ducha efecto lluvia\"],\r\n    \"double_vanity\": [\"double vanity\", \"doble lavabo\", \"his and hers\", \"dos lavabos\"],\r\n    \r\n    // Outdoor\r\n    \"garden\": [\"garden\", \"jard√≠n\", \"jardines\", \"landscaped garden\", \"jard√≠n paisajista\"],\r\n    \"botanical_garden\": [\"botanical garden\", \"jard√≠n bot√°nico\", \"huerto\", \"jard√≠n tem√°tico\"],\r\n    \"beach_access\": [\"beach access\", \"acceso a playa\", \"playa privada\", \"first line beach\"],\r\n    \"mountain_view\": [\"mountain view\", \"vista a monta√±a\", \"vistas monta√±osas\", \"sierra\"],\r\n    \"courtyard\": [\"courtyard\", \"patio interior\", \"patio\", \"claustro\"],\r\n    \r\n    // Common areas\r\n    \"lobby\": [\"lobby\", \"recepci√≥n\", \"reception\", \"hall de entrada\", \"√°rea de check-in\"],\r\n    \"lounge\": [\"lounge\", \"sal√≥n\", \"sala de estar\", \"common area\", \"zona com√∫n\"],\r\n    \"library\": [\"library\", \"biblioteca\", \"reading room\", \"sala de lectura\"],\r\n    \"fireplace\": [\"fireplace\", \"chimenea\", \"fuego\", \"hogar\", \"lounge fireplace\"],\r\n    \r\n    // Business\r\n    \"conference_room\": [\"conference room\", \"sala de conferencias\", \"meeting room\", \"sala de juntas\"],\r\n    \"business_center\": [\"business center\", \"centro de negocios\", \"business area\", \"oficina\"],\r\n    \"av_equipment\": [\"av equipment\", \"equipo audiovisual\", \"proyector\", \"pantalla\"],\r\n    \r\n    // Family\r\n    \"kids_club\": [\"kids club\", \"club infantil\", \"children club\", \"miniclub\"],\r\n    \"playground\": [\"playground\", \"zona de juegos\", \"parque infantil\", \"√°rea kids\"],\r\n    \"babysitting\": [\"babysitting\", \"canguro\", \"ni√±era\", \"childcare\", \"guarder√≠a\"],\r\n    \r\n    // Accessibility\r\n    \"wheelchair_accessible\": [\"wheelchair accessible\", \"accesible silla ruedas\", \"accesibilidad\", \"rampas\"],\r\n    \"adapted_bathroom\": [\"adapted bathroom\", \"ba√±o adaptado\", \"ba√±o accesible\", \"handrails\"],\r\n    \r\n    // Sustainability\r\n    \"eco_certified\": [\"eco certified\", \"certificaci√≥n ecol√≥gica\", \"green key\", \"sostenible\"],\r\n    \"solar_panels\": [\"solar panels\", \"paneles solares\", \"energ√≠a solar\", \"fotovoltaica\"],\r\n    \r\n    // Views\r\n    \"sea_view\": [\"sea view\", \"vista al mar\", \"ocean view\", \"vistas marinas\", \"costa\"],\r\n    \"city_view\": [\"city view\", \"vista a ciudad\", \"skyline\", \"vistas urbanas\"],\r\n    \"panoramic_view\": [\"panoramic view\", \"vista panor√°mica\", \"360 view\", \"vistas completas\"],\r\n    \r\n    // Atmosphere/Style\r\n    \"luxury\": [\"luxury\", \"lujo\", \"luxurious\", \"premium\", \"high-end\", \"5 estrellas\"],\r\n    \"boutique\": [\"boutique\", \"boutique hotel\", \"dise√±o exclusivo\", \"hotel con encanto\"],\r\n    \"modern\": [\"modern\", \"moderno\", \"contemporary\", \"dise√±o actual\", \"minimalista\"],\r\n    \"rustic\": [\"rustic\", \"r√∫stico\", \"campo\", \"natural\", \"madera\", \"piedra\"],\r\n    \"mediterranean\": [\"mediterranean\", \"mediterr√°neo\", \"blanco\", \"azul\", \"ibicenco\"],\r\n    \r\n    // Premium indicators\r\n    \"butler_service\": [\"butler\", \"mayordomo\", \"butler service\", \"servicio personal\"],\r\n    \"private_pool\": [\"private pool\", \"piscina privada\", \"piscina exclusiva\", \"solo para hu√©spedes\"],\r\n    \"vip_access\": [\"vip access\", \"acceso vip\", \"zona exclusiva\", \"membres√≠a\"]\r\n  }\r\n\r\n  constructor(tags: string[]) {\r\n    this.tags = tags\r\n    this.initializeConfidenceScores()\r\n  }\r\n  \r\n  private initializeConfidenceScores() {\r\n    Object.keys(this.SYNONYMS).forEach(amenityId => {\r\n      this.confidenceScores.set(amenityId, 0)\r\n      this.indicatorsUsed.set(amenityId, new Set())\r\n    })\r\n  }\r\n  \r\n  // ============================================================\r\n  // üîé EXTRACCI√ìN POR CATEGOR√çAS\r\n  // ============================================================\r\n  \r\n  private extractPoolAmenities() {\r\n    if (this.hasAny([\"infinity\", \"vanishing\", \"edge\", \"horizon\"]) && \r\n        this.hasTag(\"pool\") && \r\n        this.hasAny([\"water\", \"sunbed\", \"umbrella\"])) {\r\n      this.addConfidence(\"infinity_pool\", 95, \"piscina infinita con evidencia visual\")\r\n      this.addConfidence(\"pool\", -30, \"reemplazado por infinity_pool\")\r\n    } else if (this.hasTag(\"pool\") && this.hasAny([\"water\", \"swimming\", \"sunbed\"])) {\r\n      this.addConfidence(\"pool\", 85, \"piscina con evidencia visual\")\r\n      if (this.hasTag(\"sunbed\")) {\r\n        this.addConfidence(\"sunbed\", 10, \"tumbonas en piscina\")\r\n      }\r\n    }\r\n    \r\n    if (this.hasAny([\"indoor\", \"covered\", \"cubierta\", \"interior\"]) && !this.hasTag(\"infinity\")) {\r\n      this.addConfidence(\"indoor_pool\", 90, \"piscina cubierta detectada\")\r\n      this.addConfidence(\"pool\", -25, \"reemplazado por indoor_pool\")\r\n    }\r\n    \r\n    if (this.hasAny([\"heated\", \"thermal\", \"climatizada\", \"temperada\"])) {\r\n      this.addConfidence(\"heated_pool\", 88, \"piscina climatizada detectada\")\r\n    }\r\n    \r\n    if (this.hasAny([\"kids\", \"children\", \"infantil\", \"ni√±os\"]) && this.hasTag(\"pool\")) {\r\n      this.addConfidence(\"kids_pool\", 82, \"piscina infantil detectada\")\r\n    }\r\n    \r\n    if (this.hasAny([\"jacuzzi\", \"hot tub\", \"hidromasaje\"])) {\r\n      this.addConfidence(\"jacuzzi\", 80, \"jacuzzi detectado\")\r\n    }\r\n    \r\n    if (this.hasAny([\"pool bar\", \"bar de piscina\", \"swim-up\"])) {\r\n      this.addConfidence(\"pool_bar\", 87, \"bar integrado en piscina detectado\")\r\n    }\r\n  }\r\n  \r\n  private extractWellnessAmenities() {\r\n    if (this.hasAny([\"spa\", \"wellness\", \"centro de spa\"])) {\r\n      this.addConfidence(\"spa\", 92, \"spa detectado\")\r\n      if (this.hasAny([\"sauna\", \"sauna finlandesa\"])) this.addConfidence(\"sauna\", 88, \"sauna detectada\")\r\n      if (this.hasAny([\"steam\", \"vapor\", \"hammam\", \"turkish bath\"])) this.addConfidence(\"steam_room\", 86, \"ba√±o de vapor detectado\")\r\n      if (this.hasAny([\"massage\", \"masaje\", \"treatment\"])) this.addConfidence(\"spa\", 15, \"servicios de masaje detectados\")\r\n      if (this.hasAny([\"relaxation\", \"quiet room\", \"zona relax\"])) this.addConfidence(\"spa\", 10, \"√°rea de relajaci√≥n detectada\")\r\n    }\r\n    \r\n    if (this.hasAny([\"gym\", \"fitness\", \"gimnasio\"])) {\r\n      this.addConfidence(\"gym\", 85, \"gimnasio detectado\")\r\n      if (this.hasAny([\"yoga\", \"meditation\", \"pilates\"])) this.addConfidence(\"yoga\", 83, \"sala de yoga/meditaci√≥n detectada\")\r\n      if (this.hasAny([\"personal trainer\", \"entrenador\"])) this.addConfidence(\"gym\", 15, \"servicio de entrenador personal\")\r\n    }\r\n  }\r\n  \r\n  private extractDiningAmenities() {\r\n    const isRoomContext = this.hasAny([\"room\", \"suite\", \"bedroom\", \"king bed\", \"queen bed\", \"twin_beds\"])\r\n    const isPureRestaurant = this.hasAny([\"restaurant\", \"restaurante\"]) && !isRoomContext\r\n    \r\n    if (isPureRestaurant) {\r\n      this.addConfidence(\"restaurant\", 88, \"restaurante detectado\")\r\n      if (this.hasAny([\"buffet\", \"buf√©\", \"desayuno\"])) this.addConfidence(\"buffet\", 84, \"zona de buffet detectada\")\r\n      if (this.hasAny([\"fine dining\", \"gourmet\", \"chef\"])) this.addConfidence(\"restaurant\", 15, \"restaurante gourmet detectado\")\r\n      if (this.hasAny([\"rooftop\", \"azotea\"]) && this.hasTag(\"restaurant\")) {\r\n        this.addConfidence(\"restaurant\", -20, \"reemplazado por rooftop_bar si aplica\")\r\n      }\r\n    }\r\n    \r\n    if (this.hasAny([\"dining area\", \"dining room\", \"breakfast area\"]) && isRoomContext) {\r\n      if (this.hasAny([\"breakfast\", \"morning\", \"food\", \"plate\", \"cup\"])) {\r\n        this.addConfidence(\"dining_area\", 85, \"zona de desayuno en habitaci√≥n detectada\")\r\n      }\r\n    }\r\n    \r\n    if (this.hasAny([\"bar\", \"cocktail\", \"barra\"])) {\r\n      this.addConfidence(\"bar\", 86, \"bar detectado\")\r\n      if (this.hasAny([\"rooftop\", \"sky bar\", \"azotea\"]) && this.hasTag(\"bar\")) {\r\n        this.addConfidence(\"rooftop_bar\", 93, \"bar en azotea detectado\")\r\n        this.addConfidence(\"bar\", -40, \"reemplazado por rooftop_bar\")\r\n      }\r\n      if (this.hasTag(\"pool\") && this.hasTag(\"bar\")) {\r\n        this.addConfidence(\"pool_bar\", 91, \"bar de piscina detectado\")\r\n        this.addConfidence(\"bar\", -35, \"reemplazado por pool_bar\")\r\n      }\r\n      if (this.hasAny([\"beach\", \"playa\"]) && this.hasTag(\"bar\")) {\r\n        this.addConfidence(\"beach_bar\", 89, \"chiringuito/bar playero detectado\")\r\n        this.addConfidence(\"bar\", -30, \"reemplazado por beach_bar\")\r\n      }\r\n      if (this.hasAny([\"wine\", \"bodega\", \"vinos\"])) this.addConfidence(\"bar\", 10, \"especialidad en vinos detectada\")\r\n    }\r\n    \r\n    if (this.hasAny([\"cafe\", \"cafeter√≠a\", \"coffee\", \"pasteler√≠a\"])) {\r\n      this.addConfidence(\"cafe\", 80, \"cafeter√≠a detectada\")\r\n    }\r\n    \r\n    // ‚úÖ ELIMINAR \"sunbed\" en contexto de restaurante\r\n    if (isPureRestaurant && this.hasTag(\"sunbed\")) {\r\n      this.removeConfidence(\"sunbed\", 100, \"sunbed no es relevante en restaurante\")\r\n    }\r\n  }\r\n  \r\n  private extractRoomAmenities() {\r\n    if (this.hasAny([\"room\", \"habitaci√≥n\", \"bedroom\"])) {\r\n      this.addConfidence(\"room\", 82, \"habitaci√≥n detectada\")\r\n      if (this.hasAny([\"twin beds\", \"camas gemelas\", \"twin_beds\", \"camas dobles\"])) {\r\n        this.addConfidence(\"twin_beds\", 90, \"camas gemelas detectadas\")\r\n      }\r\n      if (this.hasAny([\"king bed\", \"cama king\", \"king size\"])) {\r\n        this.addConfidence(\"king_bed\", 85, \"cama king size detectada\")\r\n      }\r\n      if (this.hasAny([\"queen bed\", \"cama queen\", \"queen size\"])) {\r\n        this.addConfidence(\"queen_bed\", 83, \"cama queen size detectada\")\r\n      }\r\n      if (this.hasAny([\"suite\", \"suites\"])) {\r\n        this.addConfidence(\"suite\", 90, \"suite detectada\")\r\n        this.addConfidence(\"room\", -35, \"reemplazado por suite\")\r\n        if (this.hasAny([\"presidential\", \"royal\", \"real\", \"presidencial\"])) {\r\n          this.addConfidence(\"presidential_suite\", 96, \"suite presidencial detectada\")\r\n          this.addConfidence(\"suite\", -25, \"reemplazado por presidential_suite\")\r\n        }\r\n      }\r\n      if (this.hasAny([\"balcony\", \"balc√≥n\", \"terraza privada\"])) {\r\n        this.addConfidence(\"balcony\", 87, \"balc√≥n/terraza privada detectada\")\r\n      }\r\n      if (this.hasAny([\"sea view\", \"vista al mar\", \"ocean view\"]) && this.hasTag(\"room\")) {\r\n        this.addConfidence(\"room\", 20, \"habitaci√≥n con vistas premium\")\r\n      }\r\n    }\r\n  }\r\n  \r\n  private extractBathroomAmenities() {\r\n    if (this.hasAny([\"bathroom\", \"ba√±o\", \"cuarto de ba√±o\"])) {\r\n      this.addConfidence(\"bathroom\", 80, \"ba√±o detectado\")\r\n      if (this.hasAny([\"bathtub\", \"ba√±era\", \"freestanding\", \"clawfoot\"])) {\r\n        this.addConfidence(\"bathtub\", 88, \"ba√±era freestanding detectada\")\r\n      }\r\n      if (this.hasAny([\"rain shower\", \"ducha lluvia\", \"rainfall\"])) {\r\n        this.addConfidence(\"rain_shower\", 86, \"ducha de lluvia detectada\")\r\n      }\r\n      if (this.hasAny([\"double vanity\", \"doble lavabo\", \"his and hers\"])) {\r\n        this.addConfidence(\"double_vanity\", 84, \"doble lavabo detectado\")\r\n      }\r\n      if (this.hasAny([\"heated floors\", \"suelo radiante\"])) {\r\n        this.addConfidence(\"bathroom\", 15, \"suelo radiante detectado\")\r\n      }\r\n    }\r\n  }\r\n  \r\n  private extractOutdoorAmenities() {\r\n    if (this.hasAny([\"garden\", \"jard√≠n\", \"landscaped\", \"verde\"])) {\r\n      this.addConfidence(\"garden\", 83, \"jard√≠n detectado\")\r\n      if (this.hasAny([\"botanical\", \"bot√°nico\", \"huerto\"])) {\r\n        this.addConfidence(\"botanical_garden\", 89, \"jard√≠n bot√°nico detectado\")\r\n        this.addConfidence(\"garden\", -20, \"especializado como botanical_garden\")\r\n      }\r\n      if (this.hasAny([\"zen\", \"japon√©s\", \"meditaci√≥n\"])) {\r\n        this.addConfidence(\"garden\", 15, \"jard√≠n zen detectado\")\r\n      }\r\n    }\r\n    \r\n    if (this.hasAny([\"beach\", \"playa\", \"shoreline\", \"costa\"])) {\r\n      this.addConfidence(\"beach_access\", 94, \"acceso a playa detectado\")\r\n      if (this.hasAny([\"private beach\", \"playa privada\", \"first line\"])) {\r\n        this.addConfidence(\"beach_access\", 15, \"playa privada/exclusiva\")\r\n      }\r\n    }\r\n    \r\n    if (this.hasAny([\"mountain\", \"monta√±a\", \"hill\", \"valley\"])) {\r\n      this.addConfidence(\"mountain_view\", 85, \"vistas a monta√±a detectadas\")\r\n    }\r\n    \r\n    if (this.hasAny([\"courtyard\", \"patio\", \"claustro\", \"patio interior\"])) {\r\n      this.addConfidence(\"courtyard\", 82, \"patio interior detectado\")\r\n    }\r\n    \r\n    if (this.hasAny([\"terrace\", \"terraza\", \"solarium\", \"rooftop\"])) {\r\n      if (!this.hasTag(\"restaurant\") && !this.hasTag(\"room\")) {\r\n        this.addConfidence(\"terrace\", 80, \"terraza general detectada\")\r\n      }\r\n    }\r\n  }\r\n  \r\n  private extractCommonAreasAmenities() {\r\n    if (this.hasAny([\"lobby\", \"recepci√≥n\", \"reception\", \"check-in\"])) {\r\n      this.addConfidence(\"lobby\", 87, \"lobby/recepci√≥n detectado\")\r\n      if (this.hasAny([\"grand\", \"monumental\", \"impresionante\"])) {\r\n        this.addConfidence(\"lobby\", 15, \"lobby de dise√±o monumental\")\r\n      }\r\n    }\r\n    \r\n    if (this.hasAny([\"lounge\", \"sal√≥n\", \"sala de estar\", \"common area\"])) {\r\n      this.addConfidence(\"lounge\", 84, \"sal√≥n de estar detectado\")\r\n      if (this.hasAny([\"fireplace\", \"chimenea\", \"hogar\"])) {\r\n        this.addConfidence(\"fireplace\", 86, \"chimenea en sal√≥n detectada\")\r\n      }\r\n    }\r\n    \r\n    if (this.hasAny([\"library\", \"biblioteca\", \"reading room\", \"lectura\"])) {\r\n      this.addConfidence(\"library\", 81, \"biblioteca/sala de lectura detectada\")\r\n    }\r\n  }\r\n  \r\n  private extractBusinessAmenities() {\r\n    if (this.hasAny([\"conference\", \"reuni√≥n\", \"meeting\", \"juntas\"])) {\r\n      this.addConfidence(\"conference_room\", 88, \"sala de conferencias detectada\")\r\n    }\r\n    if (this.hasAny([\"business center\", \"centro negocios\", \"oficina\"])) {\r\n      this.addConfidence(\"business_center\", 85, \"centro de negocios detectado\")\r\n    }\r\n    if (this.hasAny([\"av equipment\", \"audiovisual\", \"proyector\", \"pantalla\"])) {\r\n      this.addConfidence(\"av_equipment\", 82, \"equipo audiovisual detectado\")\r\n    }\r\n    if (this.hasAny([\"coworking\", \"espacio coworking\", \"trabajo compartido\"])) {\r\n      this.addConfidence(\"business_center\", 15, \"zona de coworking detectada\")\r\n    }\r\n  }\r\n  \r\n  private extractFamilyAmenities() {\r\n    if (this.hasAny([\"kids club\", \"club infantil\", \"miniclub\", \"children\"])) {\r\n      this.addConfidence(\"kids_club\", 90, \"club infantil detectado\")\r\n    }\r\n    if (this.hasAny([\"playground\", \"zona juegos\", \"parque infantil\"])) {\r\n      this.addConfidence(\"playground\", 86, \"zona de juegos detectada\")\r\n    }\r\n    if (this.hasAny([\"babysitting\", \"canguro\", \"ni√±era\", \"childcare\"])) {\r\n      this.addConfidence(\"babysitting\", 84, \"servicio de canguro detectado\")\r\n    }\r\n    if (this.hasAny([\"family room\", \"habitaci√≥n familiar\", \"conecting rooms\"])) {\r\n      this.addConfidence(\"room\", 15, \"habitaci√≥n familiar detectada\")\r\n    }\r\n  }\r\n  \r\n  private extractAccessibilityAmenities() {\r\n    if (this.hasAny([\"wheelchair\", \"silla ruedas\", \"accesible\", \"rampas\"])) {\r\n      this.addConfidence(\"wheelchair_accessible\", 92, \"accesibilidad para silla de ruedas detectada\")\r\n    }\r\n    if (this.hasAny([\"adapted bathroom\", \"ba√±o adaptado\", \"handrails\", \"barras\"])) {\r\n      this.addConfidence(\"adapted_bathroom\", 88, \"ba√±o adaptado detectado\")\r\n    }\r\n    if (this.hasAny([\"elevator\", \"ascensor\", \"lift\"])) {\r\n      this.addConfidence(\"wheelchair_accessible\", 10, \"ascensor disponible\")\r\n    }\r\n  }\r\n  \r\n  private extractSustainabilityAmenities() {\r\n    if (this.hasAny([\"eco\", \"sostenible\", \"green\", \"ecol√≥gico\"])) {\r\n      this.addConfidence(\"eco_certified\", 85, \"certificaci√≥n ecol√≥gica detectada\")\r\n    }\r\n    if (this.hasAny([\"solar panels\", \"paneles solares\", \"energ√≠a solar\"])) {\r\n      this.addConfidence(\"solar_panels\", 88, \"paneles solares detectados\")\r\n    }\r\n    if (this.hasAny([\"organic garden\", \"huerto ecol√≥gico\", \"farm to table\"])) {\r\n      this.addConfidence(\"eco_certified\", 15, \"huerto org√°nico detectado\")\r\n    }\r\n    if (this.hasAny([\"water saving\", \"ahorro agua\", \"rainwater\"])) {\r\n      this.addConfidence(\"eco_certified\", 10, \"sistemas de ahorro de agua\")\r\n    }\r\n  }\r\n  \r\n  private extractViewAmenities() {\r\n    if (this.hasAny([\"sea view\", \"vista al mar\", \"ocean view\", \"mar\"])) {\r\n      this.addConfidence(\"sea_view\", 93, \"vistas al mar detectadas\")\r\n    }\r\n    if (this.hasAny([\"city view\", \"vista ciudad\", \"skyline\", \"urbano\"])) {\r\n      this.addConfidence(\"city_view\", 87, \"vistas a ciudad detectadas\")\r\n    }\r\n    if (this.hasAny([\"mountain view\", \"vista monta√±a\", \"sierra\", \"valle\"])) {\r\n      this.addConfidence(\"mountain_view\", 86, \"vistas a monta√±a detectadas\")\r\n    }\r\n    if (this.hasAny([\"panoramic\", \"360\", \"completa\", \"amplia vista\"])) {\r\n      this.addConfidence(\"panoramic_view\", 91, \"vista panor√°mica detectada\")\r\n    }\r\n    if (this.hasAny([\"garden view\", \"vista jard√≠n\", \"patio vista\"])) {\r\n      this.addConfidence(\"garden_view\", 82, \"vistas a jard√≠n detectadas\")\r\n    }\r\n  }\r\n  \r\n  private extractAtmosphereAmenities() {\r\n    if (this.hasAny([\"luxury\", \"lujo\", \"premium\", \"high-end\", \"5 estrellas\"])) {\r\n      this.addConfidence(\"luxury\", 95, \"lujo detectado\")\r\n    }\r\n    if (this.hasAny([\"boutique\", \"dise√±o exclusivo\", \"encanto\", \"personalizado\"])) {\r\n      this.addConfidence(\"boutique\", 90, \"estilo boutique detectado\")\r\n    }\r\n    if (this.hasAny([\"modern\", \"moderno\", \"contemporary\", \"minimalista\"])) {\r\n      this.addConfidence(\"modern\", 85, \"dise√±o moderno detectado\")\r\n    }\r\n    if (this.hasAny([\"rustic\", \"r√∫stico\", \"campo\", \"madera\", \"piedra\"])) {\r\n      this.addConfidence(\"rustic\", 83, \"estilo r√∫stico detectado\")\r\n    }\r\n    if (this.hasAny([\"mediterranean\", \"mediterr√°neo\", \"blanco\", \"azul\", \"ibiza\"])) {\r\n      this.addConfidence(\"mediterranean\", 87, \"estilo mediterr√°neo detectado\")\r\n    }\r\n    if (this.hasAny([\"cozy\", \"acogedor\", \"c√°lido\", \"intimate\"])) {\r\n      this.addConfidence(\"cozy\", 84, \"ambiente acogedor detectado\")\r\n    }\r\n    if (this.hasAny([\"romantic\", \"rom√°ntico\", \"parejas\", \"luna miel\"])) {\r\n      this.addConfidence(\"romantic\", 89, \"ambiente rom√°ntico detectado\")\r\n    }\r\n  }\r\n  \r\n  private extractPremiumAmenities() {\r\n    if (this.hasAny([\"butler\", \"mayordomo\", \"servicio personal\"])) {\r\n      this.addConfidence(\"butler_service\", 94, \"servicio de mayordomo detectado\")\r\n    }\r\n    if (this.hasAny([\"private pool\", \"piscina privada\", \"exclusiva\"]) && this.hasTag(\"suite\")) {\r\n      this.addConfidence(\"private_pool\", 92, \"piscina privada para suite detectada\")\r\n    }\r\n    if (this.hasAny([\"vip access\", \"acceso vip\", \"exclusivo\", \"membres√≠a\"])) {\r\n      this.addConfidence(\"vip_access\", 88, \"acceso VIP detectado\")\r\n    }\r\n    if (this.hasAny([\"concierge\", \"conserje\", \"servicio 24h\"])) {\r\n      this.addConfidence(\"premium\", 85, \"servicio de conserjer√≠a detectado\")\r\n    }\r\n  }\r\n  \r\n  // ============================================================\r\n  // üß† M√âTODOS AUXILIARES\r\n  // ============================================================\r\n  \r\n  private hasTag(tag: string): boolean {\r\n    return this.tags.some(t => \r\n      t === tag || \r\n      t.includes(` ${tag} `) || \r\n      t.startsWith(`${tag} `) || \r\n      t.endsWith(` ${tag}`)\r\n    )\r\n  }\r\n  \r\n  private hasAny(tags: string[]): boolean {\r\n    return tags.some(tag => this.hasTag(tag))\r\n  }\r\n  \r\n  private addConfidence(amenityId: string, points: number, reason: string) {\r\n    const current = this.confidenceScores.get(amenityId) || 0\r\n    const newScore = Math.max(0, current + points)\r\n    this.confidenceScores.set(amenityId, newScore)\r\n    \r\n    if (points > 0) {\r\n      const synonyms = this.SYNONYMS[amenityId] || []\r\n      const matchingSynonyms = synonyms.filter(s => \r\n        this.tags.includes(s.toLowerCase().trim())\r\n      )\r\n      \r\n      if (matchingSynonyms.length > 0) {\r\n        const set = this.indicatorsUsed.get(amenityId) || new Set()\r\n        matchingSynonyms.forEach(syn => set.add(syn))\r\n        this.indicatorsUsed.set(amenityId, set)\r\n      }\r\n    }\r\n  }\r\n  \r\n  private removeConfidence(amenityId: string, points: number, reason: string) {\r\n    const current = this.confidenceScores.get(amenityId) || 0\r\n    const newScore = Math.max(0, current - points)\r\n    this.confidenceScores.set(amenityId, newScore)\r\n  }\r\n  \r\n  // ============================================================\r\n  // üöÄ EJECUCI√ìN PRINCIPAL\r\n  // ============================================================\r\n  \r\n  public extract(): AmenitiesExtraction {\r\n    this.extractPoolAmenities()\r\n    this.extractWellnessAmenities()\r\n    this.extractDiningAmenities()\r\n    this.extractRoomAmenities()\r\n    this.extractBathroomAmenities()\r\n    this.extractOutdoorAmenities()\r\n    this.extractCommonAreasAmenities()\r\n    this.extractBusinessAmenities()\r\n    this.extractFamilyAmenities()\r\n    this.extractAccessibilityAmenities()\r\n    this.extractSustainabilityAmenities()\r\n    this.extractViewAmenities()\r\n    this.extractAtmosphereAmenities()\r\n    this.extractPremiumAmenities()\r\n    \r\n    this.buildAmenitiesList()\r\n    \r\n    const byCategory: Record<AmenityCategory, Amenity[]> = {\r\n      pool: [], wellness: [], dining: [], room: [], bathroom: [], outdoor: [],\r\n      common_areas: [], business: [], family: [], accessibility: [], sustainability: [],\r\n      views: [], atmosphere: [], premium: []\r\n    }\r\n    \r\n    this.amenities.forEach(amenity => {\r\n      const cat = this.getCategoryForAmenity(amenity.id)\r\n      if (byCategory[cat]) {\r\n        byCategory[cat].push(amenity)\r\n      }\r\n    })\r\n    \r\n    const premium = this.amenities\r\n      .filter(a => a.isPremium || a.confidence === \"high\")\r\n      .sort((a, b) => \r\n        (b.confidence === \"high\" ? 1 : 0) - (a.confidence === \"high\" ? 1 : 0) ||\r\n        b.id.localeCompare(a.id)\r\n      )\r\n      .slice(0, 8)\r\n    \r\n    const flat = this.amenities\r\n      .map(a => a.id)\r\n      .filter((value, index, self) => self.indexOf(value) === index)\r\n    \r\n    const hasPool = this.amenities.some(a => a.category === \"pool\")\r\n    const hasSpa = this.amenities.some(a => a.category === \"wellness\" && a.id === \"spa\")\r\n    const hasRestaurant = this.amenities.some(a => a.category === \"dining\" && a.id === \"restaurant\")\r\n    const hasBar = this.amenities.some(a => a.category === \"dining\" && a.id.includes(\"bar\"))\r\n    const hasSeaView = this.amenities.some(a => a.category === \"views\" && a.id === \"sea_view\")\r\n    const isLuxury = this.amenities.some(a => a.category === \"atmosphere\" && a.id === \"luxury\")\r\n    const isBoutique = this.amenities.some(a => a.category === \"atmosphere\" && a.id === \"boutique\")\r\n    const isFamilyFriendly = this.amenities.some(a => a.category === \"family\")\r\n    const isBusinessReady = this.amenities.some(a => a.category === \"business\")\r\n    const isWellnessOriented = hasSpa || this.amenities.some(a => \r\n      a.category === \"wellness\" && [\"sauna\", \"steam_room\", \"gym\"].includes(a.id)\r\n    )\r\n    \r\n    const avgConfidence = this.amenities.length > 0\r\n      ? Math.round(this.amenities.reduce((sum, a) => \r\n          sum + (a.confidence === \"high\" ? 90 : a.confidence === \"medium\" ? 70 : 50)\r\n        , 0) / this.amenities.length)\r\n      : 40\r\n    \r\n    // ‚úÖ CORRECCI√ìN: Incluir 'amenities' en el objeto retornado\r\n    return {\r\n      amenities: this.amenities,  // ‚úÖ A√ëADIDO: para que searchAmenities funcione\r\n      byCategory,\r\n      premium,\r\n      flat,\r\n      hasPool,\r\n      hasSpa,\r\n      hasRestaurant,\r\n      hasBar,\r\n      hasSeaView,\r\n      isLuxury,\r\n      isBoutique,\r\n      isFamilyFriendly,\r\n      isBusinessReady,\r\n      isWellnessOriented,\r\n      confidenceOverall: avgConfidence,\r\n      tagsAnalyzed: this.tags.length,\r\n      processingTimeMs: 0\r\n    }\r\n  }\r\n  \r\n  private buildAmenitiesList() {\r\n    this.amenities = []\r\n    \r\n    for (const [amenityId, score] of this.confidenceScores.entries()) {\r\n      if (score >= 60) {\r\n        const confidence = score >= 85 ? \"high\" : score >= 70 ? \"medium\" : \"low\"\r\n        const indicators = Array.from(this.indicatorsUsed.get(amenityId) || [])\r\n        \r\n        const isPremium = [\r\n          \"infinity_pool\", \"presidential_suite\", \"private_pool\", \"butler_service\",\r\n          \"beach_access\", \"panoramic_view\", \"rooftop_bar\", \"botanical_garden\",\r\n          \"luxury\", \"boutique\"\r\n        ].includes(amenityId) || score >= 90\r\n        \r\n        this.amenities.push({\r\n          id: amenityId,\r\n          name: this.getHumanName(amenityId),\r\n          category: this.getCategoryForAmenity(amenityId),\r\n          confidence,\r\n          indicators,\r\n          isPremium\r\n        })\r\n      }\r\n    }\r\n    \r\n    this.removeRedundancies()\r\n  }\r\n  \r\n  private removeRedundancies() {\r\n    const toRemove: Set<string> = new Set()\r\n    \r\n    if (this.amenities.some(a => a.id === \"infinity_pool\")) toRemove.add(\"pool\")\r\n    if (this.amenities.some(a => a.id === \"presidential_suite\")) toRemove.add(\"suite\")\r\n    if (this.amenities.some(a => a.id === \"indoor_pool\") && !this.amenities.some(a => a.id === \"infinity_pool\")) {\r\n      toRemove.add(\"pool\")\r\n    }\r\n    if (this.amenities.some(a => a.id === \"rooftop_bar\")) toRemove.add(\"bar\")\r\n    if (this.amenities.some(a => a.id === \"pool_bar\") && !this.amenities.some(a => a.id === \"rooftop_bar\")) {\r\n      toRemove.add(\"bar\")\r\n    }\r\n    \r\n    this.amenities = this.amenities.filter(a => !toRemove.has(a.id))\r\n  }\r\n  \r\n  private getCategoryForAmenity(amenityId: string): AmenityCategory {\r\n    const mapping: Record<string, AmenityCategory> = {\r\n      \"pool\": \"pool\", \"infinity_pool\": \"pool\", \"indoor_pool\": \"pool\", \"heated_pool\": \"pool\",\r\n      \"kids_pool\": \"pool\", \"jacuzzi\": \"pool\", \"pool_bar\": \"pool\",\r\n      \"spa\": \"wellness\", \"sauna\": \"wellness\", \"steam_room\": \"wellness\", \"massage\": \"wellness\",\r\n      \"gym\": \"wellness\", \"yoga\": \"wellness\",\r\n      \"restaurant\": \"dining\", \"buffet\": \"dining\", \"bar\": \"dining\", \"rooftop_bar\": \"dining\",\r\n      \"beach_bar\": \"dining\", \"cafe\": \"dining\", \"dining_area\": \"dining\",\r\n      \"room\": \"room\", \"suite\": \"room\", \"presidential_suite\": \"room\", \"king_bed\": \"room\",\r\n      \"queen_bed\": \"room\", \"twin_beds\": \"room\", \"balcony\": \"room\", \"terrace\": \"room\",\r\n      \"bathroom\": \"bathroom\", \"bathtub\": \"bathroom\", \"rain_shower\": \"bathroom\", \"double_vanity\": \"bathroom\",\r\n      \"garden\": \"outdoor\", \"botanical_garden\": \"outdoor\", \"beach_access\": \"outdoor\",\r\n      \"mountain_view\": \"outdoor\", \"courtyard\": \"outdoor\",\r\n      \"lobby\": \"common_areas\", \"lounge\": \"common_areas\", \"library\": \"common_areas\", \"fireplace\": \"common_areas\",\r\n      \"conference_room\": \"business\", \"business_center\": \"business\", \"av_equipment\": \"business\",\r\n      \"kids_club\": \"family\", \"playground\": \"family\", \"babysitting\": \"family\",\r\n      \"wheelchair_accessible\": \"accessibility\", \"adapted_bathroom\": \"accessibility\",\r\n      \"eco_certified\": \"sustainability\", \"solar_panels\": \"sustainability\",\r\n      \"sea_view\": \"views\", \"city_view\": \"views\", \"panoramic_view\": \"views\", \"garden_view\": \"views\",\r\n      \"luxury\": \"atmosphere\", \"boutique\": \"atmosphere\", \"modern\": \"atmosphere\", \"rustic\": \"atmosphere\",\r\n      \"mediterranean\": \"atmosphere\", \"cozy\": \"atmosphere\", \"romantic\": \"atmosphere\",\r\n      \"butler_service\": \"premium\", \"private_pool\": \"premium\", \"vip_access\": \"premium\"\r\n    }\r\n    return mapping[amenityId] || \"atmosphere\"\r\n  }\r\n  \r\n  private getHumanName(amenityId: string): string {\r\n    const names: Record<string, string> = {\r\n      \"pool\": \"Piscina\", \"infinity_pool\": \"Piscina infinita\", \"indoor_pool\": \"Piscina cubierta\",\r\n      \"heated_pool\": \"Piscina climatizada\", \"kids_pool\": \"Piscina infantil\", \"jacuzzi\": \"Jacuzzi\",\r\n      \"pool_bar\": \"Bar de piscina\", \"spa\": \"Spa\", \"sauna\": \"Sauna\", \"steam_room\": \"Ba√±o de vapor\",\r\n      \"massage\": \"Masajes\", \"gym\": \"Gimnasio\", \"yoga\": \"Sala de yoga\", \"restaurant\": \"Restaurante\",\r\n      \"buffet\": \"Zona de buffet\", \"bar\": \"Bar\", \"rooftop_bar\": \"Bar en azotea\", \"beach_bar\": \"Chiringuito\",\r\n      \"cafe\": \"Cafeter√≠a\", \"dining_area\": \"Zona de desayuno\", \"room\": \"Habitaci√≥n\", \"suite\": \"Suite\",\r\n      \"presidential_suite\": \"Suite presidencial\", \"king_bed\": \"Cama king size\", \"queen_bed\": \"Cama queen size\",\r\n      \"twin_beds\": \"Dos camas\", \"balcony\": \"Balc√≥n privado\", \"terrace\": \"Terraza\", \"bathroom\": \"Ba√±o privado\",\r\n      \"bathtub\": \"Ba√±era\", \"rain_shower\": \"Ducha de lluvia\", \"double_vanity\": \"Doble lavabo\",\r\n      \"garden\": \"Jard√≠n\", \"botanical_garden\": \"Jard√≠n bot√°nico\", \"beach_access\": \"Acceso a playa\",\r\n      \"mountain_view\": \"Vistas a monta√±a\", \"courtyard\": \"Patio interior\", \"lobby\": \"Lobby\",\r\n      \"lounge\": \"Sal√≥n de estar\", \"library\": \"Biblioteca\", \"fireplace\": \"Chimenea\",\r\n      \"conference_room\": \"Sala de conferencias\", \"business_center\": \"Centro de negocios\",\r\n      \"av_equipment\": \"Equipo audiovisual\", \"kids_club\": \"Club infantil\", \"playground\": \"Zona de juegos\",\r\n      \"babysitting\": \"Servicio de canguro\", \"wheelchair_accessible\": \"Accesible para silla de ruedas\",\r\n      \"adapted_bathroom\": \"Ba√±o adaptado\", \"eco_certified\": \"Certificaci√≥n ecol√≥gica\",\r\n      \"solar_panels\": \"Paneles solares\", \"sea_view\": \"Vistas al mar\", \"city_view\": \"Vistas a la ciudad\",\r\n      \"panoramic_view\": \"Vistas panor√°micas\", \"garden_view\": \"Vistas al jard√≠n\", \"luxury\": \"Lujo\",\r\n      \"boutique\": \"Estilo boutique\", \"modern\": \"Dise√±o moderno\", \"rustic\": \"Estilo r√∫stico\",\r\n      \"mediterranean\": \"Estilo mediterr√°neo\", \"cozy\": \"Ambiente acogedor\", \"romantic\": \"Ambiente rom√°ntico\",\r\n      \"butler_service\": \"Servicio de mayordomo\", \"private_pool\": \"Piscina privada\", \"vip_access\": \"Acceso VIP\"\r\n    }\r\n    return names[amenityId] || amenityId.replace(/_/g, \" \")\r\n  }\r\n}\r\n\r\n// ============================================================\r\n// üß™ UTILIDADES DE SOPORTE\r\n// ============================================================\r\n\r\nexport function extractAmenitiesSimple(tags: string[]): string[] {\r\n  const extraction = extractAmenities(tags)\r\n  return extraction.flat\r\n}\r\n\r\nexport function generateAmenityBadges(extraction: AmenitiesExtraction): {\r\n  id: string\r\n  label: string\r\n  color: \"blue\" | \"green\" | \"amber\" | \"rose\" | \"indigo\" | \"emerald\"\r\n  priority: number\r\n}[] {\r\n  const BADGE_CONFIG: Record<string, { color: string; priority: number }> = {\r\n    \"infinity_pool\": { color: \"amber\", priority: 100 },\r\n    \"presidential_suite\": { color: \"rose\", priority: 95 },\r\n    \"private_pool\": { color: \"amber\", priority: 90 },\r\n    \"beach_access\": { color: \"emerald\", priority: 88 },\r\n    \"panoramic_view\": { color: \"indigo\", priority: 87 },\r\n    \"rooftop_bar\": { color: \"violet\", priority: 85 },\r\n    \"butler_service\": { color: \"rose\", priority: 84 },\r\n    \"spa\": { color: \"indigo\", priority: 80 },\r\n    \"sauna\": { color: \"amber\", priority: 78 },\r\n    \"steam_room\": { color: \"amber\", priority: 77 },\r\n    \"gym\": { color: \"blue\", priority: 75 },\r\n    \"restaurant\": { color: \"emerald\", priority: 73 },\r\n    \"pool_bar\": { color: \"sky\", priority: 70 },\r\n    \"sea_view\": { color: \"sky\", priority: 68 },\r\n    \"mountain_view\": { color: \"green\", priority: 66 },\r\n    \"luxury\": { color: \"gold\", priority: 65 },\r\n    \"boutique\": { color: \"purple\", priority: 64 },\r\n    \"kids_club\": { color: \"pink\", priority: 60 },\r\n    \"pool\": { color: \"sky\", priority: 55 },\r\n    \"suite\": { color: \"purple\", priority: 54 },\r\n    \"bar\": { color: \"amber\", priority: 52 },\r\n    \"garden\": { color: \"green\", priority: 50 },\r\n    \"lobby\": { color: \"gray\", priority: 45 }\r\n  }\r\n  \r\n  return extraction.premium.map(amenity => {\r\n    const config = BADGE_CONFIG[amenity.id] || { color: \"gray\", priority: 30 }\r\n    return {\r\n      id: amenity.id,\r\n      label: amenity.name,\r\n      color: config.color as any,\r\n      priority: config.priority\r\n    }\r\n  }).sort((a, b) => b.priority - a.priority).slice(0, 6)\r\n}\r\n\r\nexport function searchAmenities(extraction: AmenitiesExtraction, query: string): Amenity[] {\r\n  const q = query.toLowerCase().trim()\r\n  // ‚úÖ Ahora funciona porque 'amenities' est√° en la interfaz\r\n  return extraction.amenities?.filter(amenity => \r\n    amenity.id.includes(q) || \r\n    amenity.name.toLowerCase().includes(q) ||\r\n    amenity.category.includes(q)\r\n  ) || []\r\n}"],"names":[],"mappings":"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"}},
    {"offset": {"line": 4173, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/achra/proyectos/app-hotel-nueva/src/app/api/upload/route.ts"],"sourcesContent":["// src/app/api/upload/route.ts\r\n\r\nimport { NextRequest, NextResponse } from \"next/server\"\r\nimport { v2 as cloudinary } from \"cloudinary\"\r\nimport { createClient } from \"@supabase/supabase-js\"\r\nimport { Buffer } from \"buffer\"\r\nimport crypto from \"crypto\"\r\nimport sharp from \"sharp\"\r\n\r\nimport { analyzeImage } from \"@/lib/ai\"\r\nimport { normalizeTags } from \"@/lib/normalizeTags\"\r\nimport { detectCategoryVision } from \"@/lib/detectCategoryVision\"\r\nimport { extractAmenities } from \"@/lib/extractAmenities\"\r\n\r\n// ==================== VALIDACI√ìN ENV ====================\r\nif (!process.env.CLOUDINARY_CLOUD_NAME) throw new Error(\"‚ùå CLOUDINARY_CLOUD_NAME no est√° definido\")\r\nif (!process.env.CLOUDINARY_API_KEY) throw new Error(\"‚ùå CLOUDINARY_API_KEY no est√° definido\")\r\nif (!process.env.CLOUDINARY_API_SECRET) throw new Error(\"‚ùå CLOUDINARY_API_SECRET no est√° definido\")\r\n\r\ncloudinary.config({\r\n  cloud_name: process.env.CLOUDINARY_CLOUD_NAME,\r\n  api_key: process.env.CLOUDINARY_API_KEY,\r\n  api_secret: process.env.CLOUDINARY_API_SECRET,\r\n})\r\n\r\n// ==================== SUPABASE ====================\r\nconst supabase = createClient(\r\n  process.env.NEXT_PUBLIC_SUPABASE_URL!,\r\n  process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!\r\n)\r\n\r\n// ==================== CONFIGURACI√ìN ====================\r\nconst IMAGE_SIZES = {\r\n  thumbnail: { width: 256, height: 144 },\r\n  small: { width: 800, height: 450 },\r\n  medium: { width: 1920, height: 1080 },\r\n  large: { width: 2880, height: 1620 },\r\n}\r\n\r\n// ==================== ENDPOINT POST ====================\r\nexport async function POST(request: NextRequest) {\r\n  const requestId = crypto.randomUUID().slice(0, 8)\r\n  console.log(`üöÄ [${requestId}] POST /api/upload iniciado`)\r\n\r\n  try {\r\n    const formData = await request.formData()\r\n    const file = formData.get(\"file\") as File | null\r\n    const hotelId = formData.get(\"hotel_id\") as string | null\r\n\r\n    if (!file || !(file instanceof File)) {\r\n      return NextResponse.json({ error: \"Archivo inv√°lido\" }, { status: 400 })\r\n    }\r\n\r\n    if (!hotelId) {\r\n      return NextResponse.json({ error: \"Falta hotel_id\" }, { status: 400 })\r\n    }\r\n\r\n    if (file.size > 5 * 1024 * 1024) {\r\n      return NextResponse.json({ error: \"Archivo demasiado grande (m√°x. 5MB)\" }, { status: 400 })\r\n    }\r\n\r\n    // ==================== BUFFER ====================\r\n    const arrayBuffer = await file.arrayBuffer()\r\n    const buffer = Buffer.from(arrayBuffer)\r\n\r\n    // ==================== HASH ====================\r\n    const hash = crypto.createHash(\"sha256\").update(buffer).digest(\"hex\")\r\n\r\n    // ==================== CHECK DUPLICADO ====================\r\n    const { data: existing } = await supabase\r\n      .from(\"image_hashes\")\r\n      .select(\"url\")\r\n      .eq(\"hash\", hash)\r\n      .single()\r\n\r\n    if (existing) {\r\n      console.log(`‚úÖ [${requestId}] Imagen duplicada detectada`)\r\n      return NextResponse.json({\r\n        url: existing.url,\r\n        is_duplicate: true,\r\n        message: \"Esta imagen ya existe en tu galer√≠a\",\r\n      })\r\n    }\r\n\r\n    // ==================== UPLOAD CLOUDINARY ====================\r\n    console.log(`‚òÅÔ∏è [${requestId}] Subiendo a Cloudinary...`)\r\n    const uploadResult = await new Promise<any>((resolve, reject) => {\r\n      cloudinary.uploader\r\n        .upload_stream(\r\n          {\r\n            folder: \"hotel-media\",\r\n            resource_type: \"image\",\r\n            quality_analysis: true,\r\n          },\r\n          (error, result) => {\r\n            if (error) reject(error)\r\n            else resolve(result)\r\n          }\r\n        )\r\n        .end(buffer)\r\n    })\r\n    console.log(`‚úÖ [${requestId}] Cloudinary OK: ${uploadResult.secure_url.substring(0, 60)}...`)\r\n\r\n    // ==================== ü§ñ PASO 1: IA ANALYSIS (BACKEND ENSEMBLE) ====================\r\n    console.log(`ü§ñ [${requestId}] Paso 1: Analizando con backend ensemble...`)\r\n    \r\n    let backendResult: Awaited<ReturnType<typeof analyzeImage>>\r\n    \r\n    try {\r\n      backendResult = await analyzeImage(uploadResult.secure_url, 0.20)\r\n      \r\n      console.log(`‚úÖ [${requestId}] Backend result:`, {\r\n        categoria: backendResult.categoria,\r\n        ubicacion: backendResult.ubicacion,\r\n        tags: backendResult.tags,\r\n        titulo: backendResult.titulo_sugerido?.substring(0, 60),\r\n        confidence: backendResult.confidence,\r\n        tagsCount: backendResult.tags?.length || 0\r\n      })\r\n      \r\n    } catch (error: any) {\r\n      console.error(`‚ùå [${requestId}] Error en analyzeImage: ${error.message}`)\r\n      \r\n      // Fallback m√≠nimo\r\n      backendResult = {\r\n        tags: [\"hotel\"],\r\n        objects: [],\r\n        caption: \"\",\r\n        categoria: \"otros\",\r\n        ubicacion: \"interior\",\r\n        titulo_sugerido: \"\",\r\n        tags_confidence: {},\r\n        confidence: 0.3,\r\n        processing_time_ms: -1,\r\n        model_version: \"fallback\"\r\n      }\r\n    }\r\n\r\n    // ==================== üßº PASO 2: NORMALIZAR TAGS ====================\r\n    console.log(`üßº [${requestId}] Paso 2: Normalizando tags...`)\r\n    \r\n    const tagsWithScores = backendResult.tags.map(tag => ({\r\n      label: tag,\r\n      score: backendResult.tags_confidence?.[tag] || 0.5\r\n    }))\r\n    \r\n    const normalizedTags = normalizeTags(tagsWithScores, {\r\n      tags_confidence: backendResult.tags_confidence,\r\n      categoria_context: backendResult.categoria,\r\n      ubicacion_context: backendResult.ubicacion,\r\n      min_confidence: 0.2,\r\n      prefer_backend_scores: true\r\n    })\r\n    \r\n    console.log(`‚úÖ [${requestId}] Tags normalizados: ${JSON.stringify(normalizedTags)}`)\r\n\r\n    // ==================== üè∑Ô∏è PASO 3: DETECTAR CATEGOR√çA ====================\r\n    console.log(`üè∑Ô∏è [${requestId}] Paso 3: Detectando categor√≠a...`)\r\n    \r\n    const categoryDetection = detectCategoryVision(normalizedTags, {\r\n      backendCategoria: backendResult.categoria,\r\n      backendUbicacion: backendResult.ubicacion,\r\n      tagsConfidence: backendResult.tags_confidence,\r\n      minBackendConfidence: 0.4\r\n    })\r\n    \r\n    const category = categoryDetection.primary\r\n    console.log(`‚úÖ [${requestId}] Categor√≠a: ${category} (source: ${categoryDetection.source})`)\r\n\r\n    // ==================== üè® PASO 4: EXTRAER AMENITIES ====================\r\n    console.log(`üè® [${requestId}] Paso 4: Extrayendo amenities...`)\r\n    const amenitiesResult = extractAmenities(normalizedTags)\r\n    \r\n    // ‚úÖ CORREGIDO: extractAmenities devuelve un OBJETO, extraer array correctamente\r\n    const amenitiesArray = extractAmenityTags(amenitiesResult)\r\n    console.log(`‚úÖ [${requestId}] Amenities extra√≠dos: ${JSON.stringify(amenitiesArray)}`)\r\n\r\n    // ==================== üåç PASO 5: ANALIZAR ESCENA ====================\r\n    console.log(`üåç [${requestId}] Paso 5: Analizando escena...`)\r\n    const sceneAnalysis = {\r\n      scene: categoryDetection.secondary?.[0] || \"ambiguous\",\r\n      confidence: categoryDetection.confidence\r\n    }\r\n    console.log(`‚úÖ [${requestId}] Escena: ${sceneAnalysis.scene}`)\r\n\r\n    // ==================== ‚ú® PASO 6: FILTRAR TAGS POR CATEGOR√çA ====================\r\n    console.log(`‚ú® [${requestId}] Paso 6: Filtrando tags por categor√≠a...`)\r\n    const filteredTags = normalizedTags.filter(tag => {\r\n      const categoryTags: Record<string, string[]> = {\r\n        piscina: [\"pool\", \"piscina\", \"water\", \"sunbed\", \"umbrella\", \"exterior\"],\r\n        habitacion: [\"room\", \"bed\", \"suite\", \"balcony\", \"interior\"],\r\n        restaurante: [\"restaurant\", \"dining\", \"table\", \"buffet\"],\r\n        exterior: [\"exterior\", \"facade\", \"building\", \"sky\", \"garden\"],\r\n      }\r\n      const validTags = categoryTags[category] || []\r\n      return validTags.length === 0 || validTags.some(t => tag.includes(t))\r\n    })\r\n    console.log(`‚úÖ [${requestId}] Tags filtrados: ${JSON.stringify(filteredTags)}`)\r\n\r\n    // ==================== üñºÔ∏è PASO 7: EVALUAR CALIDAD ====================\r\n    console.log(`üñºÔ∏è [${requestId}] Paso 7: Evaluando calidad...`)\r\n    const qualityScore = uploadResult.quality_analysis?.overall_score || 70\r\n    console.log(`‚úÖ [${requestId}] Calidad: ${qualityScore}`)\r\n\r\n    // ==================== ‚úçÔ∏è PASO 8: GENERAR T√çTULO ====================\r\n    console.log(`‚úçÔ∏è [${requestId}] Paso 8: Generando t√≠tulo...`)\r\n    \r\n    let finalTitle: string\r\n    \r\n    if (backendResult.titulo_sugerido && backendResult.titulo_sugerido.length > 15) {\r\n      finalTitle = backendResult.titulo_sugerido\r\n      console.log(`‚úÖ [${requestId}] Usando t√≠tulo del backend: \"${finalTitle}\"`)\r\n    } else {\r\n      console.log(`üîß [${requestId}] Backend no dio t√≠tulo v√°lido, generando fallback...`)\r\n      \r\n      const titleParts: string[] = []\r\n      \r\n      const categoryLabels: Record<string, string> = {\r\n        piscina: \"Piscina\",\r\n        habitacion: \"Habitaci√≥n\",\r\n        restaurante: \"Restaurante\",\r\n        bar: \"Bar\",\r\n        spa: \"Spa\",\r\n        lobby: \"Lobby\",\r\n        exterior: \"Vista exterior\",\r\n        playa: \"Playa\",\r\n        gimnasio: \"Gimnasio\"\r\n      }\r\n      if (categoryLabels[category]) {\r\n        titleParts.push(categoryLabels[category])\r\n      }\r\n      \r\n      if (normalizedTags.some(t => /vista|view|mar|sea/.test(t))) {\r\n        titleParts.push(\"con vistas\")\r\n      }\r\n      if (normalizedTags.some(t => /lujo|luxury|premium/.test(t))) {\r\n        titleParts.push(\"de lujo\")\r\n      }\r\n      \r\n      finalTitle = titleParts.length > 0 \r\n        ? titleParts.join(\" \") \r\n        : \"Espacio del hotel\"\r\n      \r\n      console.log(`‚úÖ [${requestId}] T√≠tulo fallback: \"${finalTitle}\"`)\r\n    }\r\n\r\n    // ==================== üîç PASO 9: FUSIONAR TAGS FINALES ====================\r\n    console.log(`üîç [${requestId}] Paso 9: Fusionando tags...`)\r\n    \r\n    const finalTags = [...new Set([...filteredTags, ...amenitiesArray])]\r\n      .filter(t => t && typeof t === 'string' && t.length >= 2)\r\n      .slice(0, 15)\r\n    \r\n    console.log(`‚úÖ [${requestId}] Tags finales: ${JSON.stringify(finalTags)}`)\r\n\r\n    // ==================== üíæ GUARDAR EN SUPABASE ====================\r\n    console.log(`üíæ [${requestId}] Guardando en Supabase...`)\r\n    \r\n    // ==================== UPLOAD VERSIONES ====================\r\n    const versions: Record<string, any> = {}\r\n    \r\n    for (const [sizeName, sizeConfig] of Object.entries(IMAGE_SIZES)) {\r\n      const processedBuffer = await sharp(buffer)\r\n        .resize(sizeConfig.width, sizeConfig.height, {\r\n          fit: \"inside\",\r\n          withoutEnlargement: true,\r\n        })\r\n        .jpeg({ quality: sizeName === \"thumbnail\" ? 70 : 85 })\r\n        .toBuffer()\r\n\r\n      const versionUpload = await new Promise<any>((resolve, reject) => {\r\n        cloudinary.uploader\r\n          .upload_stream(\r\n            {\r\n              folder: \"hotel-media/versions\",\r\n              resource_type: \"image\",\r\n              public_id: `${sizeName}-${hash.substring(0, 16)}`,\r\n            },\r\n            (error, result) => {\r\n              if (error) reject(error)\r\n              else resolve(result)\r\n            }\r\n          )\r\n          .end(processedBuffer)\r\n      })\r\n\r\n      versions[sizeName] = {\r\n        url: versionUpload.secure_url,\r\n      }\r\n    }\r\n\r\n    // ==================== INSERTAR MEDIA - ‚úÖ SIN ai_metadata ====================\r\n    const { data: photoData, error: insertError } = await supabase\r\n      .from(\"media\")\r\n      .insert([\r\n        {\r\n          hotel_id: hotelId,\r\n          url: uploadResult.secure_url,\r\n          tags: finalTags,\r\n          confidence_scores: backendResult.tags_confidence || {},\r\n          category: category,\r\n          amenities: amenitiesResult,\r\n          versions: versions,\r\n          hash: hash,\r\n          ai_title: finalTitle,\r\n          // ‚úÖ ELIMINADO: ai_metadata (no existe en tu schema)\r\n        },\r\n      ])\r\n      .select()\r\n\r\n    if (insertError) {\r\n      console.error(`‚ùå [${requestId}] Error insertando en media:`, insertError)\r\n      return NextResponse.json({ error: \"Error guardando media\" }, { status: 500 })\r\n    }\r\n\r\n    if (!photoData || photoData.length === 0) {\r\n      console.error(`‚ùå [${requestId}] Supabase no devolvi√≥ filas despu√©s del insert`)\r\n      return NextResponse.json(\r\n        { error: \"No se pudo obtener la imagen insertada\" },\r\n        { status: 500 }\r\n      )\r\n    }\r\n\r\n    console.log(`‚úÖ [${requestId}] Guardado | T√≠tulo: \"${finalTitle}\"`)\r\n\r\n    // ==================== RESPUESTA FINAL ====================\r\n    console.log(`‚úÖ [${requestId}] Completado exitosamente`)\r\n    \r\n    return NextResponse.json({\r\n      url: uploadResult.secure_url,\r\n      tags: finalTags,\r\n      category: category,\r\n      amenities: amenitiesArray,\r\n      photo_id: photoData[0].id,\r\n      versions: versions,\r\n      ai_title: finalTitle,\r\n      ai_metadata: {\r\n        categoria: backendResult.categoria,\r\n        ubicacion: backendResult.ubicacion,\r\n        confidence: backendResult.confidence\r\n      }\r\n    })\r\n\r\n  } catch (error: any) {\r\n    console.error(`‚ùå [${requestId}] Error fatal en upload:`, {\r\n      message: error.message,\r\n      stack: error.stack?.split(\"\\n\").slice(0, 3).join(\"\\n\")\r\n    })\r\n    \r\n    return NextResponse.json(\r\n      { error: \"Error interno del servidor\" },\r\n      { status: 500 }\r\n    )\r\n  }\r\n}\r\n\r\n// ============================================================\r\n// üîß FUNCI√ìN AUXILIAR: Extraer tags de amenities\r\n// ============================================================\r\n\r\nfunction extractAmenityTags(amenities: any): string[] {\r\n  if (!amenities) return []\r\n  \r\n  if (Array.isArray(amenities) && amenities.every((a: any) => typeof a === 'string')) {\r\n    return amenities\r\n  }\r\n  \r\n  if (Array.isArray(amenities) && amenities[0] && typeof amenities[0] === 'object') {\r\n    return amenities\r\n      .map((a: any) => a.id || a.name)\r\n      .filter((t: any) => t && typeof t === 'string')\r\n  }\r\n  \r\n  if (typeof amenities === 'object' && Array.isArray(amenities.flat)) {\r\n    return amenities.flat\r\n  }\r\n  \r\n  if (typeof amenities === 'object' && Array.isArray(amenities.amenities)) {\r\n    return amenities.amenities\r\n      .map((a: any) => a.id || a.name)\r\n      .filter((t: any) => t && typeof t === 'string')\r\n  }\r\n  \r\n  if (typeof amenities === 'object' && amenities.byCategory) {\r\n    const allAmenities: string[] = []\r\n    for (const category of Object.values(amenities.byCategory)) {\r\n      if (Array.isArray(category)) {\r\n        allAmenities.push(...category.map((a: any) => a.id || a.name).filter((t: any) => t))\r\n      }\r\n    }\r\n    return allAmenities\r\n  }\r\n  \r\n  return []\r\n}"],"names":[],"mappings":";;;;AAAA,8BAA8B;AAE9B;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;;;;;;;;;;;AAEA,2DAA2D;AAC3D,IAAI,CAAC,QAAQ,GAAG,CAAC,qBAAqB,EAAE,MAAM,IAAI,MAAM;AACxD,IAAI,CAAC,QAAQ,GAAG,CAAC,kBAAkB,EAAE,MAAM,IAAI,MAAM;AACrD,IAAI,CAAC,QAAQ,GAAG,CAAC,qBAAqB,EAAE,MAAM,IAAI,MAAM;AAExD,gJAAU,CAAC,MAAM,CAAC;IAChB,YAAY,QAAQ,GAAG,CAAC,qBAAqB;IAC7C,SAAS,QAAQ,GAAG,CAAC,kBAAkB;IACvC,YAAY,QAAQ,GAAG,CAAC,qBAAqB;AAC/C;AAEA,qDAAqD;AACrD,MAAM,WAAW,IAAA,gMAAY;AAK7B,0DAA0D;AAC1D,MAAM,cAAc;IAClB,WAAW;QAAE,OAAO;QAAK,QAAQ;IAAI;IACrC,OAAO;QAAE,OAAO;QAAK,QAAQ;IAAI;IACjC,QAAQ;QAAE,OAAO;QAAM,QAAQ;IAAK;IACpC,OAAO;QAAE,OAAO;QAAM,QAAQ;IAAK;AACrC;AAGO,eAAe,KAAK,OAAoB;IAC7C,MAAM,YAAY,gHAAM,CAAC,UAAU,GAAG,KAAK,CAAC,GAAG;IAC/C,QAAQ,GAAG,CAAC,CAAC,IAAI,EAAE,UAAU,2BAA2B,CAAC;IAEzD,IAAI;QACF,MAAM,WAAW,MAAM,QAAQ,QAAQ;QACvC,MAAM,OAAO,SAAS,GAAG,CAAC;QAC1B,MAAM,UAAU,SAAS,GAAG,CAAC;QAE7B,IAAI,CAAC,QAAQ,CAAC,CAAC,gBAAgB,IAAI,GAAG;YACpC,OAAO,gJAAY,CAAC,IAAI,CAAC;gBAAE,OAAO;YAAmB,GAAG;gBAAE,QAAQ;YAAI;QACxE;QAEA,IAAI,CAAC,SAAS;YACZ,OAAO,gJAAY,CAAC,IAAI,CAAC;gBAAE,OAAO;YAAiB,GAAG;gBAAE,QAAQ;YAAI;QACtE;QAEA,IAAI,KAAK,IAAI,GAAG,IAAI,OAAO,MAAM;YAC/B,OAAO,gJAAY,CAAC,IAAI,CAAC;gBAAE,OAAO;YAAsC,GAAG;gBAAE,QAAQ;YAAI;QAC3F;QAEA,mDAAmD;QACnD,MAAM,cAAc,MAAM,KAAK,WAAW;QAC1C,MAAM,SAAS,+GAAM,CAAC,IAAI,CAAC;QAE3B,iDAAiD;QACjD,MAAM,OAAO,gHAAM,CAAC,UAAU,CAAC,UAAU,MAAM,CAAC,QAAQ,MAAM,CAAC;QAE/D,4DAA4D;QAC5D,MAAM,EAAE,MAAM,QAAQ,EAAE,GAAG,MAAM,SAC9B,IAAI,CAAC,gBACL,MAAM,CAAC,OACP,EAAE,CAAC,QAAQ,MACX,MAAM;QAET,IAAI,UAAU;YACZ,QAAQ,GAAG,CAAC,CAAC,GAAG,EAAE,UAAU,4BAA4B,CAAC;YACzD,OAAO,gJAAY,CAAC,IAAI,CAAC;gBACvB,KAAK,SAAS,GAAG;gBACjB,cAAc;gBACd,SAAS;YACX;QACF;QAEA,8DAA8D;QAC9D,QAAQ,GAAG,CAAC,CAAC,IAAI,EAAE,UAAU,0BAA0B,CAAC;QACxD,MAAM,eAAe,MAAM,IAAI,QAAa,CAAC,SAAS;YACpD,gJAAU,CAAC,QAAQ,CAChB,aAAa,CACZ;gBACE,QAAQ;gBACR,eAAe;gBACf,kBAAkB;YACpB,GACA,CAAC,OAAO;gBACN,IAAI,OAAO,OAAO;qBACb,QAAQ;YACf,GAED,GAAG,CAAC;QACT;QACA,QAAQ,GAAG,CAAC,CAAC,GAAG,EAAE,UAAU,iBAAiB,EAAE,aAAa,UAAU,CAAC,SAAS,CAAC,GAAG,IAAI,GAAG,CAAC;QAE5F,sFAAsF;QACtF,QAAQ,GAAG,CAAC,CAAC,IAAI,EAAE,UAAU,4CAA4C,CAAC;QAE1E,IAAI;QAEJ,IAAI;YACF,gBAAgB,MAAM,IAAA,kIAAY,EAAC,aAAa,UAAU,EAAE;YAE5D,QAAQ,GAAG,CAAC,CAAC,GAAG,EAAE,UAAU,iBAAiB,CAAC,EAAE;gBAC9C,WAAW,cAAc,SAAS;gBAClC,WAAW,cAAc,SAAS;gBAClC,MAAM,cAAc,IAAI;gBACxB,QAAQ,cAAc,eAAe,EAAE,UAAU,GAAG;gBACpD,YAAY,cAAc,UAAU;gBACpC,WAAW,cAAc,IAAI,EAAE,UAAU;YAC3C;QAEF,EAAE,OAAO,OAAY;YACnB,QAAQ,KAAK,CAAC,CAAC,GAAG,EAAE,UAAU,yBAAyB,EAAE,MAAM,OAAO,EAAE;YAExE,kBAAkB;YAClB,gBAAgB;gBACd,MAAM;oBAAC;iBAAQ;gBACf,SAAS,EAAE;gBACX,SAAS;gBACT,WAAW;gBACX,WAAW;gBACX,iBAAiB;gBACjB,iBAAiB,CAAC;gBAClB,YAAY;gBACZ,oBAAoB,CAAC;gBACrB,eAAe;YACjB;QACF;QAEA,uEAAuE;QACvE,QAAQ,GAAG,CAAC,CAAC,IAAI,EAAE,UAAU,8BAA8B,CAAC;QAE5D,MAAM,iBAAiB,cAAc,IAAI,CAAC,GAAG,CAAC,CAAA,MAAO,CAAC;gBACpD,OAAO;gBACP,OAAO,cAAc,eAAe,EAAE,CAAC,IAAI,IAAI;YACjD,CAAC;QAED,MAAM,iBAAiB,IAAA,8IAAa,EAAC,gBAAgB;YACnD,iBAAiB,cAAc,eAAe;YAC9C,mBAAmB,cAAc,SAAS;YAC1C,mBAAmB,cAAc,SAAS;YAC1C,gBAAgB;YAChB,uBAAuB;QACzB;QAEA,QAAQ,GAAG,CAAC,CAAC,GAAG,EAAE,UAAU,qBAAqB,EAAE,KAAK,SAAS,CAAC,iBAAiB;QAEnF,2EAA2E;QAC3E,QAAQ,GAAG,CAAC,CAAC,KAAK,EAAE,UAAU,iCAAiC,CAAC;QAEhE,MAAM,oBAAoB,IAAA,4JAAoB,EAAC,gBAAgB;YAC7D,kBAAkB,cAAc,SAAS;YACzC,kBAAkB,cAAc,SAAS;YACzC,gBAAgB,cAAc,eAAe;YAC7C,sBAAsB;QACxB;QAEA,MAAM,WAAW,kBAAkB,OAAO;QAC1C,QAAQ,GAAG,CAAC,CAAC,GAAG,EAAE,UAAU,aAAa,EAAE,SAAS,UAAU,EAAE,kBAAkB,MAAM,CAAC,CAAC,CAAC;QAE3F,yEAAyE;QACzE,QAAQ,GAAG,CAAC,CAAC,IAAI,EAAE,UAAU,iCAAiC,CAAC;QAC/D,MAAM,kBAAkB,IAAA,oJAAgB,EAAC;QAEzC,gFAAgF;QAChF,MAAM,iBAAiB,mBAAmB;QAC1C,QAAQ,GAAG,CAAC,CAAC,GAAG,EAAE,UAAU,uBAAuB,EAAE,KAAK,SAAS,CAAC,iBAAiB;QAErF,uEAAuE;QACvE,QAAQ,GAAG,CAAC,CAAC,IAAI,EAAE,UAAU,8BAA8B,CAAC;QAC5D,MAAM,gBAAgB;YACpB,OAAO,kBAAkB,SAAS,EAAE,CAAC,EAAE,IAAI;YAC3C,YAAY,kBAAkB,UAAU;QAC1C;QACA,QAAQ,GAAG,CAAC,CAAC,GAAG,EAAE,UAAU,UAAU,EAAE,cAAc,KAAK,EAAE;QAE7D,iFAAiF;QACjF,QAAQ,GAAG,CAAC,CAAC,GAAG,EAAE,UAAU,yCAAyC,CAAC;QACtE,MAAM,eAAe,eAAe,MAAM,CAAC,CAAA;YACzC,MAAM,eAAyC;gBAC7C,SAAS;oBAAC;oBAAQ;oBAAW;oBAAS;oBAAU;oBAAY;iBAAW;gBACvE,YAAY;oBAAC;oBAAQ;oBAAO;oBAAS;oBAAW;iBAAW;gBAC3D,aAAa;oBAAC;oBAAc;oBAAU;oBAAS;iBAAS;gBACxD,UAAU;oBAAC;oBAAY;oBAAU;oBAAY;oBAAO;iBAAS;YAC/D;YACA,MAAM,YAAY,YAAY,CAAC,SAAS,IAAI,EAAE;YAC9C,OAAO,UAAU,MAAM,KAAK,KAAK,UAAU,IAAI,CAAC,CAAA,IAAK,IAAI,QAAQ,CAAC;QACpE;QACA,QAAQ,GAAG,CAAC,CAAC,GAAG,EAAE,UAAU,kBAAkB,EAAE,KAAK,SAAS,CAAC,eAAe;QAE9E,wEAAwE;QACxE,QAAQ,GAAG,CAAC,CAAC,KAAK,EAAE,UAAU,8BAA8B,CAAC;QAC7D,MAAM,eAAe,aAAa,gBAAgB,EAAE,iBAAiB;QACrE,QAAQ,GAAG,CAAC,CAAC,GAAG,EAAE,UAAU,WAAW,EAAE,cAAc;QAEvD,sEAAsE;QACtE,QAAQ,GAAG,CAAC,CAAC,IAAI,EAAE,UAAU,6BAA6B,CAAC;QAE3D,IAAI;QAEJ,IAAI,cAAc,eAAe,IAAI,cAAc,eAAe,CAAC,MAAM,GAAG,IAAI;YAC9E,aAAa,cAAc,eAAe;YAC1C,QAAQ,GAAG,CAAC,CAAC,GAAG,EAAE,UAAU,8BAA8B,EAAE,WAAW,CAAC,CAAC;QAC3E,OAAO;YACL,QAAQ,GAAG,CAAC,CAAC,IAAI,EAAE,UAAU,qDAAqD,CAAC;YAEnF,MAAM,aAAuB,EAAE;YAE/B,MAAM,iBAAyC;gBAC7C,SAAS;gBACT,YAAY;gBACZ,aAAa;gBACb,KAAK;gBACL,KAAK;gBACL,OAAO;gBACP,UAAU;gBACV,OAAO;gBACP,UAAU;YACZ;YACA,IAAI,cAAc,CAAC,SAAS,EAAE;gBAC5B,WAAW,IAAI,CAAC,cAAc,CAAC,SAAS;YAC1C;YAEA,IAAI,eAAe,IAAI,CAAC,CAAA,IAAK,qBAAqB,IAAI,CAAC,KAAK;gBAC1D,WAAW,IAAI,CAAC;YAClB;YACA,IAAI,eAAe,IAAI,CAAC,CAAA,IAAK,sBAAsB,IAAI,CAAC,KAAK;gBAC3D,WAAW,IAAI,CAAC;YAClB;YAEA,aAAa,WAAW,MAAM,GAAG,IAC7B,WAAW,IAAI,CAAC,OAChB;YAEJ,QAAQ,GAAG,CAAC,CAAC,GAAG,EAAE,UAAU,oBAAoB,EAAE,WAAW,CAAC,CAAC;QACjE;QAEA,6EAA6E;QAC7E,QAAQ,GAAG,CAAC,CAAC,IAAI,EAAE,UAAU,4BAA4B,CAAC;QAE1D,MAAM,YAAY;eAAI,IAAI,IAAI;mBAAI;mBAAiB;aAAe;SAAE,CACjE,MAAM,CAAC,CAAA,IAAK,KAAK,OAAO,MAAM,YAAY,EAAE,MAAM,IAAI,GACtD,KAAK,CAAC,GAAG;QAEZ,QAAQ,GAAG,CAAC,CAAC,GAAG,EAAE,UAAU,gBAAgB,EAAE,KAAK,SAAS,CAAC,YAAY;QAEzE,mEAAmE;QACnE,QAAQ,GAAG,CAAC,CAAC,IAAI,EAAE,UAAU,0BAA0B,CAAC;QAExD,6DAA6D;QAC7D,MAAM,WAAgC,CAAC;QAEvC,KAAK,MAAM,CAAC,UAAU,WAAW,IAAI,OAAO,OAAO,CAAC,aAAc;YAChE,MAAM,kBAAkB,MAAM,IAAA,0JAAK,EAAC,QACjC,MAAM,CAAC,WAAW,KAAK,EAAE,WAAW,MAAM,EAAE;gBAC3C,KAAK;gBACL,oBAAoB;YACtB,GACC,IAAI,CAAC;gBAAE,SAAS,aAAa,cAAc,KAAK;YAAG,GACnD,QAAQ;YAEX,MAAM,gBAAgB,MAAM,IAAI,QAAa,CAAC,SAAS;gBACrD,gJAAU,CAAC,QAAQ,CAChB,aAAa,CACZ;oBACE,QAAQ;oBACR,eAAe;oBACf,WAAW,GAAG,SAAS,CAAC,EAAE,KAAK,SAAS,CAAC,GAAG,KAAK;gBACnD,GACA,CAAC,OAAO;oBACN,IAAI,OAAO,OAAO;yBACb,QAAQ;gBACf,GAED,GAAG,CAAC;YACT;YAEA,QAAQ,CAAC,SAAS,GAAG;gBACnB,KAAK,cAAc,UAAU;YAC/B;QACF;QAEA,+EAA+E;QAC/E,MAAM,EAAE,MAAM,SAAS,EAAE,OAAO,WAAW,EAAE,GAAG,MAAM,SACnD,IAAI,CAAC,SACL,MAAM,CAAC;YACN;gBACE,UAAU;gBACV,KAAK,aAAa,UAAU;gBAC5B,MAAM;gBACN,mBAAmB,cAAc,eAAe,IAAI,CAAC;gBACrD,UAAU;gBACV,WAAW;gBACX,UAAU;gBACV,MAAM;gBACN,UAAU;YAEZ;SACD,EACA,MAAM;QAET,IAAI,aAAa;YACf,QAAQ,KAAK,CAAC,CAAC,GAAG,EAAE,UAAU,4BAA4B,CAAC,EAAE;YAC7D,OAAO,gJAAY,CAAC,IAAI,CAAC;gBAAE,OAAO;YAAwB,GAAG;gBAAE,QAAQ;YAAI;QAC7E;QAEA,IAAI,CAAC,aAAa,UAAU,MAAM,KAAK,GAAG;YACxC,QAAQ,KAAK,CAAC,CAAC,GAAG,EAAE,UAAU,+CAA+C,CAAC;YAC9E,OAAO,gJAAY,CAAC,IAAI,CACtB;gBAAE,OAAO;YAAyC,GAClD;gBAAE,QAAQ;YAAI;QAElB;QAEA,QAAQ,GAAG,CAAC,CAAC,GAAG,EAAE,UAAU,sBAAsB,EAAE,WAAW,CAAC,CAAC;QAEjE,4DAA4D;QAC5D,QAAQ,GAAG,CAAC,CAAC,GAAG,EAAE,UAAU,yBAAyB,CAAC;QAEtD,OAAO,gJAAY,CAAC,IAAI,CAAC;YACvB,KAAK,aAAa,UAAU;YAC5B,MAAM;YACN,UAAU;YACV,WAAW;YACX,UAAU,SAAS,CAAC,EAAE,CAAC,EAAE;YACzB,UAAU;YACV,UAAU;YACV,aAAa;gBACX,WAAW,cAAc,SAAS;gBAClC,WAAW,cAAc,SAAS;gBAClC,YAAY,cAAc,UAAU;YACtC;QACF;IAEF,EAAE,OAAO,OAAY;QACnB,QAAQ,KAAK,CAAC,CAAC,GAAG,EAAE,UAAU,wBAAwB,CAAC,EAAE;YACvD,SAAS,MAAM,OAAO;YACtB,OAAO,MAAM,KAAK,EAAE,MAAM,MAAM,MAAM,GAAG,GAAG,KAAK;QACnD;QAEA,OAAO,gJAAY,CAAC,IAAI,CACtB;YAAE,OAAO;QAA6B,GACtC;YAAE,QAAQ;QAAI;IAElB;AACF;AAEA,+DAA+D;AAC/D,iDAAiD;AACjD,+DAA+D;AAE/D,SAAS,mBAAmB,SAAc;IACxC,IAAI,CAAC,WAAW,OAAO,EAAE;IAEzB,IAAI,MAAM,OAAO,CAAC,cAAc,UAAU,KAAK,CAAC,CAAC,IAAW,OAAO,MAAM,WAAW;QAClF,OAAO;IACT;IAEA,IAAI,MAAM,OAAO,CAAC,cAAc,SAAS,CAAC,EAAE,IAAI,OAAO,SAAS,CAAC,EAAE,KAAK,UAAU;QAChF,OAAO,UACJ,GAAG,CAAC,CAAC,IAAW,EAAE,EAAE,IAAI,EAAE,IAAI,EAC9B,MAAM,CAAC,CAAC,IAAW,KAAK,OAAO,MAAM;IAC1C;IAEA,IAAI,OAAO,cAAc,YAAY,MAAM,OAAO,CAAC,UAAU,IAAI,GAAG;QAClE,OAAO,UAAU,IAAI;IACvB;IAEA,IAAI,OAAO,cAAc,YAAY,MAAM,OAAO,CAAC,UAAU,SAAS,GAAG;QACvE,OAAO,UAAU,SAAS,CACvB,GAAG,CAAC,CAAC,IAAW,EAAE,EAAE,IAAI,EAAE,IAAI,EAC9B,MAAM,CAAC,CAAC,IAAW,KAAK,OAAO,MAAM;IAC1C;IAEA,IAAI,OAAO,cAAc,YAAY,UAAU,UAAU,EAAE;QACzD,MAAM,eAAyB,EAAE;QACjC,KAAK,MAAM,YAAY,OAAO,MAAM,CAAC,UAAU,UAAU,EAAG;YAC1D,IAAI,MAAM,OAAO,CAAC,WAAW;gBAC3B,aAAa,IAAI,IAAI,SAAS,GAAG,CAAC,CAAC,IAAW,EAAE,EAAE,IAAI,EAAE,IAAI,EAAE,MAAM,CAAC,CAAC,IAAW;YACnF;QACF;QACA,OAAO;IACT;IAEA,OAAO,EAAE;AACX"}}]
}